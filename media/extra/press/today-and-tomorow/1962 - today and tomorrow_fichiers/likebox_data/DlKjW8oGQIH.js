/*1343888566,169776318*/

if (window.CavalryLogger) { CavalryLogger.start_js(["1zqwA"]); }

__d("AjaxRequest",["ErrorUtils","Keys","URI","UserAgent","XHR","copyProperties"],function(a,b,c,d,e,f){var g=b('ErrorUtils'),h=b('Keys'),i=b('URI'),j=b('UserAgent'),k=b('XHR'),l=b('copyProperties');function m(q,r,s){this.xhr=k.create();if(!(r instanceof i))r=new i(r);if(s&&q=='GET'){r.setQueryData(s);}else this._params=s;this.method=q;this.uri=r;this.xhr.open(q,r);}var n=window.XMLHttpRequest&&('withCredentials' in new XMLHttpRequest());m.supportsCORS=function(){return n;};m.ERROR='ar:error';m.TIMEOUT='ar:timeout';m.PROXY_ERROR='ar:proxy error';m.TRANSPORT_ERROR='ar:transport error';m.SERVER_ERROR='ar:http error';m.PARSE_ERROR='ar:parse error';m._inflight=[];function o(){var q=m._inflight;m._inflight=[];q.forEach(function(r){r.abort();});}function p(q){q.onJSON=q.onError=q.onSuccess=null;clearTimeout(q._timer);if(q.xhr&&q.xhr.readyState<4){q.xhr.abort();q.xhr=null;}m._inflight=m._inflight.filter(function(r){return r&&r!=q&&r.xhr&&r.xhr.readyState<4;});}l(m.prototype,{timeout:60000,prelude:/^for \(;;\);/,status:null,_eol:-1,_call:function(q){if(this[q])this[q](this);},_parseStatus:function(){var q;try{this.status=this.xhr.status;q=this.xhr.statusText;}catch(r){if(this.xhr.readyState>=4){this.errorType=m.TRANSPORT_ERROR;this.errorText=r.message;}return;}if(this.status===0&&!(/^(file|ftp)/.test(this.uri))){this.errorType=m.TRANSPORT_ERROR;}else if(this.status>=100&&this.status<200){this.errorType=m.PROXY_ERROR;}else if(this.status>=200&&this.status<300){return;}else if(this.status>=300&&this.status<400){this.errorType=m.PROXY_ERROR;}else if(this.status>=400&&this.status<500){this.errorType=m.SERVER_ERROR;}else if(this.status>=500&&this.status<600){this.errorType=m.PROXY_ERROR;}else if(this.status==1223){return;}else if(this.status>=12001&&this.status<=12156){this.errorType=m.TRANSPORT_ERROR;}else{q='unrecognized status code: '+this.status;this.errorType=m.ERROR;}if(!this.errorText)this.errorText=q;},_parseResponse:function(){var q,r=this.xhr.readyState;try{q=this.xhr.responseText||'';}catch(s){if(r>=4){this.errorType=m.ERROR;this.errorText='responseText not available - '+s.message;}return;}while(this.xhr){var t=this._eol+1,u=q.indexOf('\n',t);if(u<0&&r==4)u=q.length;if(u<=this._eol)break;var v=q.substr(t,u-t).replace(/^\s*|\s*$/g,'');if(t===0&&this.prelude)if(this.prelude.test(v))v=v.replace(this.prelude,'');this._eol=u;if(v){try{this.json=JSON.parse(v);}catch(s){var w=(/(<body[\S\s]+?<\/body>)/i).test(q)&&RegExp.$1,x={message:s.message,'char':t,excerpt:((t===0&&w)||v).substr(512)};this.errorType=m.PARSE_ERROR;this.errorText='parse error - '+JSON.stringify(x);return;}g.applyWithGuard(this._call,this,['onJSON']);}}},_onReadyState:function(){var q=this.xhr&&this.xhr.readyState||0;if(this.status==null&&q>=2)this._parseStatus();if(this.status!=null&&q>=3&&!this.errorType)this._parseResponse();if(this.errorType||q==4){this._time=Date.now()-this._sentAt;this._call(!this.errorType?'onSuccess':'onError');p(this);}},send:function(q){this.xhr.onreadystatechange=function(){g.applyWithGuard(this._onReadyState,this,arguments);}.bind(this);var r=this.timeout;if(r)this._timer=setTimeout((function(){this.errorType=m.TIMEOUT;this.errorText='timeout';this._time=Date.now()-this._sentAt;this._call('onError');p(this);}).bind(this),r,false);m._inflight.push(this);if(this.method=='POST')this.xhr.setRequestHeader('Content-Type','application/x-www-form-urlencoded');this._sentAt=Date.now();this.xhr.send(q?i.implodeQuery(q):'');},abort:function(){p(this);},toString:function(){var q='[AjaxRequest readyState='+this.xhr.readyState;if(this.errorType)q+=' errorType='+this.errorType+' ('+this.errorText+')';return q+']';},toJSON:function(){var q={json:this.json,status:this.status,errorType:this.errorType,errorText:this.errorText,time:this._time};for(var r in q)if(q[r]==null)delete q[r];return q;}});if(window.addEventListener&&j.firefox())window.addEventListener('keydown',function(event){if(event.keyCode===h.ESC)event.prevent();},false);if(window.attachEvent)window.attachEvent('onunload',o);e.exports=m;});
__d("ChatConfig",["copyProperties","ChatConfigInitialData"],function(a,b,c,d,e,f){var g=c('ChatConfigInitialData'),h=b('copyProperties'),i={},j={get:function(k,l){return k in i?i[k]:l;},set:function(k){if(arguments.length>1){var l={};l[k]=arguments[1];k=l;}h(i,k);},getDebugInfo:function(){return i;}};j.set(g);e.exports=j;});
__d("ChannelConstants",[],function(a,b,c,d,e,f){var g='channel/',h={ON_SHUTDOWN:g+'shutdown',ON_INVALID_HISTORY:g+'invalid_history',ON_CONFIG:g+'config',ON_ENTER_STATE:g+'enter_state',ON_EXIT_STATE:g+'exit_state',OK:'ok',ERROR:'error',ERROR_MAX:'error_max',ERROR_MISSING:'error_missing',ERROR_MSG_TYPE:'error_msg_type',ERROR_SHUTDOWN:'error_shutdown',ERROR_STALE:'error_stale',SYS_OWNER:'sys_owner',SYS_NONOWNER:'sys_nonowner',SYS_ONLINE:'sys_online',SYS_OFFLINE:'sys_offline',SYS_TIMETRAVEL:'sys_timetravel',HINT_AUTH:'shutdown auth',HINT_CONN:'shutdown conn',HINT_DISABLED:'shutdown disabled',HINT_INVALID_STATE:'shutdown invalid state',HINT_MAINT:'shutdown maint',HINT_UNSUPPORTED:'shutdown unsupported',reason_Unknown:0,reason_AsyncError:1,reason_TooLong:2,reason_Refresh:3,reason_RefreshDelay:4,reason_UIRestart:5,reason_NeedSeq:6,reason_PrevFailed:7,reason_IFrameLoadGiveUp:8,reason_IFrameLoadRetry:9,reason_IFrameLoadRetryWorked:10,reason_PageTransitionRetry:11,reason_IFrameLoadMaxSubdomain:12,reason_NoChannelInfo:13,reason_NoChannelHost:14,getArbiterType:function(i){return g+'message:'+i;}};e.exports=h;});
__d("ChannelSubdomain",["Cookie","JSLogger","UserAgent"],function(a,b,c,d,e,f){var g=b('Cookie'),h=b('JSLogger'),i=b('UserAgent'),j=h.create('channel'),k=7,l=null;function m(p){var q=null,r=n(),s,t=i.firefox()?Math.floor(Math.random()*32):0;for(var u=0;u<32;u++){s=(u+t)%32;if(!(r&(1<<s)))break;}p--;if(s<Math.min(32,k*p)){l=s;q=l%k;g.set('sub',r|(1<<l));}else{l=-1;q=null;j.error('subdomain_overflow',{slot:l,max:p});}return q;}function n(){var p=g.get('sub')||0;p=parseInt(p,10);return isNaN(p)?0:p;}function o(){if(l!==null&&l>=0){var p=n()&~(1<<l);if(p){g.set('sub',p);}else g.clear('sub');}}e.exports={allocate:m,clear:o};});
__d("ChannelTransport",["copyProperties","bind","AjaxRequest","URI","JSLogger","DocRPC","ChannelConstants"],function(a,b,c,d,e,f){var g=b('copyProperties'),h=b('bind'),i=b('AjaxRequest'),j=b('URI'),k=b('JSLogger'),l=b('DocRPC'),m=b('ChannelConstants'),n=k.create('channel');function o(){return (1048576*Math.random()|0).toString(36);}function p(x,y){var z=x.subdomain;z=z===null?'':(z+'-');var aa=new j(y).setDomain(z+x.host+'.facebook.com').setPort(x.port).setSecure(j().isSecure());return aa;}function q(x){var y={partition:x.partition,cb:o()},z=p(x,'/p').setQueryData(y);n.log('start_p',{uri:z.toString()});var aa=new i('GET',z);if(i.supportsCORS())aa.xhr.withCredentials=true;var ba=function(ca){n.log('finish_p',{xhr:ca.toJSON?ca.toJSON():ca});};aa.timeout=x.P_TIMEOUT;aa.onError=aa.onSuccess=ba;aa.send();}function r(x,y,z){var aa=new Image(),ba=0,ca=function(fa){aa.abort();return fa?y():z();};aa.onload=function(){n.log('ping_ok',{duration:Date.now()-ba});ca(true);};aa.onerror=function(){q(x);ca(false);};var da=setTimeout(aa.onerror,10000,false);aa.abort=function(){if(da){clearTimeout(da);da=null;}aa.onload=aa.onerror=null;};var ea={partition:x.partition,cb:o()};ba=Date.now();aa.src=p(x,'/ping').setQueryData(ea);return aa;}function s(x,y,z,aa){var ba=new Date(),ca=(ba-x.userActive)/1000|0;if(ca<0)n.warn('idle_regression',{idleTime:ca,now:ba.getTime(),userActive:x.userActive});var da={channel:x.user_channel,seq:x.seq,partition:x.partition,clientid:x.sessionID,cb:o(),idle:ca};if(ca<60)da.state='active';if(x.streamingCapable){da.mode='stream';da.format='json';}var ea=p(x,'/pull').setQueryData(da),fa=new i('GET',ea);if(i.supportsCORS())fa.xhr.withCredentials=true;fa.timeout=x.streamingCapable?x.STREAMING_TIMEOUT:x.LONGPOLL_TIMEOUT;fa.onJSON=y;fa.onSuccess=z;fa.onError=function(){var ga=(this.status==12002&&this._time>=x.MIN_12002_TIMEOUT)||(this.status==504&&this._time>=x.MIN_504_TIMEOUT),ha=ga?z:aa;return ha&&ha.apply(this,arguments);};fa.send();x.inStreaming=x.streamingCapable;return fa;}function t(x){this.manager=x;(this.init&&this.init());}function u(x){t.apply(this,arguments);}g(u.prototype,{logName:'CORS',enterState:function(x,y){if(this._request){this._request.abort();this._request=null;}if(x=='init')setTimeout(h(this.manager,'exitState',{status:m.OK,stateId:y.stateId}),3000,false);if(!/pull|ping/.test(x))return;var z=this.manager;if(x=='ping'){this._request=r(y,h(z,'exitState',{status:m.OK,stateId:y.stateId}),h(z,'exitState',{status:m.ERROR,stateId:y.stateId}));}else if(x=='pull')this._request=s(y,h(z,'_processTransportData',y.stateId),h(z,'exitState',{status:m.OK,stateId:y.stateId}),h(z,'exitState',{status:m.ERROR,stateId:y.stateId}));}});function v(x){n.log('iframe_init_constructor');t.apply(this,arguments);this._iframe=document.createElement('iframe');this._iframe.style.display='none';document.body.appendChild(this._iframe);l.publish(this,'outerTransport');}g(v.prototype,{logName:'iframe',_initIframe:function(x){n.log('iframe_init_start');window.onchanneliframeready=function(){n.log('iframe_resources');return x.resources;};window.onchanneliframeloaded=function(){n.log('iframe_loaded');};if(x){this._iframeURI=p(x,x.path);if(x.bustIframe){var y={partition:x.partition,cb:o()};this._iframeURI.setQueryData(y);}}else this._iframeURI='about:blank';this._iframeProxy=null;try{this._iframe.contentWindow.location.replace(this._iframeURI);n.log('iframe_uri_set');}catch(z){n.error('iframe_uri_set_error',z);this.exitState({status:m.ERROR,stateId:x.stateId},z+'');}},enterState:function(x,y){if(x=='init'){this._initIframe(y);}else if(/idle|ping|pull/.test(x)){if(this._iframeProxy){this._iframeProxy.enterState.apply(this._iframeProxy,arguments);}else if(x!='idle')this.exitState({status:m.ERROR,stateId:y.stateId},'iframe not yet loaded');}else if(x=='shutdown')this._initIframe();},_processTransportData:function(){this.manager._processTransportData.apply(this.manager,arguments);},exitState:function(x){if(this.manager.state=='init'&&x.status==m.OK)this._iframeProxy=l.proxy(this._iframe.contentWindow,'innerTransport',['enterState'],(this._iframeURI+'').replace(/iframe.*/,''));if(/ping|pull/.test(this.manager.state)&&!this._iframeProxy)return;this.manager.exitState.apply(this.manager,arguments);}});function w(){this.init=this.init.bind(this);t.apply(this,arguments);}g(w.prototype,{logName:'iframe(inner)',init:function(){l.publish(this,'innerTransport');try{var y=l.proxy(window.parent,'outerTransport',['_processTransportData','exitState'],top.DocRPC.origin);g(this,y);this.exitState({status:m.OK,stateId:1e+06});}catch(x){n.error('iframe_inner_init_error',x);}},enterState:function(x,y){if(this._request){this._request.abort();this._request=null;}if(x=='ping'){this._request=r(y,h(this,'exitState',{status:m.OK,stateId:y.stateId}),h(this,'exitState',{status:m.ERROR,stateId:y.stateId}));}else if(x=='pull')this._request=s(y,h(this,'_processTransportData',y.stateId),h(this,'exitState',{status:m.OK,stateId:y.stateId}),h(this,'exitState',{status:m.ERROR,stateId:y.stateId}));}});e.exports={getURI:p,Transport:t,CORSTransport:u,IframeTransport:v,IframeInnerTransport:w};});
__d("FBAjaxRequest",["$","AjaxRequest","copyProperties","XHR"],function(a,b,c,d,e,f){var g=b('$'),h=b('AjaxRequest'),i=b('copyProperties'),j=b('XHR');function k(l,m,n){n=i(j.getAsyncParams(l),n);var o=new h(l,m,n),p=o._call;o._call=function(q){if(q=='onJSON'&&this.json){if(this.json.error){this.errorType=h.SERVER_ERROR;this.errorText='AsyncResponse error: '+this.json.error;}this.json=this.json.payload;}p.apply(this,arguments);};return o;}e.exports=k;});
__d("MovingStat",[],function(a,b,c,d,e,f){function g(h){h=h||60000;var i={t:new Date(),count:0,v:0},j=i,k=0,l=0;function m(){var n=new Date()-h;while(j&&j.next&&j.t<n){k-=j.v;l-=j.count;j=j.next;}}this.add=function(n){k+=n;l++;var o=new Date();if(o-i.t<1000){i.v+=n;i.count++;}else{i.next={t:o,v:n,count:1};i=i.next;m();}};this.tally=function(n){n=n||1000;m();return {sum:k,count:l,timeAverage:k*n/h};};}e.exports=g;});
__d("PresenceUtil",["Cookie","Env","randomInt","tx"],function(a,b,c,d,e,f){var g=b('Cookie'),h=b('Env'),i=b('randomInt'),j=b('tx'),k=i(0,4294967295)+1;a.PresenceUtil=e.exports={checkMaintenanceError:function(l){if(l.getError()==1356007)return true;return false;},getErrorDescription:function(l){var m=l.getError(),n=l.getErrorDescription();if(!n)n="Une erreur s\u2019est produite.";if(m==1357001)n="Votre session a expir\u00e9. Veuillez vous reconnecter.";return n;},getSessionID:function(){return k;},hasUserCookie:function(){return h.user===g.get('c_user');}};},3);
__d("PresenceCookieManager",["Cookie","Dcode","ErrorUtils","Env","JSLogger","PresenceUtil","URI","PresenceInitialData"],function(a,b,c,d,e,f){var g=b('Cookie'),h=b('Dcode'),i=b('ErrorUtils'),j=b('Env'),k=b('JSLogger'),l=b('PresenceUtil'),m=b('URI'),n=c('PresenceInitialData'),o=n.cookieVersion,p=n.dictEncode,q='presence',r={},s=null,t=null,u=k.create('presence_cookie');function v(){try{var z=g.get(q);if(s!==z){s=z;t=null;if(z&&z.charAt(0)=='E')z=h.decode(z.substring(1));if(z)t=JSON.parse(z);}if(t&&(!t.user||t.user===j.user))return t;}catch(y){u.warn('getcookie_error');}return null;}function w(){return parseInt(new Date().getTime()/1000,10);}var x={register:function(y,z){r[y]=z;},store:function(){var y=v();if(y&&y.v&&o<y.v)return;var z={v:o,time:w(),user:j.user};for(var aa in r)z[aa]=i.applyWithGuard(r[aa],r,[y&&y[aa]],function(ea){ea.presence_subcookie=aa;});var ba=JSON.stringify(z);if(p)ba='E'+h.encode(ba);if(l.hasUserCookie()){var ca=ba.length;if(ca>1024)u.warn('big_cookie',ca);var da=m.getRequestURI(false).isSecure()&&!!g.get('csm');g.set(q,ba,null,null,da);}},clear:function(){g.clear(q);},getSubCookie:function(y){var z=v();if(!z)return null;return z[y];}};e.exports=x;});
__d("PresenceState",["Arbiter","ErrorUtils","JSLogger","PresenceCookieManager","copyProperties","debounceAcrossTransitions","setIntervalAcrossTransitions","PresenceInitialData"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('ErrorUtils'),i=b('JSLogger'),j=b('PresenceCookieManager'),k=b('copyProperties'),l=b('debounceAcrossTransitions'),m=b('setIntervalAcrossTransitions'),n=c('PresenceInitialData'),o=n.cookiePollInterval||2000,p=[],q=[],r=null,s=null,t=0,u=null,v=0,w=['sb2','t2','lm2','uct2','tr','tw','at'],x=i.create('presence_state');function y(){return j.getSubCookie('state');}function z(){t=Date.now();j.store();da(s);}var aa=l(z,0);function ba(ha){if(typeof ha=='undefined'||isNaN(ha)||ha==Number.POSITIVE_INFINITY||ha==Number.NEGATIVE_INFINITY)ha=0;return ha;}function ca(ha){var ia={};if(ha){w.forEach(function(la){ia[la]=ha[la];});if(t<ha.ut)x.error('new_cookie',{cookie_time:ha.ut,local_time:t});}ia.ut=t;for(var ja=0,ka=p.length;ja<ka;ja++)h.applyWithGuard(p[ja],null,[ia]);s=ia;return s;}function da(ha){v++;t=ba(ha.ut);if(!r)r=m(ga,o);s=ha;if(u===null)u=ha;for(var ia=0,ja=q.length;ia<ja;ia++)h.applyWithGuard(q[ia],null,[ha]);v--;}function ea(ha){if(ha&&ha.ut)if(t<ha.ut){return true;}else if(ha.ut<t)x.error('old_cookie',{cookie_time:ha.ut,local_time:t});return false;}function fa(){var ha=y();if(ea(ha))s=ha;return s;}function ga(){var ha=y();if(ea(ha))da(ha);}j.register('state',ca);g.subscribe(i.DUMP_EVENT,function(ha,ia){ia.presence_state={initial:k({},u),state:k({},s),update_time:t,sync_paused:v,poll_time:o};});(function(){var ha=fa();if(ha){da(ha);}else{x.debug('no_cookie_initial');da(ca());return;}})();a.PresenceState=e.exports={doSync:function(ha){if(v)return;if(ha){z();}else aa();},registerStateStorer:function(ha){p.push(ha);},registerStateLoader:function(ha){q.push(ha);},get:function(){return fa();},getInitial:function(){return u;},verifyNumber:ba};},3);
__d("ChannelManager",["event-extensions","function-extensions","AjaxRequest","Arbiter","AsyncRequest","ChannelConstants","ChannelSubdomain","ChannelTransport","Cookie","Env","FBAjaxRequest","JSLogger","MovingStat","PresenceCookieManager","PresenceState","PresenceUtil","Run","SystemEvents","URI","UserActivity","UserAgent","copyProperties","createArrayFrom","hasArrayNature","ChannelInitialData"],function(a,b,c,d,e,f){b('event-extensions');b('function-extensions');var g=b('AjaxRequest'),h=b('Arbiter'),i=b('AsyncRequest'),j=b('ChannelConstants'),k=b('ChannelSubdomain'),l=b('ChannelTransport'),m=b('Cookie'),n=b('Env'),o=b('FBAjaxRequest'),p=b('JSLogger'),q=b('MovingStat'),r=b('PresenceCookieManager'),s=b('PresenceState'),t=b('PresenceUtil'),u=b('Run'),v=b('SystemEvents'),w=b('URI'),x=b('UserActivity'),y=b('UserAgent'),z=b('copyProperties'),aa=b('createArrayFrom'),ba=b('hasArrayNature'),ca=c('ChannelInitialData'),da,ea=p.create('channel'),fa=null;function ga(sa){fa=sa;}var ha={idle:{ok:'init!'},init:{ok:'pull!',error:'reconnect',sys_online:'init',sys_timetravel:'init'},pull:{ok:'pull!',error:'ping',error_missing:'pull',error_msg_type:'pull',refresh_0:'reconnect',refresh_110:'reconnect',refresh_111:'pull',refresh_112:'pull',refresh_113:'pull',refresh_117:'reconnect'},ping:{ok:'pull!',error:'ping',error_stale:'reconnect!'},reconnect:{ok:'init!',error:'reconnect',sys_online:'reconnect',sys_timetravel:'reconnect'},shutdown:{},_all:{error_max:'shutdown!',error_shutdown:'shutdown!',sys_owner:'reconnect',sys_nonowner:'idle!',sys_online:'ping',sys_offline:'idle!',sys_timetravel:'ping'}},ia={userActive:Date.now(),sessionID:(Math.random()*2147483648|0).toString(16),streamingCapable:false,inStreaming:false,LONGPOLL_TIMEOUT:60000,STREAMING_TIMEOUT:60000,P_TIMEOUT:30000,IFRAME_LOAD_TIMEOUT:30000,MIN_RETRY_INTERVAL:5000,MAX_RETRY_INTERVAL:30000,MIN_12002_TIMEOUT:9000,MIN_504_TIMEOUT:20000,STALL_THRESHOLD:180000,JUMPSTART_THRESHOLD:90000,MIN_INIT_PROBE_DELAY:3000,INIT_PROBE_DELAY_RANDOMIZE_RANGE:12000,PROBE_DELAY:60000,PROBE_HEARTBEATS_INTERVAL_LOW:1500,PROBE_HEARTBEATS_INTERVAL_HIGH:2500,STREAMING_EXIT_STATE_ON_CONTINUE:false},ja=1,ka={},la=0;function ma(sa){return sa.toLowerCase().replace(/[^0-9a-z]+/g,'_');}function na(){return i.lastSuccessTime?Math.round((Date.now()-i.lastSuccessTime)/1000):-1;}function oa(){var sa={};if(da.getConfig('host'))sa[da.getConfig('user_channel')]=da.getConfig('seq',0);return sa;}function pa(){var sa=Date.now(),ta=Date.now(),ua={total:0},va='idle',wa=false;v.subscribe([v.USER,v.ONLINE,v.TIME_TRAVEL],function(za,ab){ra(true);ta=null;da.lastPullTime=Date.now();var bb;switch(za){case v.USER:bb=v.isPageOwner()?j.SYS_OWNER:j.SYS_NONOWNER;break;case v.ONLINE:bb=ab?j.SYS_ONLINE:j.SYS_OFFLINE;break;case v.TIME_TRAVEL:bb=j.SYS_TIMETRAVEL;break;}da.exitState({status:bb,stateId:ja});});var xa=function(za,ab){var bb=Date.now(),cb;if(ab){sa=bb;cb=ab.nextState||ab.state;}else cb=va;v.checkTimeTravel();if(ta){var db=Math.round((bb-ta)/1000);if(db>0){ua[va]=(ua[va]||0)+db;ua.total+=db;}}va=cb;ta=bb;if(!za){ua.lastSuccessTime=na();ua.online=v.isOnline();ea.log('rollup',ua);}};h.subscribe(j.ON_ENTER_STATE,xa);setInterval(xa,60000,false);h.subscribe(p.DUMP_EVENT,function(za,ab){ab.channelRollup=ua;});var ya=function(){if(da.isShutdown()||da.shouldIdle())return;v.checkTimeTravel();var za=Date.now()-(da.lastPullTime||n.start);if(!wa&&za>ia.STALL_THRESHOLD){var ab=na();ea.error('stall',{lastSuccessTime:ab,rollupState:va});wa=true;}var bb=Date.now()-sa;if(da.state=='pull'&&bb>ia.JUMPSTART_THRESHOLD){sa=null;ea.warn('jumpstart',{state:da.state,dormant:bb});da.enterState('init');}};setInterval(ya,10000,false);}function qa(){var sa=Date.now(),ta=1;function ua(){setTimeout(ua,ta*1000,false);var za=da.state;if(za=='idle'&&da.shouldIdle())return;ea.bump('conn_t',ta);if(za=='pull')ea.bump('conn_t_pull',ta);}ua();var va=[15,30,60,120,240],wa=false,xa=false;function ya(za){setTimeout(function(){ea.rate('pullenter_'+za,wa);ea.rate('pullexit_'+za,xa);},za*1000,false);}while(va.length)ya(va.shift());h.subscribe(j.ON_ENTER_STATE,function(za,ab){if(ab.state=='pull')wa=true;sa=Date.now();});h.subscribe(j.ON_EXIT_STATE,function(za,ab){if(ab.state!='pull'||!sa)return;var bb='other';if(ab.status==j.OK){xa=true;bb='ok';}else if(ab.xhr&&ab.xhr.errorType){bb=/ar:(\w+)/.test(ab.xhr.errorType)&&RegExp.$1;}else if(/^sys_/.test(ab.status))return;var cb=(Date.now()-sa)/1000;if(cb<0){return;}else if(cb>3600)cb=3600;ea.bump('conn_num');ea.bump('conn_exit',cb);ea.bump('conn_num_'+bb);ea.bump('conn_exit_'+bb,cb);});}function ra(sa){if(sa){la=0;ka={};}else la++;}da={state:'idle',nextState:null,lastPullTime:Date.now(),heartbeats:[],setTestCallback:ga,init:function(sa){this.init=function(){};if(typeof(x)!='undefined'){x.subscribe(function(){ia.userActive=Date.now();}.bind(this));}else ea.error('user_activity_undefined');r.register('ch',oa);var ta=this.getConfig('max_conn',2);ia.subdomain=k.allocate(ta);if(typeof window.onpageshow!='undefined'){Event.listen(window,'pagehide',k.clear);}else u.onUnload(k.clear);this._transportRate=new q(30000);var ua=(g.supportsCORS()&&!ia.forceIframe)?'CORSTransport':'IframeTransport';this.transport=new l[ua](this);if(sa)this.enterState.apply(this,arguments);h.subscribe(p.DUMP_EVENT,function(event,wa){wa.transportRate=this._transportRate.tally();wa.transportType=ua;wa.transportVersion=2;}.bind(this));pa();qa();if(da.getConfig('tryStreaming')&&da.getConfig('host')&&g.supportsCORS()&&!ia.forceIframe){var va=ia.MIN_INIT_PROBE_DELAY+Math.random()*ia.INIT_PROBE_DELAY_RANDOMIZE_RANGE;setTimeout(this._probeTest,va,false);}},configure:function(){var sa=aa(arguments);ea.log('configure',sa);sa.forEach(z.bind(null,ia));h.inform(j.ON_CONFIG,this);},getConfig:function(sa,ta){return sa in ia?ia[sa]:ta;},isShutdown:function(){return this.state=='shutdown';},shouldIdle:function(){return !(v.isPageOwner()&&v.isOnline());},_sendIframeError:function(sa){var ta=new i().setURI('/ajax/presence/reconnect.php').setData({reason:sa,fb_dtsg:n.fb_dtsg}).setOption('suppressErrorHandlerWarning',true).setOption('retries',1).setMethod('GET').setReadOnly(true).setAllowCrossPageTransition(true);ta.specifiesWriteRequiredParams()&&ta.send();},_getDelay:function(){var sa=Math.min(ia.MIN_RETRY_INTERVAL*Math.pow(2,Math.max(0,la-1)),ia.MAX_RETRY_INTERVAL);return sa*(.75+Math.random()/2)|0;},enterState:function(){if(this._inEnterState)ea.warn('enterstate_recursion');this._inEnterState=true;try{this._enterState.apply(this,arguments);this._inEnterState=false;}catch(sa){this._inEnterState=false;throw sa;}},_enterState:function(sa){var ta=0,ua=null,va=aa(arguments);if(this.isShutdown())return;if(sa!='idle!'&&this.shouldIdle())return;ja++;ia.stateId=ja;clearTimeout(this._deferredTransition);this._deferredTransition=null;this.transport.enterState('idle');this.state='idle';this.nextState=null;if(/!$/.test(sa)){var wa=this._transportRate.tally().timeAverage,xa=da.getConfig('MAX_CHANNEL_STATES_PER_SEC',1);if(wa>=xa){if(!this._throttled){this._throttled=true;ea.warn('throttled');}ea.bump('throttle');ta=1000/xa;}}else if(!(/#$/.test(sa)))ta=this._getDelay();sa=sa.replace(/\W*$/,'');if(!ha[sa])throw new Error('invalid state:'+sa);var ya;if(ta<=0){ya={state:sa};this._transportRate.add(1);this.state=sa;var za=this['_enter_'+this.state];if(za){va.shift();za.apply(this,va);}if(/init|idle|pull|ping/.test(this.state)){if(ia.streamingCapable&&/pull/.test(this.state))this.heartbeats=[];this.transport.enterState(this.state,ia);if(this.state=='ping'){ya.url=l.getURI(ia).toString();ya.port=ia.port||'undefined';}}}else{this.state='idle';this.nextState=sa;ya={state:this.state,delay:ta,nextState:sa};va[0]=sa+'#';this._deferredTransition=(function(){this._deferredTransition=null;this.enterState.apply(this,va);}).bind(this).defer(ta,false);}if(/pull/.test(sa)){ya.client_id=ia.sessionID;ya.streaming=ia.inStreaming;}ea.log('enter_'+this.state,ya);h.inform(j.ON_ENTER_STATE,ya);},exitState:function(sa,ta){var ua=sa.stateId,va=sa.status;if(this.isShutdown()||ua<ja)return;var wa=aa(arguments),xa=this.state;wa[0]=sa.status;var ya={state:xa,status:va};if(/pull/.test(xa)){ya.client_id=ia.sessionID;ya.streaming=ia.inStreaming;}if(this.nextState)ya.nextState=this.nextState;if(ta&&ta.errorType){ya.xhr=ta.toJSON?ta.toJSON():ta;delete ya.xhr.json;}if(ta&&ta.json){if(ta.json.t)ya.t=ta.json.t;if(ta.json.reason)ya.reason=ta.json.reason;if(ta.json.seq)ya.seq=ta.json.seq;}ea.log('exit_'+xa,ya);h.inform(j.ON_EXIT_STATE,ya);var za=this['_exit_'+xa];if(za)va=za.apply(this,wa)||va;if(va!=j.OK){ra();ka[xa]=(ka[xa]||0)+1;}var ab=ha[this.nextState||xa][va]||ha._all[va],bb=ab&&ab.replace(/!*$/,'');if(!bb){ea.error('terminal_transition',ya);this._shutdownHint=j.HINT_INVALID_STATE;ab='shutdown!';}this._lastState=xa;this._lastStatus=va;this.enterState(ab);},_processTransportData:function(sa,ta){var ua=ta.json,va=ua.t;if('s' in ua){ua.seq=ua.s;delete ua.s;}var wa=ia.seq;if('seq' in ua){ia.seq=ua.seq;s.doSync();}switch(va){case 'continue':if(ia.inStreaming&&this.heartbeats.length<1){ia.streamingCapable=false;ea.log('switch_to_longpoll');setTimeout(this._probeTest,ia.PROBE_DELAY,false);}ra(true);if(!ia.inStreaming||ia.STREAMING_EXIT_STATE_ON_CONTINUE)this.exitState({status:j.OK,stateId:sa});break;case 'refresh':case 'refreshDelay':this.exitState({status:'refresh_'+(ua.reason||0),stateId:sa},ta);break;case 'fullReload':r.clear();ea.log('invalid_history');h.inform(j.ON_INVALID_HISTORY);this.exitState({status:j.ERROR_MISSING,stateId:sa},ta);break;case 'msg':var xa,ya,za,ab;ra(true);ya=ua.ms;za=ia.seq-ya.length;for(xa=0;xa<ya.length;xa++,za++)if(za>=wa){ab=ya[xa];if(ab.type){ea.debug('message',{type:ab.type});h.inform(j.getArbiterType(ab.type),{obj:ab});}}else ea.warn('seq_regression',{seq:za,last_seq:wa,messages:ya.length});break;case 'heartbeat':if(ia.inStreaming){var bb=Date.now();if(this.heartbeats.length>0){var cb=bb-this.heartbeats[this.heartbeats.length-1];ea.log('heartbeat_interval',{client_id:ia.sessionID,interval:cb});}this.heartbeats.push(bb);}break;default:ea.error('unknown_msg_type',{type:va});break;}},_enter_init:function(){if(ka.init>=da.getConfig('MAX_INIT_FAILS',2))return this.exitState.bind(this,{status:j.ERROR_MAX,stateId:ja}).defer();this._initTimer=this.exitState.bind(this,{status:j.ERROR,stateId:ja},'timeout').defer(ia.IFRAME_LOAD_TIMEOUT,false);},_enter_reconnect:function(sa){var ta=ja;if(!t.hasUserCookie()){ea.warn('no_user_cookie');(function(){da._shutdownHint=j.HINT_AUTH;da.exitState({status:j.ERROR_SHUTDOWN,stateId:ta});}).defer();return;}var ua={reason:sa,fb_dtsg:n.fb_dtsg};if(n.fb_isb)ua.fb_isb=n.fb_isb;if(fa)fa(ua);var va=new o('GET','/ajax/presence/reconnect.php',ua);va.onSuccess=(function(){da.configure(va.json);r.store();this.exitState({status:j.OK,stateId:ta});}).bind(this);va.onError=(function(){var wa=va.json&&va.json.error;if(va.errorType==g.TRANSPORT_ERROR||va.errorType==g.PROXY_ERROR)this._shutdownHint=j.HINT_CONN;if(wa&&wa==1356007){this._shutdownHint=j.HINT_MAINT;}else if(wa==1357001||wa==1357004||wa==1348009){this._shutdownHint=j.HINT_AUTH;}else this._shutdownHint=null;this.exitState({status:this._shutdownHint?j.ERROR_SHUTDOWN:j.ERROR,stateId:ta},va);}).bind(this);va.send();},_enter_shutdown:function(){h.inform(j.ON_SHUTDOWN,{reason:this._shutdownHint});},_exit_init:function(sa){if(this._initTimer)this._initTimer=clearTimeout(this._initTimer);if(sa==j.ERROR_MAX)this._sendIframeError(j.reason_IFrameLoadGiveUp);},_exit_pull:function(sa){if(sa==j.OK)this.lastPullTime=Date.now();},_exit_ping:function(sa){if(sa==j.OK){var ta=Date.now()-(this.lastPullTime||n.start);if(ta>ia.STALL_THRESHOLD)return j.ERROR_STALE;}},_probeTest:function(){ia.streamingCapable=false;var sa=[],ta={mode:'stream',format:'json'},ua=new w('/probe').setDomain(ia.host+'.facebook.com').setPort(ia.port).setSecure(w().isSecure()).setQueryData(ta),va=new g('GET',ua);va.onJSON=function(wa,xa){if(wa&&wa.json&&wa.json.t==='heartbeat'){sa.push(Date.now());if(sa.length>=2){var ya=sa[1]-sa[0];if(ya>=ia.PROBE_HEARTBEATS_INTERVAL_LOW&&ya<=ia.PROBE_HEARTBEATS_INTERVAL_HIGH){ia.streamingCapable=true;ea.log('switch_to_streaming');}ea.log('probe_ok',{time:ya});}}};va.onSuccess=function(wa){if(sa.length!=2){ia.streamingCapable=false;ea.error('probe_error',{error:'beats.length = '+sa.length});}};va.onError=function(wa){ia.streamingCapable=false;ea.error('probe_error',wa);};ea.log('probe_request');va.send();}};e.exports=da;if(ca.serverInitialized==null){da.configure(ca.channelConfig);if(/shutdown/.test(ca.state)){da._shutdownHint=j[ca.reason];}else ca.reconnectReason;da.init(ca.state,ca.reason);}});
__d("ChannelConnection",["Arbiter","copyProperties","ChatConfig","Run","SystemEvents","ChannelConstants","ChannelManager","JSLogger"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('copyProperties'),i=b('ChatConfig'),j=b('Run'),k=b('SystemEvents'),l=b('ChannelConstants'),m=b('ChannelManager'),n=b('JSLogger'),o=n.create('channel_connection'),p=null,q=null,r=null,s=null,t=0,u=h(new g(),{CONNECTED:'chat-connection/connected',RECONNECTING:'chat-connection/reconnecting',SHUTDOWN:'chat-connection/shutdown',MUTE_WARNING:'chat-connection/mute',UNMUTE_WARNING:'chat-connection/unmute'});function v(){if(q){clearTimeout(q);q=null;}}function w(){v();o.log('unmute_warning');u.inform(u.UNMUTE_WARNING);}function x(ba){v();q=w.defer(ba,false);o.log('mute_warning',{time:ba});u.inform(u.MUTE_WARNING);}function y(){if(r){clearTimeout(r);r=null;}}function z(ba,ca){y();if(ba===l.ON_ENTER_STATE&&(ca.nextState||ca.state)==='pull'){if(s!==u.CONNECTED){o.log('connected');var da=!s;s=u.CONNECTED;t=0;u.inform(u.CONNECTED,{init:da});}}else if(ba===l.ON_ENTER_STATE&&((ca.nextState||ca.state)==='ping'||(!ca.nextState&&ca.state==='idle'))){r=(function(){var ea=null;if(!(ca.state==='idle'&&!ca.nextState))ea=(ca.delay||0);o.log('reconnecting',{delay:ea});if(u.disconnected())o.log('reconnecting_ui',{delay:ea});s=u.RECONNECTING;(ca.state==='idle')&&t++;if(t>1){u.inform(u.RECONNECTING,ea);}else if(!ca.nextState&&ca.state==='idle')z(ba,ca);}).defer(500,false);}else if(ba===l.ON_SHUTDOWN){o.log('shutdown',{reason:ca.reason});s=u.SHUTDOWN;t=0;u.inform(u.SHUTDOWN,ca.reason);}}function aa(ba){if(m.state==='ping'||m.isShutdown())return;o.log('reconnect',{now:ba});u.inform(u.RECONNECTING,0);if(!!ba){if(p!==null){clearTimeout(p);p=null;}m.enterState('ping!');}else if(!p)p=setTimeout(function(){m.enterState('ping!');p=null;},i.get('channel_manual_reconnect_defer_msec'),false);}if(m.isShutdown()){z(l.ON_SHUTDOWN,m._shutdownHint);}else z(l.ON_ENTER_STATE,{state:m.state,nextState:m.nextState,delay:0});g.subscribe([l.ON_ENTER_STATE,l.ON_SHUTDOWN],z);k.subscribe(k.TIME_TRAVEL,function(){aa();x(i.get('mute_warning_time_msec'));});j.onBeforeUnload(y,false);h(u,{disconnected:function(){return s===u.SHUTDOWN||(s===u.RECONNECTING&&!q&&t>1);},isShutdown:function(){return s===u.SHUTDOWN;},reconnect:aa,unmuteWarning:w});e.exports=u;});
__d("legacy:ChannelConstants",["ChannelConstants"],function(a,b,c,d){a.ChannelConstants=b('ChannelConstants');},3);
__d("AvailableListConstants",[],function(a,b,c,d,e,f){var g={ON_AVAILABILITY_CHANGED:'buddylist/availability-changed',ON_UPDATE_ERROR:'buddylist/update-error',ON_UPDATED:'buddylist/updated',ON_CHAT_NOTIFICATION_CHANGED:'chat-notification-changed',OFFLINE:0,IDLE:1,ACTIVE:2,MOBILE:3,LEGACY_OVERLAY_OFFLINE:-1,LEGACY_OVERLAY_ONLINE:0,LEGACY_OVERLAY_IDLE:1,legacyStatusMap:{'0':2,'1':1,'-1':0,'2':3},reverseLegacyStatusMap:{0:-1,1:1,2:0,3:2}};window.AvailableListConstants=e.exports=g;},3);
__d("PresencePrivacy",["hasArrayNature","Arbiter","AsyncRequest","ChannelConstants","copyProperties","Env","JSLogger","PresenceUtil","PresencePrivacyInitialData"],function(a,b,c,d,e,f){var g=b('hasArrayNature'),h=b('Arbiter'),i=b('AsyncRequest'),j=b('ChannelConstants'),k=b('copyProperties'),l=b('Env'),m=b('JSLogger'),n=b('PresenceUtil'),o=c('PresencePrivacyInitialData'),p='/ajax/chat/privacy/settings.php',q='/ajax/chat/privacy/online_policy.php',r='/ajax/chat/privacy/visibility.php',s='friend_visibility',t='visibility',u='online_policy',v=k({},o.privacyData),w=o.visibility,x=k({},o.privacyData),y=w,z=o.onlinePolicy,aa=z,ba=[],ca=false;function da(){return m.create('blackbird');}var ea=k(new h(),{WHITELISTED:1,BLACKLISTED:-1,UNLISTED:0,ONLINE:1,OFFLINE:0,ONLINE_TO_WHITELIST:0,ONLINE_TO_BLACKLIST:1});function fa(ra){var sa;for(sa in ra){var ta=ra[sa];if(sa==l.user){da().error('set_viewer_visibility');throw new Error("Invalid to set current user's visibility");}switch(ta){case ea.WHITELISTED:case ea.BLACKLISTED:case ea.UNLISTED:break;default:da().error('set_invalid_friend_visibility',{id:sa,value:ta});throw new Error("Invalid state: "+ta);}}for(sa in ra)v[sa]=ra[sa];ea.inform('privacy-changed');}function ga(ra,sa){var ta={};ta[ra]=sa;fa(ta);}function ha(ra){switch(ra){case ea.ONLINE:case ea.OFFLINE:break;default:da().error('set_invalid_visibility',{value:ra});throw new Error("Invalid visibility: "+ra);}w=ra;ea.inform('privacy-changed');ea.inform('privacy-user-presence-changed');h.inform('chat/visibility-changed',{sender:this});}function ia(ra){switch(ra){case ea.ONLINE_TO_WHITELIST:case ea.ONLINE_TO_BLACKLIST:break;default:throw new Error("Invalid default online policy: "+ra);}z=ra;ea.inform('privacy-user-presence-changed');ea.inform('privacy-changed');}function ja(ra,sa){ca=true;ra.send();}function ka(ra,sa){ba.push({request:ra,data:sa});if(!ca){var ta=ba.shift();ja(ta.request,ta.data);}}function la(ra,sa){var ta=ra.type;if(ta===s){var ua=sa.payload.user_availabilities;if(!g(ua)){ea.inform('privacy-availability-changed',{user_availabilities:ua});for(var va in ra.settings)x[va]=ra.settings[va];}}else{if(ta===t){y=ra.visibility;}else if(ta===u)aa=ra.online_policy;ea.inform('privacy-user-presence-response');}da().log('set_update_response',{data:ra,response:sa});}function ma(ra,sa){if(w!==y)ha(y);if(z!==aa)ia(aa);k(v,x);ea.inform('privacy-changed');ba=[];da().log('set_error_response',{data:ra,response:sa});}function na(ra){ca=false;if(ba.length>0){var sa=ba.shift();ja(sa.request,sa.data);}}function oa(ra,sa){if(n!=null){var ta=ra.getData();ta.window_id=n.getSessionID();ra.setData(ta);}ra.setHandler(la.bind(this,sa)).setErrorHandler(ma.bind(this,sa)).setTransportErrorHandler(ma.bind(this,sa)).setFinallyHandler(na.bind(this)).setAllowCrossPageTransition(true);return ra;}function pa(ra,sa,ta){return oa(new i(ra).setData(sa),ta);}function qa(ra,sa){var ta=sa.obj;if(ta.viewer_id!=l.user){da().error('invalid_viewer_for_channel_message',{type:ra,data:sa});throw new Error("Viewer got from the channel is not the real viewer");}if(ta.window_id===n.getSessionID())return;var ua=ta.data;if(ta.event=='access_control_entry'){ua.target_ids.forEach(function(wa){ga(wa,ua.setting);x[wa]=ua.setting;});}else{if(ta.event=='visibility_update'){var va=!!ua.visibility?ea.ONLINE:ea.OFFLINE;ha(va);y=va;}else if(ta.event=='online_policy_update'){ia(ua.online_policy);aa=ua.online_policy;}ea.inform('privacy-user-presence-response');}da().log('channel_message_received',{data:sa.obj});}k(ea,{WHITELISTED:1,BLACKLISTED:-1,UNLISTED:0,ONLINE:1,OFFLINE:0,ONLINE_TO_WHITELIST:0,ONLINE_TO_BLACKLIST:1,init:function(ra,sa,ta){},setVisibility:function(ra){y=w;ha(ra);var sa={visibility:ra},ta={type:t,visibility:ra},ua=pa(r,sa,ta);ka(ua,ta);da().log('set_visibility',{data:sa});return ra;},getVisibility:function(){return w;},setOnlinePolicy:function(ra){aa=z;ia(ra);var sa={online_policy:ra},ta={type:u,online_policy:ra},ua=pa(q,sa,ta);ka(ua,ta);da().log('set_online_policy',{data:sa});return ra;},getOnlinePolicy:function(){return z;},getFriendVisibility:function(ra){return v[ra]||ea.UNLISTED;},allows:function(ra){if(this.getVisibility()===ea.OFFLINE)return false;var sa=this.getOnlinePolicy();return sa===ea.ONLINE_TO_WHITELIST?v[ra]==ea.WHITELISTED:v[ra]!=ea.BLACKLISTED;},setFriendsVisibility:function(ra,sa){if(ra.length>0){var ta={};for(var ua=0;ua<ra.length;ua++){var va=ra[ua];x[va]=v[va];ta[va]=sa;}fa(ta);var wa=sa;if(wa==ea.UNLISTED)wa=x[ra[0]];var xa={users:ra,setting:sa,setting_type:wa},ya={type:s,settings:ta},za=pa(p,xa,ya);ka(za,ya);da().log('set_friend_visibility',{data:xa});}return sa;},setFriendVisibilityMap:function(ra,sa){for(var ta in ra)x[ta]=v[ta];fa(ra);var ua={type:s,settings:ra};ka(oa(sa,ua),ua);da().log('set_friend_visibility_from_map',{data:ra});},allow:function(ra){if(this.allows(ra)){da().error('allow_already_allowed');throw new Error("allow() should only be called for users that "+"are not already allowed");}if(this.getVisibility()===ea.OFFLINE){da().error('allow_called_while_offline');throw new Error("allow() should only be called when the user is already online");}var sa=this.getOnlinePolicy()===ea.ONLINE_TO_WHITELIST?ea.WHITELISTED:ea.UNLISTED;return this.setFriendsVisibility([ra],sa);},disallow:function(ra){if(!this.allows(ra)){da().error('disallow_already_disallowed');throw new Error("disallow() should only be called for users that "+"are not already disallowed");}if(this.getVisibility()===ea.OFFLINE){da().error('disallow_called_while_offline');throw new Error("disallow() should only be called when the user is already online");}var sa=this.getOnlinePolicy()===ea.ONLINE_TO_BLACKLIST?ea.BLACKLISTED:ea.UNLISTED;return this.setFriendsVisibility([ra],sa);},getBlacklist:function(){var ra=[];for(var sa in v)if(v[sa]===ea.BLACKLISTED)ra.push(sa);return ra;},getWhitelist:function(){var ra=[];for(var sa in v)if(v[sa]===ea.WHITELISTED)ra.push(sa);return ra;},getMapForTest:function(){return v;},setMapForTest:function(ra){v=ra;}});ea.inform('privacy-changed');ea.inform('privacy-user-presence-changed');da().log('initialized',{visibility:w,policy:z});h.subscribe(j.getArbiterType('privacy_changed'),qa.bind(this));h.subscribe(j.ON_CONFIG,function(ra,sa){var ta=sa.getConfig('visibility',null);if(ta!==null&&typeof(ta)!=='undefined'){var ua=ta?ea.ONLINE:ea.OFFLINE;ha(ua);da().log('config_visibility',{vis:ua});}}.bind(this));a.PresencePrivacy=e.exports=ea;},3);
__d("Chat",["Arbiter","AsyncSignal","JSLogger","PresencePrivacy"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('AsyncSignal'),i=b('JSLogger'),j=b('PresencePrivacy');function k(o,p,q){if(p&&p=='ordered_list'||p=='more_online_friends'||p=='online_friends'||p=='typeahead'){var r={target:o,source:p,sorted_list:q};new h('/ajax/chat/ct.php',r).send();}}var l={buddyListNub:'buddylist-nub/initialized',sidebar:'sidebar/initialized'};function m(o,p){g.subscribe(l[o],function(event,q){p(q);});}var n={openTab:function(o,p,q,r,s){if(window.External&&window.External.Chat&&window.External.Chat.openWindow)window.External.Chat.openWindow(o);k(o,r,s);d(['MercuryThreads'],function(t){if(!q||q=='friend'){var u=t.getCanonicalThreadToUser(o);g.inform('chat/open-tab',{thread_id:u.thread_id});}});},openBuddyList:function(){m('buddyListNub',function(o){o.show();m('sidebar',function(p){p.enable();});});},closeBuddyList:function(){m('buddyListNub',function(o){o.hide();});},toggleSidebar:function(){m('sidebar',function(o){o.toggle();});},goOnline:function(o){d(['ChatVisibility'],function(p){p.goOnline(o);});},isOnline:function(){var o=null;d(['ChatVisibility'],function(p){o=p;});return o&&o.isOnline();}};a.Chat=e.exports=n;},3);
__d("ChatVisibility",["ChatConfig","JSLogger","PresencePrivacy"],function(a,b,c,d,e,f){var g=b('ChatConfig'),h=b('JSLogger'),i=b('PresencePrivacy'),j={isOnline:function(){return i.getVisibility()===i.ONLINE;},goOnline:function(k){if(i.getVisibility()===i.OFFLINE){h.create('blackbird').log('chat_go_online');i.setVisibility(i.ONLINE);}k&&k();},goOffline:function(k){if(i.getVisibility()===i.ONLINE){h.create('blackbird').log('chat_go_offline');i.setVisibility(i.OFFLINE);}k&&k();},toggleVisibility:function(){if(j.isOnline()){j.goOffline();}else j.goOnline();}};a.ChatVisibility=e.exports=j;},3);
__d("ServerTime",["PresenceInitialData"],function(a,b,c,d,e,f){var g=c('PresenceInitialData'),h;function i(k){h=Date.now()-k;}i(g.serverTime);var j={get:function(){return Date.now()-h;},getSkew:function(){return h;},update:function(k){i(k);}};e.exports=j;});
__d("CallbackManagerController",["ErrorUtils","copyProperties"],function(a,b,c,d,e,f){var g=b('ErrorUtils'),h=b('copyProperties'),i=function(j){this._pendingIDs=[];this._allRequests=[undefined];this._callbackArgHandler=j;};h(i.prototype,{executeOrEnqueue:function(j,k,l){l=l||{};var m=this._attemptCallback(k,j,l);if(m)return 0;this._allRequests.push({fn:k,request:j,options:l});var n=this._allRequests.length-1;this._pendingIDs.push(n);return n;},unsubscribe:function(j){delete this._allRequests[j];},getRequest:function(j){return this._allRequests[j];},runPossibleCallbacks:function(){var j=this._pendingIDs;this._pendingIDs=[];var k=[];j.forEach(function(l){var m=this._allRequests[l];if(!m)return;if(this._callbackArgHandler(m.request,m.options)){k.push(l);}else this._pendingIDs.push(l);}.bind(this));k.forEach(function(l){var m=this._allRequests[l];delete this._allRequests[l];this._attemptCallback(m.fn,m.request,m.options);}.bind(this));},_attemptCallback:function(j,k,l){var m=this._callbackArgHandler(k,l);if(m){var n={ids:k};g.applyWithGuard(j,n,[m]);}return !!m;}});e.exports=i;});
__d("KeyedCallbackManager",["CallbackManagerController","copyProperties"],function(a,b,c,d,e,f){var g=b('CallbackManagerController'),h=b('copyProperties'),i=function(){this._resources={};this._controller=new g(this._constructCallbackArg.bind(this));};h(i.prototype,{executeOrEnqueue:function(j,k){if(!(j instanceof Array)){var l=j,m=k;j=[j];k=function(n){m(n[l]);};}return this._controller.executeOrEnqueue(j,k);},unsubscribe:function(j){this._controller.unsubscribe(j);},getUnavailableResources:function(j){var k=this._controller.getRequest(j),l=[];if(k)l=k.request.filter(function(m){return !this._resources[m];}.bind(this));return l;},addResourcesAndExecute:function(j){h(this._resources,j);this._controller.runPossibleCallbacks();},setResource:function(j,k){this._resources[j]=k;this._controller.runPossibleCallbacks();},getResource:function(j){return this._resources[j];},getAllResources:function(){return this._resources;},dumpResources:function(){var j={};for(var k in this._resources){var l=this._resources[k];if(typeof l==='object')l=h({},l);j[k]=l;}return j;},_constructCallbackArg:function(j){var k={};for(var l=0;l<j.length;l++){var m=j[l],n=this._resources[m];if(typeof n=='undefined')return false;k[m]=n;}return k;}});e.exports=i;});
__d("AsyncLoader",["AsyncRequest","KeyedCallbackManager","copyProperties"],function(a,b,c,d,e,f){var g=b('AsyncRequest'),h=b('KeyedCallbackManager'),i=b('copyProperties'),j={};function k(m,n){var o=new h(),p=false,q=[];function r(){if(!q.length||p)return;p=true;t.defer();}function s(w){p=false;w.forEach(o.unsubscribe.bind(o));r();}function t(){var w={},x=[];q=q.filter(function(z){var aa=o.getUnavailableResources(z);if(aa.length){aa.forEach(function(ba){w[ba]=true;});x.push(z);return true;}return false;});var y=Object.keys(w);if(y.length){new g(m).setData({ids:y}).setHandler(u.curry(x)).setErrorHandler(v.curry(x)).setAllowCrossPageTransition(true).setMethod('GET').setReadOnly(true).send();}else p=false;}function u(w,x){var y=x.payload[n]||x.payload;o.addResourcesAndExecute(y);s(w);}function v(w){s(w);}return {get:function(w,x){var y=o.executeOrEnqueue(w,x),z=o.getUnavailableResources(y);if(z.length){q.push(y);r();}},getCachedKeys:function(){return Object.keys(o.getAllResources());},getNow:function(w){return o.getResource(w)||null;},set:function(w){o.addResourcesAndExecute(w);}};}function l(m,n){this._endpoint=m;this._type=n;}i(l.prototype,{_getLoader:function(){if(!j[this._endpoint])j[this._endpoint]=k(this._endpoint,this._type);return j[this._endpoint];},get:function(m,n){return this._getLoader().get(m,n);},getCachedKeys:function(){return this._getLoader().getCachedKeys();},getNow:function(m){return this._getLoader().getNow(m);},reset:function(){j[this._endpoint]=null;},set:function(m){this._getLoader().set(m);}});e.exports=l;});
__d("ShortProfiles",["ArbiterMixin","AsyncLoader","AsyncRequest","Env","JSLogger","copyProperties"],function(a,b,c,d,e,f){var g=b('ArbiterMixin'),h=b('AsyncLoader'),i=b('AsyncRequest'),j=b('Env'),k=b('JSLogger'),l=b('copyProperties'),m='/ajax/chat/user_info.php',n='/ajax/chat/user_info_all.php',o=new h(m,'profiles'),p=false,q=k.create('short_profiles');function r(){if(!p){q.log('fetch_all');p=true;new i(n).setData({viewer:j.user}).setHandler(function(u){o.set(u.payload);t.inform('updated');}).setAllowCrossPageTransition(true).setMethod('GET').setReadOnly(true).send();}}function s(u){return JSON.parse(JSON.stringify(u));}var t={};l(t,g,{get:function(u,v){this.getMulti([u],function(w){v(w[u],u);});},getMulti:function(u,v){function w(x){v(s(x));}o.get(u,w);},getNow:function(u){return s(o.getNow(u)||null);},getCachedProfileIDs:function(){return o.getCachedKeys();},hasAll:function(){return p;},fetchAll:function(){r();},set:function(u,v){var w={};w[u]=v;this.setMulti(w);},setMulti:function(u){o.set(s(u));}});e.exports=t;});
__d("AvailableList",["function-extensions","Arbiter","ArbiterMixin","AsyncRequest","AvailableListConstants","ChannelConstants","Chat","ChatConfig","ChatVisibility","Class","Env","JSLogger","Poller","PresencePrivacy","PresenceUtil","ServerTime","ShortProfiles","UserActivity","copyProperties","createObjectFrom","debounceAcrossTransitions","ChannelImplementation","AvailableListInitialData"],function(a,b,c,d,e,f){b('function-extensions');var g=b('Arbiter'),h=b('ArbiterMixin'),i=b('AsyncRequest'),j=b('AvailableListConstants'),k=b('ChannelConstants'),l=b('Chat'),m=b('ChatConfig'),n=b('ChatVisibility'),o=b('Class'),p=b('Env'),q=b('JSLogger'),r=b('Poller'),s=b('PresencePrivacy'),t=b('PresenceUtil'),u=b('ServerTime'),v=b('ShortProfiles'),w=b('UserActivity'),x=b('copyProperties'),y=b('createObjectFrom'),z=b('debounceAcrossTransitions'),aa=c('ChannelImplementation').instance,ba=c('AvailableListInitialData'),ca=5,da=60000,ea='/ajax/chat/buddy_list.php',fa=5000,ga=1800000,ha=.005,ia=0,ja=0,ka=false,la=ba.pollInterval,ma=ba.lazyPollInterval,na=ba.lazyThreshold,oa=0,pa=Date.now(),qa=0,ra=false,sa={},ta=false,ua={},va=null,wa={},xa={},ya=q.create('available_list'),za=x({},j,h);za.subscribe([j.ON_AVAILABILITY_CHANGED,j.ON_UPDATE_ERROR,j.ON_UPDATED],function(sb,tb){g.inform(sb,tb);});function ab(sb){var tb=sb||w.isActive(na);return n.isOnline()?(tb?la:ma):null;}function bb(){za.inform(j.ON_AVAILABILITY_CHANGED);}var cb=z(bb,0);function db(sb,tb,ub,vb){if(sb==p.user)return;switch(tb){case j.OFFLINE:case j.IDLE:case j.ACTIVE:case j.MOBILE:break;default:return;}var wb=za.get(sb)!=tb;if(ub){wa[sb]=u.get();xa[sb]=vb;}sa[sb]=tb;if(wb){ia++;cb();}}function eb(sb){qa=Date.now();ua=y(sb);ia++;cb();}function fb(){if(ra)za.inform(j.ON_UPDATED,za);}function gb(sb){if(t.checkMaintenanceError(sb))return;ja++;ka=false;if(ja>=ca)za.inform(j.ON_UPDATE_ERROR);}function hb(sb){var tb=sb.getPayload(),ub=tb.buddy_list;if(!ub){gb(sb);return;}u.update(tb.time);oa=u.get();ja=0;ka=false;if(ub.mobile_friends!=null)eb(ub.mobile_friends);var vb=ub.userInfos;if(vb)v.setMulti(vb);nb();ta=ub.userIsIdle;var wb=ub.nowAvailableList;wb&&lb(wb);if(ub.chatNotif!==undefined){va=ub.chatNotif;za.inform(j.ON_CHAT_NOTIFICATION_CHANGED,va);}mb();fb();cb();}function ib(sb){if(aa.isShutdown()||!n.isOnline()){za._poller.stop();return;}pa=Date.now();var tb=false;if(Date.now()-qa>ga)tb=true;ka=true;var ub=v.getCachedProfileIDs();sb.setHandler(hb).setErrorHandler(gb).setOption('suppressErrorAlerts',true).setOption('retries',1).setData({user:p.user,available_user_info_ids:ub,fetch_mobile:tb}).setURI(ea).setAllowCrossPageTransition(true);}function jb(sb){var tb=sb.payload.availability||{};for(var ub in tb)db(ub,tb[ub],true,'mercury_tabs');}function kb(sb){var tb=za.getDebugInfo(sb),ub=(tb.presence==j.ACTIVE),vb=new i('/ajax/mercury/tabs_presence.php').setData({target_id:sb,to_online:ub,presence_source:tb.overlaySource,presence_time:tb.overlayTime}).setHandler(jb).setErrorHandler(bagofholding).setAllowCrossPageTransition(true).send();}function lb(sb){for(var tb in sb)db(tb,sb[tb].a,false,null);ra=true;}function mb(sb){var tb=ab(sb);ya.debug('update_poller',tb);za._poller&&za._poller.setTimePeriod(tb);}function nb(){ra=false;sa={};xa={};wa={};ia++;}function ob(){nb();pa=0;qa=0;ta=false;va=null;ua={};bb();}function pb(){mb();if(n.isOnline()){za.update();}else ob();}function qb(){mb();if(aa.disconnected()){ob();}else if(!ra)za.update();}function rb(sb,tb){tb.chat_config=m.getDebugInfo();tb.available_list_debug_info={};za.getAvailableIDs().forEach(function(ub){tb.available_list_debug_info[ub]=za.getDebugInfo(ub);});tb.available_list_poll_interval=za._poller&&za._poller.getTimePeriod();}x(za,{get:function(sb){if(sb==p.user)return n.isOnline()?j.ACTIVE:j.OFFLINE;var tb=j.OFFLINE;if(sb in sa)tb=sa[sb];if(!s.allows(sb))tb=j.OFFLINE;if(tb==j.OFFLINE)if(ua[sb])tb=j.MOBILE;return tb;},updateForID:function(sb){kb(sb);},getWebChatNotification:function(){return va;},isUserIdle:function(){return ta;},isReady:function(){return ra;},set:function(sb,tb,ub){db(sb,tb,true,null,ub);},update:function(){if(Date.now()-pa<fa){!ka&&fb.defer();return;}za._poller&&za._poller.requestNow();},getRev:function(){return ia;},isIdle:function(sb){return za.get(sb)==j.IDLE;},getOnlineIDs:function(){var sb,tb=[];for(sb in sa)if(za.get(sb)===j.ACTIVE)tb.push(sb);return tb;},getAvailableIDs:function(){var sb=za.getOnlineIDs(),tb;for(tb in ua){if(sa[tb])continue;sb.push(tb);}return sb;},getOnlineCount:function(){return za.getOnlineIDs().length;},getDebugInfo:function(sb){var tb;if(window.ShortProfiles){var ub=v.getNow(sb);if(ub)tb=ub.name;}return {id:sb,presence:sa[sb],overlaySource:xa[sb],overlayTime:wa[sb],overlaySource:xa[sb],mobile:ua[sb],name:tb};}});oa=ba.updateTime;lb(ba.availableList);if(ba.mobileFriends)eb(ba.mobileFriends);va=ba.chatNotif;za._poller=new r(ab(),ib,true);mb(true);g.subscribe(q.DUMP_EVENT,rb);w.subscribe(function(sb,tb){if(tb.idleness>la){ya.debug('update_activity');za.update();}});s.subscribe('privacy-changed',bb);s.subscribe('privacy-availability-changed',function(sb,tb){for(var ub in tb.user_availabilities)this.set(ub,tb.user_availabilities[ub]);}.bind(za));s.subscribe('privacy-user-presence-response',za.update);aa.subscribe([aa.CONNECTED,aa.RECONNECTING,aa.SHUTDOWN,aa.MUTE_WARNING,aa.UNMUTE_WARNING],qb);g.subscribe(k.getArbiterType('buddylist_overlay'),function(sb,tb){var ub=tb.obj.overlay;for(var vb in ub)za.set(vb,ub[vb].a,ub[vb].s||'channel');});a.AvailableList=e.exports=za;});
__d("ChatHovercard",["Arbiter","AsyncLoader","Hovercard","JSLogger","debounce"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('AsyncLoader'),i=b('Hovercard'),j=b('JSLogger'),k=b('debounce'),l=5,m=new h('/ajax/chat/hovercard/sidebar.php','hover'),n=j.create('chat_hovercard');g.subscribe('Hovercard/dirty',m.reset.bind(m));function o(s,t){m.get(s,function(u){(function(){if(!u){n.error('fetch_failure',{id:s});return;}var v=i.getDialog(u);if(!v){n.error('no_hovercard',{id:s,endpoint:u});return;}if(s==t.getActiveID())t.showHovercard(s,v);}).defer();});}function p(s,t){var u=[];function v(y){if(y>=0&&y<s.length)u.push(s[y]);}var w=s.indexOf(t);if(w>-1){v(w);for(var x=1;x<l;x++){v(w+x);v(w-x);}}return u;}function q(s,t){var u=t.getActiveID();if(u){var v=s.getShowingUsers(),w=p(v,u);m.get(w,function(){});}}function r(s){var t=s.getHoverController();t.registerDefault(o);t.subscribe('hover',k(q.curry(s,t),100));}e.exports=r;});
__d("ChatOptions",["Arbiter","ChannelConstants","JSLogger","PresenceState","PresenceUtil","copyProperties","ChatOptionsInitialData"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('ChannelConstants'),i=b('JSLogger'),j=b('PresenceState'),k=b('PresenceUtil'),l=b('copyProperties'),m=i.create('chat_options'),n={};(function(){var r=c('ChatOptionsInitialData');for(var s in r){var t=r[s];n[s]=!!t;}})();var o=l(new g(),{getSetting:function(r){return n[r];},setSetting:function(r,s,t){if(this.getSetting(r)==s)return;if(t){t='from_'+t;m.log(t,{name:r,new_value:s,old_value:this.getSetting(r)});}n[r]=!!s;g.inform('chat/option-changed',{name:r,value:s});}});function p(r){r.snd=o.getSetting('sound')?1:0;r.not=o.getSetting('browser_notif')?1:0;return r;}function q(r){o.setSetting('sound',!!r.snd,'cookie');o.setSetting('browser_notif',!!r.not,'cookie');}j.registerStateStorer(p);j.registerStateLoader(q);g.subscribe(h.getArbiterType('setting'),function(r,s){var t=s.obj;if(t.window_id===k.getSessionID())return;o.setSetting(t.setting,!!t.value,'channel');});e.exports=a.chatOptions||o;});
__d("ChatOrderedListHover",["event-extensions","function-extensions","ArbiterMixin","Class","CSS","DOM","ErrorUtils","LayerFadeOnHide","Parent","copyProperties","setTimeoutAcrossTransitions","tx"],function(a,b,c,d,e,f){b('event-extensions');b('function-extensions');var g=b('ArbiterMixin'),h=b('Class'),i=b('CSS'),j=b('DOM'),k=b('ErrorUtils'),l=b('LayerFadeOnHide'),m=b('Parent'),n=b('copyProperties'),o=b('setTimeoutAcrossTransitions'),p=b('tx');function q(t){i.addClass(t,'fetching');}function r(t){i.removeClass(t,'fetching');}function s(t){this._orderedList=t;this._root=t.getRoot();Event.listen(this._root,'mouseover',this._mouseOver.bind(this));Event.listen(this._root,'mouseleave',this._mouseLeave.bind(this));t.subscribe('click',this._hide.shield(this));}n(s.prototype,g,{_root:null,_activeItem:null,_hideTimeout:null,_showTimeout:null,_showingDialog:null,_showingID:null,_alreadyShowing:false,_handlers:{},_defaultHandler:null,_mouseOver:function(t){var u=t.getTarget(),v=m.byClass(u,'item');v&&this._setActiveItem(v);},_mouseLeave:function(t){this._setActiveItem(null);},_clearTimeouts:function(){this._showTimeout&&clearTimeout(this._showTimeout);this._showTimeout=null;this._hideTimeout&&clearTimeout(this._hideTimeout);this._hideTimeout=null;},_checkAlreadyShowing:function(){var t=this.getActiveID();if(!t&&!this._showingID)this._alreadyShowing=false;},_hide:function(){if(this._showingDialog){this._showingDialog.enableBehavior(l);this._showingDialog.hide();this._showingDialog=null;this._showingID=null;}this._checkAlreadyShowing();},_show:function(){this._alreadyShowing=true;var t=this.getActiveID(),u=false;if(this._handlers[t]){u=true;k.applyWithGuard(this._handlers[t],{},[t,this]);}else if(this._defaultHandler){u=true;k.applyWithGuard(this._defaultHandler,{},[t,this]);}if(u&&this._showingID!=this.getActiveID())q(this._activeItem);},_setActiveItem:function(t){if(t!=this._activeItem){this._clearTimeouts();this._activeItem&&r(this._activeItem);this._activeItem=null;var u=t?0:100;this._hideTimeout=o(function(){if(this.getActiveID()!=this._showingID)this._hide();}.bind(this),u);if(t){var v=this._orderedList.getUserForNode(t);this._activeItem=t;var w=u+(this._alreadyShowing?75:500);this._showTimeout=o(function(){this._show();}.bind(this),w);this.inform('hover',v);}else this.inform('leave');this._checkAlreadyShowing();}},register:function(t,u){if(!this._handlers[t]){this._handlers[t]=u;return {unregister:function(){if(t==this._showingID)this._hide();delete this._handlers[t];var v=this._orderedList.getAllNodes(),w=v[t];w&&r(w);}.bind(this)};}},registerDefault:function(t){this._defaultHandler=t;},getActiveID:function(){var t=this._activeItem&&this._orderedList.getUserForNode(this._activeItem);return t||null;},showHovercard:function(t,u){if(t==this.getActiveID()&&t!=this._showingID){this._clearTimeouts();r(this._activeItem);this._hide();this._showingDialog=u;this._showingID=t;var v=u.subscribe('mouseenter',this._setActiveItem.bind(this,this._activeItem)),w=u.subscribe('mouseleave',function(){v.unsubscribe();this._setActiveItem(null);}.bind(this)),x=u.subscribe('hide',function(){v.unsubscribe();w.unsubscribe();x.unsubscribe();});u.setContext(this._activeItem);u.setFixed(true);u.setPosition('left');u.show();u.updatePosition();}}});e.exports=s;});
__d("ChatQuietLinks",["event-extensions","DOM","DOMQuery","UserAgent","DataStore","Parent"],function(a,b,c,d,e,f){b('event-extensions');var g=b('DOM'),h=b('DOMQuery'),i=b('UserAgent'),j=b('DataStore'),k=b('Parent'),l={},m={silenceLinks:function(q){n(q,this.removeEmptyHrefs.bind(this));},nukeLinks:function(q){n(q,this.removeAllHrefs.bind(this));},removeEmptyHrefs:function(q){o(q,function(r){return !r||r==='#';});},removeAllHrefs:function(q){o(q);}};function n(q,r){var s=!!i.chrome(),t=!!i.chrome()||i.ie()>=9||i.firefox()>=4;if(l[g.getID(q)])return;l[g.getID(q)]=true;if(!t)return;if(!s){r&&r(q);return;}Event.listen(q,'mouseover',function u(v){var w=k.byTag(v.getTarget(),'a');if(w){var x=w.getAttribute('href');if(p(x)){j.set(w,'stashedHref',w.getAttribute('href'));w.removeAttribute('href');}}});Event.listen(q,'mouseout',function u(v){var w=k.byTag(v.getTarget(),'a'),x=w&&j.remove(w,'stashedHref');if(p(x))w.setAttribute('href',x);});Event.listen(q,'mousedown',function(u){if(!u.isDefaultRequested())return true;var v=k.byTag(u.getTarget(),'a'),w=v&&j.get(v,'stashedHref');if(p(w))v.setAttribute('href',w);});}function o(q,r){var s=g.scry(q,'a');if(r)s=s.filter(function(t){return r(t.getAttribute('href'));});s.forEach(function(t){t.removeAttribute('href');t.setAttribute('tabindex',0);});}function p(q){return q&&q!=='#';}e.exports=m;});
__d("OrderedFriendsList",["array-extensions","Arbiter","createArrayFrom","ShortProfiles","copyProperties","OrderedFriendsListInitialData"],function(a,b,c,d,e,f){b('array-extensions');var g=b('Arbiter'),h=b('createArrayFrom'),i=b('ShortProfiles'),j=b('copyProperties'),k=[],l={},m=j(new g(),{contains:function(n){return n in l;},compare:function(n,o){var p=m.getRank(n),q=m.getRank(o);if(p!==q)return p-q;var r=i.getNow(n),s=i.getNow(o),t=((r||{}).name||'~').toLowerCase(),u=((s||{}).name||'~').toLowerCase();if(t!==u)return t<u?-1:1;return 0;},getList:function(){var n=h(k);n=n.filter(function(o){var p=window.ShortProfiles&&i.getNow(o);return !p||p.type=="friend";});return n;},getRank:function(n){return n in l?l[n]:k.length;},isReady:function(){return true;}});(function(){var n=c('OrderedFriendsListInitialData');k=n.list.length?n.list:[];k.forEach(function(o,p){l[o]=p;});m.inform('initialized',{},g.BEHAVIOR_PERSISTENT);})();e.exports=a.OrderedFriendsList||m;});
__d("ChatOrderedList",["event-extensions","Animation","Arbiter","ArbiterMixin","AvailableList","AvailableListConstants","Chat","ChatConfig","ChatOrderedListHover","ChatQuietLinks","ChatVisibility","Class","CSS","DataStore","Dialog","DOM","HTML","JSLogger","OrderedFriendsList","Parent","PresencePrivacy","ShortProfiles","Tooltip","URI","Vector","XHPTemplate","copyProperties","createObjectFrom","debounceAcrossTransitions","goURI","tx","ChannelImplementation"],function(a,b,c,d,e,f){b('event-extensions');var g=b('Animation'),h=b('Arbiter'),i=b('ArbiterMixin'),j=b('AvailableList'),k=b('AvailableListConstants'),l=b('Chat'),m=b('ChatConfig'),n=b('ChatOrderedListHover'),o=b('ChatQuietLinks'),p=b('ChatVisibility'),q=b('Class'),r=b('CSS'),s=b('DataStore'),t=b('Dialog'),u=b('DOM'),v=b('HTML'),w=b('JSLogger'),x=b('OrderedFriendsList'),y=b('Parent'),z=b('PresencePrivacy'),aa=b('ShortProfiles'),ba=b('Tooltip'),ca=b('URI'),da=b('Vector'),ea=b('XHPTemplate'),fa=b('copyProperties'),ga=b('createObjectFrom'),ha=b('debounceAcrossTransitions'),ia=b('goURI'),ja=b('tx'),ka=c('ChannelImplementation').instance;function la(qa,ra,sa,ta){this._root=qa;this._items={};this._isVisible=false;this._excludedIds={};this._numTopFriends=5;this._hasRendered=false;this._preventRendering=false;this._hoverController=null;this._template=ra;this._messageTemplate=sa;this._contextualDialog=ta;Event.listen(this._root,'click',this._onClick.bind(this));Event.listen(this._root,'mouseenter',this._mouseEnter.bind(this));Event.listen(this._root,'mouseleave',this._mouseLeave.bind(this));j.subscribe(k.ON_AVAILABILITY_CHANGED,this.update.shield(this));z.subscribe('privacy-changed',this.update.shield(this));ka.subscribe([ka.CONNECTED,ka.RECONNECTING,ka.SHUTDOWN,ka.MUTE_WARNING,ka.UNMUTE_WARNING],this.update.shield(this));this.inform('initialized',this,h.BEHAVIOR_PERSISTENT);this.render();h.subscribe(w.DUMP_EVENT,function(ua,va){va.chat_lists=va.chat_lists||{sorted_list:this.getSortedList(),ordered_list:x.getList(),available_list:la.getAvailableList(this._excludedIds),excluded_list:this._excludedIds};}.bind(this));}function ma(qa,ra){var sa=na(qa,ra);if(sa!==0)return sa;var ta=oa(qa,ra);if(ta!==0)return ta;return x.compare(qa,ra);}function na(qa,ra){var sa=z.allows(qa),ta=z.allows(ra);if(sa!==ta)return sa?-1:1;return 0;}function oa(qa,ra){var sa=aa.getNow(qa),ta=aa.getNow(ra),ua=((sa||{}).name||'~').toLowerCase(),va=((ta||{}).name||'~').toLowerCase();if(ua!==va)return ua<va?-1:1;return 0;}function pa(qa,ra){var sa=j.get(qa)===k.MOBILE,ta=j.get(ra)===k.MOBILE;if(sa!==ta)return ta?-1:1;return oa(qa,ra);}fa(la,{getSortedList:function(qa,ra){var sa=x.getList().filter(function(ib){return !(ib in qa);});sa=sa.filter(function(ib){return z.getFriendVisibility(ib)!==z.BLACKLISTED;});var ta=[],ua=p.isOnline();if(ua){if(z.getOnlinePolicy()===z.ONLINE_TO_WHITELIST){var va=sa,wa={},xa,ya;sa=[];for(xa=0;xa<va.length;++xa){ya=va[xa];if(z.allows(ya)){wa[ya]=true;sa.push(ya);}}var za=z.getWhitelist();for(xa=0;xa<za.length;++xa){ya=za[xa];if(!(ya in wa))sa.push(ya);}for(xa=0;xa<va.length;++xa){ya=va[xa];if(!z.allows(ya))sa.push(ya);}}var ab=m.get('ordered_list.top_friends',0),bb=m.get('ordered_list.available_target',0),cb=Math.floor(ra*bb),db=[];for(var xa=0,eb=sa.length;xa<eb&&cb>0;xa++){var ya=sa[xa],fb=j.get(ya),gb=fb===k.ACTIVE;if(m.get('chat_sidebar_mobile_available'))gb=gb||(fb===k.MOBILE);if(gb||xa<ab){ta.push(ya);gb&&cb--;}else db.push(ya);}if(xa<eb)Array.prototype.push.apply(db,sa.slice(xa));if(ta.length<ra)Array.prototype.push.apply(ta,db);}else Array.prototype.push.apply(ta,sa);ta=ta.slice(0,ra);if(ta.length===ra){var hb=la.getAvailableList(ta.concat(qa)).length;hb&&ta.splice(-1);}ta.sort(ma);return ta;},getAvailableList:function(qa){return j.getOnlineIDs().filter(function(ra){return !(ra in qa);});}});fa(la.prototype,i,{getAllNodes:function(){var qa={},ra=u.scry(this._root,'li.item');for(var sa=0;sa<ra.length;sa++){var ta=s.get(ra[sa],'id');if(ta)qa[ta]=ra[sa];}return qa;},getShowingUsers:function(){return u.scry(this._root,'li.item').map(function(qa){return s.get(qa,'id');});},getUserForNode:function(qa){return s.get(qa,'id');},getHoverController:function(){if(!this._hoverController)this._hoverController=new n(this,this._contextualDialog);return this._hoverController;},_getListItem:function(qa){var ra=this._items[qa];if(ra){var sa=j.get(qa),ta=z.allows(qa)&&!ka.disconnected(),ua={active:false,mobile:false,greenphone:false};ua.active=sa===k.ACTIVE;if(m.get('sidebar_mobile_icon_green')){ua.greenphone=sa===k.MOBILE;}else ua.mobile=sa===k.MOBILE;for(var va in ua)r.conditionClass(ra,va,ua[va]&&ta);r.conditionClass(ra,'invis',!ta);}return ra;},getRoot:function(){return this._root;},getSortedList:function(){return la.getSortedList(this._excludedIds,this._numTopFriends);},hide:function(){if(!this._isVisible)return;this._isVisible=false;r.hide(this._root);this.inform('hide');},_onClick:function(event){var qa=event.getTarget(),ra=y.byTag(qa,'li');if(ra){if(r.hasClass(ra,'blackbirdWhitelist')){var sa=new ca('/ajax/chat/privacy/settings_dialog.php').addQueryData({ref:'whitelist_separator'});new t().setAsyncURL(sa.toString()).show();event.prevent();return false;}var ta=s.get(ra,'id');if(ta){var ua='ordered_list',va=ra;while(ra.previousSibling){ra=ra.previousSibling;if(r.hasClass(ra,'separator')){if(r.hasClass(ra,'moreOnlineFriends')){ua='more_online_friends';break;}if(r.hasClass(ra,'blackbirdWhitelist')){ua='blackbird_offline_section';break;}}}var wa=[];if(m.get('chat_realtime_coefficient_impressions'))wa=this.getSortedList();aa.get(ta,function(xa){l.openTab(ta,xa.name,'friend',ua,wa);});this.inform('click',{id:ta});}else if(r.hasClass(ra,'separator')&&y.byClass(qa,'inner'))this.scrollTo(ra);return false;}},_mouseEnter:function(){this._preventRendering=true;},_mouseLeave:function(){this._preventRendering=false;},setExcludedIds:function(qa){this._excludedIds=ga(qa||[]);},setNumTopFriends:function(qa){if(qa!==this._numTopFriends){this._numTopFriends=qa;this.render();}},_getOfflineToSectionItems:function(){var qa=u.create('a',{href:'#'},u.tx._("Modifier")),ra=[];ra.push(v('<li class="separator">'+'<div class="outer">'+'<div class="inner">'+'<span class="text">'+u.tx._("Amis non connect\u00e9s")+'</span>'+'<div class="dive"><span class="bar"></span></div>'+'</div>'+'</div>'+'</li>'));ra.push(v('<li class="separator blackbirdWhitelist">'+'<div class="outer">'+'<div class="inner">'+'<div class="subheader">'+'<span class="subheaderText">'+u.tx._("Ces amis ne peuvent pas vous voir dans la discussion instantan\u00e9e. {=link}",{'=link':qa})+'</span>'+'</div>'+'</div>'+'</li>'));return ra;},render:function(){this.render=ha(function(){if(!this._isVisible||(this._preventRendering&&this._hasRendered))return;this._hasRendered=true;var qa=this.getSortedList(),ra=[],sa,ta,ua=z.getVisibility()&&z.getOnlinePolicy()==z.ONLINE_TO_WHITELIST;for(var va=0,wa=qa.length;va<wa;va++){sa=qa[va];if(ua)if(!z.allows(sa)){if(va+2>=qa.length)break;ua=false;var xa=this._getOfflineToSectionItems();ra.push(xa[0]);ra.push(xa[1]);wa-=2;}ta=this._getListItem(sa);if(ta){ra.push(ta);}else this._renderListItem(sa,this.render.bind(this));}var ya=la.getAvailableList(this._excludedIds),za=ga(qa);ya=ya.filter(function(eb){return !(eb in za);});ya.sort(pa);if(ya.length&&ra.length)ra.push(v('<li class="separator moreOnlineFriends">'+'<div class="outer">'+'<div class="inner">'+'<span class="text">'+ja._("{MORE ONLINE FRIENDS} ({=count})",{'MORE ONLINE FRIENDS':"Plus d\u2019amis en ligne",'=count':ya.length})+'</span>'+'<div class="dive"><span class="bar"></span></div>'+'</div>'+'</div>'+'</li>'));for(var ab=0,bb=ya.length;ab<bb;ab++){sa=ya[ab];ta=this._getListItem(sa);if(ta){ra.push(ta);}else this._renderListItem(sa,this.render.bind(this));}if(!qa.length&&!ya.length){var cb=this._messageTemplate.render(),db=ea.getNode(cb,'message');u.setContent(db,"Personne n\u2019est disponible pour discuter.");ra.push(cb);}if(ra.length){u.setContent(this._root,ra);o.nukeLinks(this.getRoot());this.inform('render');}},300,this);this.render();},_renderListItem:function(qa,ra){aa.get(qa,function(sa){if(sa.type==='friend'){var ta=this._template.render(),ua=ea.getNode(ta,'profile-photo');ua.setAttribute('src',sa.thumbSrc);var va=ea.getNode(ta,'name');u.setContent(va,sa.name);var wa=ea.getNode(ta,'anchor');wa.setAttribute('href','/messages/'+qa);var xa=ea.getNode(ta,'timeline_icon');if(xa){var ya=ja._("Aller au journal de {name}",{name:sa.firstName});ba.set(xa,ya,'above','center');Event.listen(xa,'click',function(event){event.kill();ia(sa.uri);});}s.set(ta,'id',qa);this._items[qa]=ta;ra&&ra(ta);}}.bind(this));},show:function(){if(this._isVisible)return;this._isVisible=true;r.show(this._root);this.render();this.inform('show');},isVisible:function(){return this._isVisible;},update:function(){this._hasRendered=false;this.render();},setScrollContainer:function(qa){if(u.contains(qa,this._root))this._scrollContainer=qa;},scrollTo:function(qa){if(!this._scrollContainer)return;var ra=this._scrollContainer.scrollHeight,sa=this._scrollContainer.clientHeight,ta=this._scrollContainer.scrollTop,ua=Math.min(qa.offsetTop,ra-sa);if(ta!==ua){var va=Math.abs(ua-ta)/this._scrollContainer.clientHeight*500;g(this._scrollContainer).to('scrollTop',ua).ease(g.ease.end).duration(va).go();}}});e.exports=la;});
__d("TypingIndicator",["Arbiter","AsyncRequest","AvailableList","AvailableListConstants","ChannelManager","ChannelConnection","ChatConfig","ChatVisibility","copyProperties","Keys","ShortProfiles","TypingDetector","PresencePrivacy"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('AsyncRequest'),i=b('AvailableList'),j=b('AvailableListConstants'),k=b('ChannelManager'),l=b('ChannelConnection'),m=b('ChatConfig'),n=b('ChatVisibility'),o=b('copyProperties'),p=b('Keys'),q=b('ShortProfiles'),r=b('TypingDetector'),s=b('PresencePrivacy');function t(v){if(!n.isOnline())return false;if(v){var w=q.getNow(v);return w&&w.type=="friend"&&s.allows(v);}return true;}function u(v,w,x,y,z){this.userID=v;this.input=w;this.source=x;this.threadID=z;this.remoteState=r.INACTIVE;this.notifyTimer=null;y=y||{};this.notifyDelay=y.notifyDelay||this.notifyDelay;this._typingDetector=new r(w);this._typingDetector.init(y);this._typingDetector.subscribe('change',this._stateChange.bind(this));}o(u.prototype,{notifyDelay:1000,setIgnoreEnter:function(v){var w=v?[p.RETURN]:[];this._typingDetector.setIgnoreKeys(w);},resetState:function(){this.remoteState=u.INACTIVE;this._typingDetector.reset();clearTimeout(this.notifyTimer);this.notifyTimer=null;},_stateChange:function(v,w){if(w!=r.QUITTING){clearTimeout(this.notifyTimer);this.notifyTimer=this._notifyState.shield(this,w).defer(this.notifyDelay,false);}else this._notifyState(w,true);},_notifyState:function(v,w){var x=this.userID,y=t(x);if(y&&v!=this.remoteState){this.remoteState=v;if(l.disconnected())return;var z={typ:v,to:x,source:this.source,thread:this.threadID};new h().setHandler(this._onTypResponse.bind(this,x)).setErrorHandler(bagofholding).setData(z).setURI('/ajax/messaging/typ.php').setAllowCrossPageTransition(true).setOption('asynchronous',!w).send();}},_onTypResponse:function(v,w){var x=w.getPayload()||{};if(x.offline)i.set(v,j.OFFLINE,'typing_response');}});e.exports=u;});
__d("ChatBehavior",["Arbiter","AvailableList","AvailableListConstants","copyProperties","MercuryConstants","ChatSidebarCalloutData"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('AvailableList'),i=b('AvailableListConstants'),j=b('copyProperties'),k=c('MercuryConstants').ChatNotificationConstants,l=c('ChatSidebarCalloutData').isShown,m=h.getWebChatNotification(),n=l,o=j(new g(),{ON_CHANGED:'changed',notifiesUserMessages:function(){return m!==k.NO_USER_MESSAGE_NOTIFICATION;},ignoresRemoteTabRaise:function(){return n;}});function p(){o.inform(o.ON_CHANGED);}h.subscribe(i.ON_CHAT_NOTIFICATION_CHANGED,function(){var q=m,r=h.getWebChatNotification();m=r;if(q!=r)p();});g.subscribe('chat/set_does_page_occlude_tabs',function(q,r){n=!!r;p();});e.exports=o;});
__d("ChatSidebarSheet",["event-extensions","function-extensions","ArbiterMixin","ChannelConnection","ChannelConstants","ChatBehavior","ChatConfig","ChatVisibility","Class","CSS","DOM","JSLogger","PresencePrivacy","copyProperties","tx"],function(a,b,c,d,e,f){b('event-extensions');b('function-extensions');var g=b('ArbiterMixin'),h=b('ChannelConnection'),i=b('ChannelConstants'),j=b('ChatBehavior'),k=b('ChatConfig'),l=b('ChatVisibility'),m=b('Class'),n=b('CSS'),o=b('DOM'),p=b('JSLogger'),q=b('PresencePrivacy'),r=b('copyProperties'),s=b('tx'),t=p.create('sidebar_sheet');function u(x){switch(x){case i.HINT_AUTH:return "Votre session a expir\u00e9. Veuillez vous reconnecter.";case i.HINT_CONN:return s._("{Chat} Facebook n\u2019est pas disponible.",{Chat:"Discussion instantan\u00e9e"});case i.HINT_MAINT:return s._("{Chat} est en cours de maintenance.",{Chat:"Discussion instantan\u00e9e"});default:return s._("{Chat} Facebook n\u2019est pas disponible.",{Chat:"Discussion instantan\u00e9e"});}}function v(x){var y;if(x===null){y="Impossible de se connecter \u00e0 la discussion instantan\u00e9e. V\u00e9rifiez votre connexion Internet.";}else if(x>k.get('warning_countdown_threshold_msec')){var z=o.create('a',{href:'#',className:'fbChatReconnectLink'},"Veuillez r\u00e9essayer");y=o.tx._("Impossible de se connecter \u00e0 la discussion instantan\u00e9e. {try-again-link}",{'try-again-link':z});}else if(x>1000){y=s._("Impossible de se connecter \u00e0 la discussion instantan\u00e9e. Reconnexion dans {seconds} secondes...",{seconds:Math.floor(x/1000)});}else y="Impossible de se connecter \u00e0 la discussion instantan\u00e9e. Reconnexion...";return y;}function w(x){this._root=x;this._message=o.find(x,'div.fbChatSidebarMessage div.message');h.subscribe([h.CONNECTED,h.SHUTDOWN,h.RECONNECTING],this._handleConnectionChange.bind(this));h.subscribe([h.MUTE_WARNING,h.UNMUTE_WARNING],this._render.bind(this));q.subscribe('privacy-user-presence-changed',this._render.bind(this));j.subscribe(j.ON_CHANGED,this._render.bind(this));this._render();}r(w.prototype,g,{_channelStatus:null,_channelData:null,_handleConnectionChange:function(x,y){this._channelStatus=x;this._channelData=y;this._render();},_showWarningTimeout:null,_warningMsgEventListener:null,_renderChannelDisconnect:function(){if(this._channelStatus===h.SHUTDOWN){return o.setContent(this._message,u(this._channelData));}else if(this._channelStatus===h.RECONNECTING){var x=this._channelData;o.setContent(this._message,v(x));if(x>1000){if(x>k.get('warning_countdown_threshold_msec'))this._warningMsgEventListener=Event.listen(this._message,'click',function(event){if(n.hasClass(event.getTarget(),'fbChatReconnectLink')){h.reconnect();return false;}});this._showWarningTimeout=setTimeout(this._handleConnectionChange.bind(this,h.RECONNECTING,x-1000),1000,false);}}},_goOnlineEventListener:null,_renderOffline:function(){var x='fbChatGoOnlineLink',y="Passer en ligne",z=o.create('a',{href:'#',className:x},y),aa=o.tx._("{=Go online} pour voir qui est en ligne pour discuter.",{'=Go online':z});o.setContent(this._message,aa);this._goOnlineEventListener=Event.listen(this._message,'click',function(event){if(n.hasClass(event.getTarget(),x)){t.log('sidebar_go_online');l.goOnline();return false;}});},_clear:function(){if(this._showWarningTimeout){clearTimeout(this._showWarningTimeout);this._showWarningTimeout=null;}if(this._warningMsgEventListener){this._warningMsgEventListener.remove();this._warningMsgEventListener=null;}if(this._goOnlineEventListener){this._goOnlineEventListener.remove();this._goOnlineEventListener=null;}n.removeClass(this._root,'offline');n.removeClass(this._root,'error');n.removeClass(this._root,'notice');o.empty(this._message);},_render:function(){this._clear();if(!l.isOnline()){n.addClass(this._root,'offline');this._renderOffline();}else if(h.disconnected()){n.addClass(this._root,'error');this._renderChannelDisconnect();}else if(!j.notifiesUserMessages()){n.addClass(this._root,'notice');o.setContent(this._message,"Les alertes sont d\u00e9sactiv\u00e9es durant l\u2019utilisation d\u2019un autre client de discussion instantan\u00e9e.");}this.inform('updated');}});e.exports=w;});
__d("ChatTypeaheadBehavior",["Chat","CSS","DOM","Rect","copyProperties","tx"],function(a,b,c,d,e,f){var g=b('Chat'),h=b('CSS'),i=b('DOM'),j=b('Rect'),k=b('copyProperties'),l=b('tx');function m(n){this._typeahead=n;}k(m.prototype,{_subscriptions:null,enable:function(){var n=this._typeahead;this._subscriptions=[n.subscribe('focus',function(){n.getData().refreshData();}),n.subscribe('blur',function(o){n.getCore().reset();}),n.subscribe('respond',function(o,p){if(p.value&&p.value===n.getCore().getValue()){if(!p.results.length){var q=i.create('div',{className:'noResults'},"Ami(e) non trouv\u00e9(e)");i.setContent(n.getView().getElement(),q);}h.addClass(n.getElement(),'hasValue');}}),n.subscribe('reset',function(){h.removeClass(n.getElement(),'hasValue');}),n.subscribe('select',function(o,p){g.openTab(p.selected.uid,p.selected.text,p.selected.type,'typeahead');}),n.subscribe('highlight',function(o,p){if(p.index>=0){var q=n.getView().getItems()[p.index];if(q){var r=new j(q),s=q.offsetParent,t=r.boundWithin(new j(s)).getPositionVector();r.getPositionVector().sub(t).scrollElementBy(s);}}})];},disable:function(){this._subscriptions.forEach(function(n){this._typeahead.unsubscribe(n);}.bind(this));this._subscriptions=null;}});e.exports=m;});
__d("ChatTypeaheadCore",["event-extensions","function-extensions","Class","Keys","TypeaheadCore","copyProperties"],function(a,b,c,d,e,f){b('event-extensions');b('function-extensions');var g=b('Class'),h=b('Keys'),i=b('TypeaheadCore'),j=b('copyProperties');function k(l){this.parent.construct(this,l);}g.extend(k,i);j(k.prototype,{handleTab:bagofholding,keydown:function(event){var l=Event.getKeyCode(event);if(l===h.ESC){this.reset.shield(this).defer();return event.kill();}return this.parent.keydown(event);}});e.exports=k;});
__d("ChatTypeaheadDataSource",["Arbiter","AvailableListConstants","Class","DataSource","Env","JSLogger","OrderedFriendsList","Run","ShortProfiles","copyProperties"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('AvailableListConstants'),i=b('Class'),j=b('DataSource'),k=b('Env'),l=b('JSLogger'),m=b('OrderedFriendsList'),n=b('Run'),o=b('ShortProfiles'),p=b('copyProperties');function q(r){this.parent.construct(this,r);this.persistOnRefresh=r.persistOnRefresh!==false;this.showOfflineUsers=!!r.showOfflineUsers;this._jslog=l.create('chat_typeahead');this._jslog.log('created');}i.extend(q,j);p(q.prototype,{init:function(){this._jslog.log('init');this.parent.init();var r=g.subscribe(h.ON_AVAILABILITY_CHANGED,this._update.shield(this));this._update();if(!this.persistOnRefresh)n.onLeave(function(){r.unsubscribe();});},bootstrap:function(){this._jslog.log('bootstrap');this.parent.bootstrap();if(this.showOfflineUsers){this._jslog.log('show_offline_users');this._jslog.log('ensured_short_profiles');if(o.hasAll()){this._update();}else{this._jslog.log('fetch_all_short_profiles');o.fetchAll();this.inform('activity',{activity:true});var r=o.subscribe('updated',function(){this.inform('activity',{activity:false});this._update();}.bind(this));if(!this.persistOnRefresh)n.onLeave(function(){o.unsubscribe(r);});}}},_update:function(){d(['AvailableList'],function(r){var s=this.value;this.dirty();var t=o.getCachedProfileIDs(),u=t.filter(function(w){var x=o.getNow(w);return x.type==='friend';});u.sort(m.compare);var v=[];u.forEach(function(w){if(w==k.user)return;var x=r.get(w);if(!this.showOfflineUsers&&x!==r.ACTIVE)return;var y=o.getNow(w);v.push({uid:w,text:y.name,tokens:y.additionalName,localized_text:y.name,additional_text:y.additionalName,photo:y.thumbSrc,availability:x,type:y.type});}.bind(this));if(v.length)this.addEntries(v);this.value=s;if(s)this.respond(s,this.buildUids(s,[],this._exclusions),true);}.bind(this));},refreshData:function(){d(['AvailableList'],function(r){r.update();}.bind(this));}});e.exports=q;});
__d("ChatTypeaheadRenderer",["AvailableListConstants","DOM","PresencePrivacy"],function(a,b,c,d,e,f){var g=b('AvailableListConstants'),h=b('DOM'),i=b('PresencePrivacy');function j(k,l){var m='offline';switch(k.availability){case g.ACTIVE:m='active';break;case g.IDLE:m='idle';break;case g.MOBILE:m='mobile';break;}if(!i.allows(k.uid))m='invis';var n=[];if(k.photo)n.push(h.create('img',{alt:'',src:k.photo}));if(k.text)n.push(h.create('span',{className:'text'},[k.text]));n.push(h.create('i',{className:m}));return h.create('li',{className:'clearfix '+m},n);}e.exports=j;});
__d("ChatSidebar",["JSXDOM","event-extensions","Arbiter","ArbiterMixin","AsyncRequest","ChatConfig","ChatHovercard","ChatOptions","ChatQuietLinks","ChatSidebarSheet","CSS","DOM","FBDesktopPlugin","JSLogger","OrderedFriendsList","PresencePrivacy","ScrollableArea","Style","Vector","ViewportBounds","copyProperties","createArrayFrom","debounce","ChatOrderedList","ChatTypeaheadBehavior","ChatTypeaheadCore","ChatTypeaheadDataSource","ChatTypeaheadRenderer","Typeahead"],function(a,b,c,d,e,f){var g=b('JSXDOM');b('event-extensions');var h=b('Arbiter'),i=b('ArbiterMixin'),j=b('AsyncRequest'),k=b('ChatConfig'),l=b('ChatHovercard'),m=b('ChatOptions'),n=b('ChatQuietLinks'),o=b('ChatSidebarSheet'),p=b('CSS'),q=b('DOM'),r=b('FBDesktopPlugin'),s=b('JSLogger'),t=b('OrderedFriendsList'),u=b('PresencePrivacy'),v=b('ScrollableArea'),w=b('Style'),x=b('Vector'),y=b('ViewportBounds'),z=b('copyProperties'),aa=b('createArrayFrom'),ba=b('debounce');b('ChatOrderedList');b('ChatTypeaheadBehavior');b('ChatTypeaheadCore');b('ChatTypeaheadDataSource');b('ChatTypeaheadRenderer');b('Typeahead');var ca,da=false,ea=false,fa=false,ga=false,ha=false,ia=false,ja,ka,la,ma,na=null,oa=s.create('chat_sidebar'),pa=32;function qa(){p.removeClass(document.documentElement,'sidebarMode');if(!ha||!wa.isVisible())return;ga=false;na=null;p.hide(ka);ja.hide();la.getCore().reset();oa.rate('sidebar_hide',ha);wa.inform('sidebar/hide',wa);h.inform('sidebar/hide',wa);h.inform('reflow');}function ra(){var xa=wa.shouldShowSidebar();p.conditionClass(document.documentElement,'sidebarCapable',xa);if(wa.isEnabled()&&xa){sa();var ya=ma.y;aa(ka.childNodes).forEach(function(za){if(za!==ca)ya-=x.getElementDimensions(za).y;});w.set(ca,'height',ya+'px');this._maxItems=Math.floor((ya-8)/pa);ja.setNumTopFriends(this._maxItems);la.getData().setMaxResults(this._maxItems);wa.inform('sidebar/resized',wa);h.inform('sidebar/resized',wa);h.inform('reflow');}else qa();if(!ha){va();ha=true;}na=null;}function sa(){if(wa.isVisible())return;ga=true;na=null;p.show(ka);p.addClass(document.documentElement,'sidebarMode');ja.show();oa.rate('sidebar_show',ha);wa.inform('sidebar/show',wa);h.inform('sidebar/show',wa);}function ta(){m.setSetting('sidebar_mode',wa.isEnabled(),'sidebar');new j('/ajax/chat/settings.php').setHandler(bagofholding).setErrorHandler(bagofholding).setData({sidebar_mode:wa.isEnabled()}).setAllowCrossPageTransition(true).send();}function ua(){return t.getList().length<=k.get('sidebar.min_friends');}function va(){var xa=true;if(!wa.isEnabled()){oa.log('state_not_enabled');xa=false;}if(!wa.isViewportCapable()){oa.log('state_not_shown_viewport');xa=false;}if(fa){oa.log('state_not_shown_hidden');xa=false;}if(ua()){oa.log('state_not_shown_num_friends');xa=false;}if(r.shouldSuppressSidebar()){oa.log('state_not_shown_fbdesktop');xa=false;}oa.log(xa?'state_shown':'state_not_shown');}var wa={init:function(xa,ya,za){wa.init=bagofholding;ia=true;ka=xa;ja=ya;la=za;ca=q.find(xa,'div.fbChatSidebarBody');if(k.get('chat_sidebar_hovercards'))new l(ya);var ab=new o(xa);ab.subscribe('updated',ra);h.subscribe('sidebar/invalidate',ra);ya.setScrollContainer(q.find(ca,'div.uiScrollableAreaWrap'));ya.subscribe(['render','show','hide'],ba(function(){var bb=ya.getRoot(),cb=v.getInstance(bb);cb&&cb.adjustGripper();}));Event.listen(window,'resize',ra);h.subscribe('chat/option-changed',function(bb,cb){if(cb.name=="sidebar_mode"){ea=!!m.getSetting('sidebar_mode');ra();}});za.subscribe(['respond','reset'],function(bb,cb){if(ga)if(cb&&cb.value&&cb.value===za.getCore().getValue()&&za.getView().isVisible()){ja.hide();}else ja.show();});za.getData().subscribe('beforeQuery',ra);h.subscribe('buddylist-nub/initialized',function(bb,cb){Event.listen(cb.getButton(),'click',function(event){wa.enable();return !wa.shouldShowSidebar();});});ea=!!m.getSetting('sidebar_mode');oa.log('sidebar_vis_init');u.subscribe('privacy-user-presence-changed',ra);ra();y.addRight(wa.getVisibleWidth);wa.inform('sidebar/initialized',wa,h.BEHAVIOR_PERSISTENT);h.inform('sidebar/initialized',wa,h.BEHAVIOR_PERSISTENT);},isInitialized:function(){return ha;},disable:function(){if(!wa.isEnabled())return;ea=false;ta();qa();},enable:function(){if(wa.isEnabled())return;ea=true;ta();ra();!function(){if(wa.isVisible())la.getCore().getElement().focus();}.defer();},ensureLoaded:function(){if(ia)return;d(['UIPagelet'],function(xa){var ya=g.div({id:"pagelet_sidebar"});q.appendContent(document.body,ya);xa.loadFromEndpoint('SidebarPagelet','pagelet_sidebar');});ia=true;},hide:function(){if(fa)return;fa=true;qa();},unhide:function(){if(!fa)return;fa=false;ra();},getBody:function(){return ca;},getRoot:function(){return ka;},getVisibleWidth:function(){if(!ga||!ka)return 0;if(na===null)na=ka.offsetWidth;return na;},isEnabled:function(){return ea;},isViewportCapable:function(){ma=x.getViewportDimensions();var xa=k.get('sidebar.minimum_width');if(da)xa=k.get('sidebar.minimum_width_wide_content');return ma.x>xa;},shouldShowSidebar:function(){return wa.isViewportCapable()&&!fa&&!ua()&&!r.shouldSuppressSidebar();},isVisible:function(){return ga;},resize:ra,toggle:function(){wa.isEnabled()?wa.disable():wa.enable();},setHasWideContent:function(xa){if(da!=xa){da=xa;ra();}}};z(wa,i);e.exports=wa;});
__d("VideoCallingTour",["event-extensions","Arbiter","ArbiterMixin","Chat","ChatSidebar","ChatVisibility","CSS","DOM","PresencePrivacy","Run","Toggler","Vector","copyProperties"],function(a,b,c,d,e,f){b('event-extensions');var g=b('Arbiter'),h=b('ArbiterMixin'),i=b('Chat'),j=b('ChatSidebar'),k=b('ChatVisibility'),l=b('CSS'),m=b('DOM'),n=b('PresencePrivacy'),o=b('Run'),p=b('Toggler'),q=b('Vector'),r=b('copyProperties'),s,t,u,v,w=[],x=function(){};function y(){if(j.isVisible()){z();}else if(u)aa();}function z(){s.setContext(t.getBody());ba();s.show();ca();}function aa(){if(!v)v=p.createInstance(u.getRoot());var fa=m.scry(u.getRoot(),'div.fbNubFlyout')[0];if(fa){s.setContext(fa);ba();s.show();ca();}}function ba(){var fa=q.getElementDimensions(s.getContext()).y;s.setOffsetY(fa*.6);s.updatePosition();}function ca(){if(u)w.push(u.subscribe('hide',function(){da();if(!j.isVisible())s.hide();}),u.subscribe('show',function(){s.show();}),u.subscribe('resize',function(){ba();s.updatePosition();}));w.push(g.subscribe('sidebar/show',z),g.subscribe('sidebar/hide',aa),g.subscribe('sidebar/resized',ba));}function da(){if(v){v.setSticky(false);v=null;}}function ea(){while(w.length)w.pop().unsubscribe();if(u)da();s.hide();l.show('fbVideoCallingGetStarted');}r(x,h,{start:function(fa){s=fa;l.hide('fbVideoCallingGetStarted');k.goOnline(function(){w.push(n.subscribe('privacy-user-presence-changed',ea));o.onLeave(ea);i.openBuddyList();var ga=null;w.push(j.subscribe('sidebar/initialized',function(ha,ia){t=ia;clearTimeout(ga);ga=y.defer();}),x.subscribe('videocallingtour/end',ea));w.push(g.subscribe('buddylist-nub/initialized',function(ha,ia){u=ia;clearTimeout(ga);ga=y.defer();}));});x.inform('videocallingtour/start');}});e.exports=x;});
__d("ModuleDependencies",["getObjectValues"],function(a,b,c,d,e,f){var g=b('getObjectValues');function h(l,m,n){var o=a.require.__debug.modules[n],p=a.require.__debug.deps;if(m[n])return;m[n]=true;if(!o){p[n]&&(l[n]=true);return;}if(!o.dependencies||!o.dependencies.length){if(o.waiting)l[n]=true;return;}o.dependencies.forEach(function(q){h(l,m,q);});}function i(l){if(a.require.__debug){var m={};h(m,{},l);var n=Object.keys(m);n.sort();return n;}return null;}function j(){var l={loading:{},missing:[]};if(!a.require.__debug)return l;var m={},n=a.require.__debug.modules,o=a.require.__debug.deps;for(var p in n){var q=n[p];if(q.waiting){var r={};h(r,{},q.id);delete r[q.id];l.loading[q.id]=Object.keys(r);l.loading[q.id].sort();l.loading[q.id].forEach(function(s){if(!(s in n)&&o[s])m[s]=1;});}}l.missing=Object.keys(m);l.missing.sort();return l;}var k={getMissing:i,getNotLoadedModules:j};e.exports=k;});
__d("legacy:ChatSidebar",["ModuleDependencies","JSLogger"],function(a,b,c,d){d(['ChatSidebar'],function(i){a.ChatSidebar=i;});var e=b('ModuleDependencies'),f=b('JSLogger'),g=f.create('chat_sidebar_load');function h(i){setTimeout(function(){if(!a.ChatSidebar){var j=e.getMissing('ChatSidebar');g.warn('require_'+i,{missing:j});}if(!a.ChatSidebar||!a.ChatSidebar.isInitialized())g.warn('init_'+i,{missing:j});},i);}h(5000);h(10000);h(15000);h(30000);h(60000);},3);
__d("legacy:ChatTypeaheadBehavior",["ChatTypeaheadBehavior"],function(a,b,c,d){var e=b('ChatTypeaheadBehavior');if(!a.TypeaheadBehaviors)a.TypeaheadBehaviors={};a.TypeaheadBehaviors.chatTypeahead=function(f){f.enableBehavior(e);};},3);
__d("RangedCallbackManager",["CallbackManagerController","copyProperties","createObjectFrom"],function(a,b,c,d,e,f){var g=b('CallbackManagerController'),h=b('copyProperties'),i=b('createObjectFrom'),j=function(k,l,m){this._resources=[];this._reachedEndOfArray=false;this._existingIDs={};this._controller=new g(this._constructCallbackArg.bind(this));this._getValueHandler=k;this._compareValuesHandler=l;this._skipOnStrictHandler=m;};h(j.prototype,{executeOrEnqueue:function(k,l,m,n){return this._controller.executeOrEnqueue({start:k,limit:l},m,{strict:!!n});},unsubscribe:function(k){this._controller.unsubscribe(k);},getUnavailableResources:function(k){var l=this._controller.getRequest(k),m=[];if(l&&!this._reachedEndOfArray){var n=l.request,o=this._filterForStrictResults(l.options),p=n.start+n.limit;for(var q=o.length;q<p;q++)m.push(q);}return m;},addResources:function(k){k.forEach(function(l){if(!this._existingIDs[l]){this._existingIDs[l]=true;this._resources.push(l);}}.bind(this));this.resortResources();this._controller.runPossibleCallbacks();},addResourcesWithoutSorting:function(k,l){var m=this._resources.slice(0,l);m=m.concat(k);m=m.concat(this._resources.slice(l));this._resources=m;h(this._existingIDs,i(k,true));this._controller.runPossibleCallbacks();},removeResources:function(k){k.forEach(function(l){if(this._existingIDs[l]){this._existingIDs[l]=false;this._resources.remove(l);}}.bind(this));},removeAllResources:function(){this._resources=[];this._existingIDs={};},resortResources:function(){this._resources=this._resources.sort(function(k,l){return this._compareValuesHandler(this._getValueHandler(k),this._getValueHandler(l));}.bind(this));},setReachedEndOfArray:function(){if(!this._reachedEndOfArray){this._reachedEndOfArray=true;this._controller.runPossibleCallbacks();}},hasReachedEndOfArray:function(){return this._reachedEndOfArray;},hasResource:function(k){return this._existingIDs[k];},getResourceAtIndex:function(k){return this._resources[k];},getAllResources:function(){return this._resources.concat();},getCurrentArraySize:function(){return this._resources.length;},_filterForStrictResults:function(k){var l=this._resources;if(k&&k.strict&&this._skipOnStrictHandler)l=l.filter(this._skipOnStrictHandler);return l;},_constructCallbackArg:function(k,l){var m=this._filterForStrictResults(l);if(!this._reachedEndOfArray&&k.start+k.limit>m.length){return false;}else return m.slice(k.start,k.start+k.limit);},getElementsUntil:function(k){var l=[];for(var m=0;m<this._resources.length;m++){var n=this._getValueHandler(this._resources[m]);if(this._compareValuesHandler(n,k)>0)break;l.push(this._resources[m]);}return l;}});e.exports=j;});
__d("TimestampConverter",["JSLogger"],function(a,b,c,d,e,f){var g=b('JSLogger'),h=g.create('timestamp_converter');function i(k){return (typeof(k)=='string')&&k.length>6;}var j={convertActionIDToTimestamp:function(k){if(i(k)){var l=k.slice(0,-6);return parseInt(l,10);}},maxValidActionID:function(k,l){if(!i(k))return l;if(!i(l))return k;return this.isGreaterThan(k,l)?k:l;},isGreaterThan:function(k,l){if(!i(k)||!i(l))return false;return this.convertActionIDToTimestamp(k)>this.convertActionIDToTimestamp(l);}};e.exports=j;});
__d("MercuryFolders",["array-extensions","MercuryConstants"],function(a,b,c,d,e,f){b('array-extensions');var g=c('MercuryConstants'),h=[g.MessagingTag.INBOX,g.MessagingTag.OTHER,g.MessagingTag.ACTION_ARCHIVED,g.MessagingTag.SPAM],i={getSupportedFolders:function(){return h.concat();},isSupportedFolder:function(j){return h.contains(j);},getFromMeta:function(j){var k=j.folder;if(j.is_archived)k=g.MessagingTag.ACTION_ARCHIVED;return k;}};e.exports=i;});
__d("MercuryIDs",[],function(a,b,c,d,e,f){function g(h){return typeof h==='string'&&h.indexOf(':')!==-1;}e.exports={isValid:function(h){if(!h)return false;return g(h);},tokenize:function(h){if(!this.isValid(h))throw 'bad_id_format';var i=h.indexOf(':');return {type:h.substr(0,i),value:h.substr(i+1)};}};});
__d("MercuryAssert",["MercuryIDs"],function(a,b,c,d,e,f){var g=b('MercuryIDs');e.exports={isParticipantID:function(h){if(!g.isValid(h))throw 'bad_participant_id';},allParticipantIDs:function(h){h.forEach(this.isParticipantID);},isUserParticipantID:function(h){var i=g.tokenize(h);if(i.type!='fbid')throw 'bad_user_id';},isEmailParticipantID:function(h){var i=g.tokenize(h);if(i.type!='email')throw 'bad_email_id';},allThreadID:function(h){h.forEach(this.isThreadID);},isThreadID:function(h){if(!g.isValid(h))throw 'bad_thread_id';}};});
__d("MercuryAttachment",["startsWith","MercuryConstants"],function(a,b,c,d,e,f){var g=b('startsWith'),h=c('MercuryConstants'),i={getAttachIconClass:function(j){switch(j){case h.MercuryAttachmentContentType.PHOTO:return 'MercuryPhotoIcon';case h.MercuryAttachmentContentType.VIDEO:return 'MercuryVideoIcon';case h.MercuryAttachmentContentType.MUSIC:return 'MercuryMusicIcon';case h.MercuryAttachmentContentType.TEXT:return 'MercuryTextIcon';case h.MercuryAttachmentContentType.MSWORD:return 'MercuryMSWordIcon';case h.MercuryAttachmentContentType.MSXLS:return 'MercuryMSXLSIcon';case h.MercuryAttachmentContentType.MSPPT:return 'MercuryMSPPTIcon';}return 'MercuryDefaultIcon';},getAttachIconClassByMime:function(j){if(g(j,'image')){return 'MercuryPhotoIcon';}else if(g(j,'video')){return 'MercuryVideoIcon';}else if(g(j,'audio')){return 'MercuryMusicIcon';}else if(g(j,'text/plain')){return 'MercuryTextIcon';}else return 'MercuryDefaultIcon';},getAttachTypeByMime:function(j){if(g(j,'image')){return h.MercuryAttachmentContentType.PHOTO;}else if(g(j,'video')){return h.MercuryAttachmentContentType.VIDEO;}else if(g(j,'audio')){return h.MercuryAttachmentContentType.MUSIC;}else if(g(j,'text/plain')){return h.MercuryAttachmentContentType.TEXT;}else return h.MercuryAttachmentContentType.UNKNOWN;},convertRaw:function(j){var k=[];for(var l=0;l<j.length;l++){var m=j[l];if(m.filename){var n={};n.attach_type=h.MercuryAttachmentType.FILE;n.name=m.filename;n.icon_type=i.getAttachTypeByMime(m.filetype);n.url='#';k.push(n);}}return k;}};e.exports=i;});
__d("MercuryMessageIDs",["KeyedCallbackManager"],function(a,b,c,d,e,f){var g=b('KeyedCallbackManager'),h=new g(),i={getServerIDs:function(j,k){var l=j.filter(function(n){return n.indexOf('mail.projektitan.com')!==-1;}),m=function(n){var o=j.map(function(p){return n[p]?n[p]:p;});k(o);};return h.executeOrEnqueue(l,m);},addServerID:function(j,k){h.setResource(j,k);}};e.exports=i;});
__d("MercuryServerDispatcher",["AsyncRequest","JSLogger","URI","areObjectsEqual","copyProperties","debounceAcrossTransitions"],function(a,b,c,d,e,f){var g=b('AsyncRequest'),h=b('JSLogger'),i=b('URI'),j=b('areObjectsEqual'),k=b('copyProperties'),l=b('debounceAcrossTransitions'),m={},n=h.create('mercury_dispatcher'),o=false,p={IMMEDIATE:'immediate',IDEMPOTENT:'idempotent',BATCH_SUCCESSIVE:'batch-successive',BATCH_SUCCESSIVE_UNIQUE:'batch-successive-unique',BATCH_SUCCESSIVE_PIGGYBACK_ON_ERROR:'batch-successive-piggyback-retry',BATCH_DEFERRED_MULTI:'batch-deferred-multi',BATCH_CONDITIONAL:'batch-conditional',registerEndpoints:function(r){for(var s in r){var t=r[s];m[s]=new q(s,t);}},trySend:function(r,s,t){m[r].trySend(s,t);}};function q(r,s){var t=s.mode||p.IMMEDIATE;switch(t){case p.IMMEDIATE:case p.IDEMPOTENT:case p.BATCH_SUCCESSIVE:case p.BATCH_SUCCESSIVE_UNIQUE:case p.BATCH_SUCCESSIVE_PIGGYBACK_ON_ERROR:case p.BATCH_DEFERRED_MULTI:case p.BATCH_CONDITIONAL:break;default:throw new Error('Invalid MercuryServerDispatcher mode '+t);}this._endpoint=r;this._mode=t;this._combineData=s.batch_function;this._combineDataIf=s.batch_if;this._handler=s.handler;this._errorHandler=s.error_handler;this._transportErrorHandler=s.transport_error_handler||s.error_handler;this._serverDialogCancelHandler=s.server_dialog_cancel_handler||s.error_handler;this._deferredSend=l(this._batchSend,0,this);}k(q.prototype,{_inFlight:0,_handler:null,_errorHandler:null,_transportErrorHandler:null,_serverDialogCancelHandler:null,_combineData:null,_pendingRequestData:null,trySend:function(r,s){if(o)return;if(typeof r=='undefined')r=null;var t=s||this._mode;if(t==p.IMMEDIATE){this._send(r);}else if(t==p.IDEMPOTENT){if(!this._inFlight)this._send(r);}else if(t==p.BATCH_SUCCESSIVE||t==p.BATCH_SUCCESSIVE_UNIQUE){if(!this._inFlight){this._send(r);}else this._batchData(r);}else if(t==p.BATCH_CONDITIONAL){if(this._inFlight&&(this._combineDataIf(this._pendingRequestData,r)||this._combineDataIf(this._batchedData,r))){this._batchData(r);}else this._send(r);}else if(t==p.BATCH_DEFERRED_MULTI){this._batchData(r);this._deferredSend();}else if(t==p.BATCH_SUCCESSIVE_PIGGYBACK_ON_ERROR){this._batchData(r);if(!this._inFlight)this._batchSend();}},_send:function(r){this._inFlight++;this._pendingRequestData=k({},r);n.log('send',{endpoint:this._endpoint,data:r,inflight_count:this._inFlight});new g(this._endpoint).setData(r).setHandler(this._handleResponse.bind(this)).setErrorHandler(this._handleError.bind(this)).setTransportErrorHandler(this._handleTransportError.bind(this)).setServerDialogCancelHandler(this._handleServerDialogCancel.bind(this)).setAllowCrossPageTransition(true).send();},_batchData:function(r){if(this._mode==p.BATCH_SUCCESSIVE_UNIQUE&&this._pendingRequestData&&j(r,this._pendingRequestData)){return;}else if(typeof this._batchedData=='undefined'){this._batchedData=r;}else this._batchedData=this._combineData(this._batchedData,r);},_batchSend:function(){if(typeof this._batchedData!='undefined'){this._send(this._batchedData);delete this._batchedData;}},_handleResponse:function(r){this._inFlight--;n.log('response',{endpoint:this._endpoint,inflight_count:this._inFlight});var s=r.getPayload();o=s&&s.kill_chat;if(o)n.log('killswitch_enabled',{endpoint:this._endpoint,inflight_count:this._inFlight});if(s&&s.error_payload){if(this._errorHandler)this._errorHandler(r);}else this._handler&&this._handler(s);if(this._mode==p.BATCH_SUCCESSIVE||this._mode==p.BATCH_SUCCESSIVE_UNIQUE||this._mode==p.BATCH_SUCCESSIVE_PIGGYBACK_ON_ERROR||this._mode==p.BATCH_CONDITIONAL)this._batchSend();this._pendingRequestData=null;},_handleErrorCommon:function(r,s){n.error('error',{endpoint:this._endpoint,inflight_count:this._inFlight-1});s&&s(r);this._inFlight--;var t=this._mode;if(t==p.BATCH_SUCCESSIVE||t==p.BATCH_SUCCESSIVE_UNIQUE||t==p.BATCH_CONDITIONAL){this._batchSend();}else if(t==p.BATCH_SUCCESSIVE_PIGGYBACK_ON_ERROR)if(typeof this._batchedData=='undefined'){this._batchedData=this._pendingRequestData;}else{this._batchedData=this._combineData(this._pendingRequestData,this._batchedData);this._batchSend();}this._pendingRequestData=null;},_handleError:function(r){this._handleErrorCommon(r,this._errorHandler);},_handleTransportError:function(r){this._handleErrorCommon(r,this._transportErrorHandler);},_handleServerDialogCancel:function(r){this._handleErrorCommon(r,this._serverDialogCancelHandler);}});e.exports=p;});
__d("MercuryThreadInformer",["Arbiter","copyProperties","MercuryAssert"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('copyProperties'),i=b('MercuryAssert'),j={},k={},l={},m=false,n=false,o=false,p={},q={},r={},s=0;function t(){if(!s){var v=j,w=k,x=l,y=m,z=n,aa=o,ba=p,ca=q,da=r;j={};k={};l={};m=false;n=false;o=false;p={};q={};r={};var ea=Object.keys(w);if(ea.length||y)u.inform('threadlist-updated',ea);if(ea.length)u.inform('threads-updated',w);for(var fa in x){u.inform('thread-read-changed',x);break;}for(var fa in v){u.inform('threads-deleted',v);break;}if(z)u.inform('unseen-updated',null);if(aa)u.inform('unread-updated',null);for(fa in ba){u.inform('messages-received',ba);break;}for(fa in ca){u.inform('messages-reordered',ca);break;}for(fa in da){u.inform('messages-updated',da);break;}}}var u=h(new g(),{updatedThread:function(v){k[v]=true;t();},deletedThread:function(v){j[v]=true;t();},updatedThreadlist:function(){m=true;t();},updatedUnseenState:function(){n=true;t();},updatedUnreadState:function(){o=true;t();},changedThreadReadState:function(v,w,x){if(!l[v]||l[v].timestamp<x)l[v]={mark_as_read:w,timestamp:x};t();},receivedMessage:function(v){i.isThreadID(v.thread_id);var w=v.thread_id;if(!p[w])p[w]=[];p[w].push(v);this.updatedThread(w);},reorderedMessages:function(v,w){q[v]={source:w};t();},updatedMessage:function(v,w,x){if(!r[v])r[v]={};r[v][w]={source:x};t();},synchronizeInforms:function(v){s++;try{v();}catch(w){throw w;}finally{s--;t();}},listen:function(v,w){return this.subscribe('threads-updated',function(x,y){if(y[v])w(v);});}});e.exports=u;});
__d("MessagingReliabilityLogger",["function-extensions","AsyncRequest","copyProperties","isEmpty","PresenceUtil","Run","MercuryServerDispatcher","setTimeoutAcrossTransitions","MessagingReliabilityLoggerInitialData"],function(a,b,c,d,e,f){b('function-extensions');var g=b('AsyncRequest'),h=b('copyProperties'),i=b('isEmpty'),j=b('PresenceUtil'),k=b('Run'),l=b('MercuryServerDispatcher'),m=b('setTimeoutAcrossTransitions'),n=c('MessagingReliabilityLoggerInitialData'),o='/ajax/mercury/client_reliability.php',p=60000;function q(w,x){var y={app:n.app,categories:JSON.stringify(w)};if(!i(x))y.extra=JSON.stringify(x);return y;}function r(w,x,y,z){if(w[x]===undefined)w[x]={};if(w[x][y]===undefined)w[x][y]=0;w[x][y]+=z;}function s(w,x,y,z){if(w[x]===undefined)w[x]={};if(w[x][y]===undefined)w[x][y]=[];for(var aa=0;aa<z.length;++aa)w[x][y].push(z[aa]);}function t(w,x){if(!w.categories||!x.categories)return;var y=JSON.parse(w.categories),z=w.extra?JSON.parse(w.extra):{},aa=JSON.parse(x.categories),ba=x.extra?JSON.parse(x.extra):{};for(var ca in aa){var da=aa[ca],ea=ba[ca];for(var fa in da){r(y,ca,fa,da[fa]);if(ea!==undefined){var ga=ea[fa];if(ga!==undefined)s(z,ca,fa,ga);}}}return q(y,z);}var u={};u[o]={mode:l.BATCH_SUCCESSIVE_PIGGYBACK_ON_ERROR,batch_function:t};l.registerEndpoints(u);var v={addEntry:function(w,x,y){if(!n.enabled)return;var z={};r(z,w,x,1);var aa={};if(y!==undefined)s(aa,w,x,[y]);l.trySend(o,q(z,aa));}};(function w(){v.addEntry('page_event','active',j.getSessionID());m(w,p);})();e.exports=v;});
__d("MercuryServerRequests",["Arbiter","AsyncResponse","KeyedCallbackManager","TimestampConverter","copyProperties","Env","JSLogger","MercuryAssert","MercuryMessageIDs","MercuryServerDispatcher","MercuryThreadInformer","MercuryIDs","MessagingReliabilityLogger","createObjectFrom","hasArrayNature","MercuryConstants"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('AsyncResponse'),i=b('KeyedCallbackManager'),j=b('TimestampConverter'),k=b('copyProperties'),l=b('Env'),m=b('JSLogger'),n=b('MercuryAssert'),o=b('MercuryMessageIDs'),p=b('MercuryServerDispatcher'),q=b('MercuryThreadInformer'),r=b('MercuryIDs'),s=b('MessagingReliabilityLogger'),t=b('createObjectFrom'),u=b('hasArrayNature'),v=c('MercuryConstants'),w=v.MercuryGenericConstants,x=0,y=m.create('mercury_server'),z=new i(),aa=new i(),ba=[],ca={},da={};function ea(ab){if(ab)x=j.maxValidActionID(x,ab);}function fa(ab){var bb=ab.thread_id,cb=z.getResource(bb);if(!cb){if(ab.is_canonical){if(ab.canonical_fbid===undefined){var db=ab.participants.filter(function(fb){return fb!='fbid:'+l.user;});if(db.length){var eb=r.tokenize(db[0]);if(eb.type=='email'){ab.canonical_email=eb.value;}else ab.canonical_fbid=eb.value;}else ab.canonical_fbid=l.user;}cb=ab.canonical_fbid?'user:'+ab.canonical_fbid:'email:'+ab.canonical_email;}else if(ab.is_canonical_group){cb='group:'+ab.group_id;}else if(ab.root_message_threading_id)cb='root:'+ab.root_message_threading_id;cb=cb||'thread:'+bb;ga(bb,cb);}ab.thread_id=cb;}function ga(ab,bb){z.setResource(ab,bb);aa.setResource(bb,ab);da[ab]=bb;}function ha(ab,bb){var cb=aa.executeOrEnqueue(ab,bb),db=aa.getUnavailableResources(cb),eb=xa.tokenizeThreadID(ab);if(db.length&&eb.type!='root')xa.fetchThreadData(db);}function ia(ab){return aa.getResource(ab);}function ja(ab){return !!z.getResource(ab);}function ka(ab){var bb=z.getResource(ab);if(typeof bb=='undefined')y.warn('no_client_thread_id',{server_id:ab});return bb;}function la(ab,bb){z.executeOrEnqueue(ab,bb);xa.ensureThreadIsFetched(ab);}function ma(ab,bb){if(ab.action_type!=v.MercuryActionType.SEND_MESSAGE)return;var cb=ab.client_thread_id;if(!cb)cb=ka(ab.thread_id);var db=null;if(cb)db=r.tokenize(cb).type;s.addEntry('send_'+db,bb,ab.thread_id+','+ab.message_id);}function na(ab){var bb=null;switch(ab.status){case v.MercuryActionStatus.SUCCESS:bb='success';break;case v.MercuryActionStatus.FAILED_UNKNOWN_REASON:bb='confirmed_error';break;case v.MercuryActionStatus.UNABLE_TO_CONFIRM:bb='confirm_error';break;default:return;}ma(ab,bb);}function oa(ab){(ab.message_counts||[]).forEach(function(jb){ea(jb.last_action_id);});(ab.threads||[]).forEach(function(jb){fa(jb);delete ca[jb.thread_id];delete ca[ia(jb.thread_id)];ea(jb.last_action_id);});(ab.ordered_threadlists||[]).forEach(function(jb){jb.thread_ids=jb.thread_ids.map(ka);});ab.actions=ab.actions||[];ab.actions.forEach(function(jb){na(jb);if(jb.status&&jb.status!=v.MercuryActionStatus.SUCCESS&&!jb.thread_id){jb.thread_id=jb.client_thread_id;return;}if(jb.action_type==v.MercuryActionType.SEND_MESSAGE&&jb.client_thread_id&&jb.client_thread_id!=w.PENDING_THREAD_ID)ga(jb.thread_id,jb.client_thread_id);jb.server_thread_id=jb.thread_id;jb.thread_id=ja(jb.thread_id)?ka(jb.thread_id):null;ea(jb.action_id);});if(ab.end_of_history){var bb=[];for(var cb=0;cb<ab.end_of_history.length;cb++){var db=ab.end_of_history[cb];if(db.type=='user'){bb.push('user:'+db.id);}else if(db.type=='thread'&&ja(db.id))bb.push(ka(db.id));}ab.end_of_history=bb;}if(ab.roger){var eb={};for(var fb in ab.roger){var gb=z.getResource(fb);if(gb){var hb=ab.roger[fb];eb[gb]={};for(var ib in hb)eb[gb]['fbid:'+ib]=hb[ib];}}ab.roger=eb;}}function pa(){if(ba&&ba.length){var ab=ba[0];ba=ba.slice(1);xa.handleUpdate(ab);}}function qa(ab,bb){var cb=k({},ab),db;if(bb.threads){if(!cb.threads)cb.threads={};for(db in bb.threads)cb.threads[db]=Object.keys(t((cb.threads[db]||[]).concat(bb.threads[db])));}if(bb.messages){if(!cb.messages)cb.messages={};for(db in bb.messages){if(!cb.messages[db])cb.messages[db]={};for(var eb in bb.messages[db])if(cb.messages[db][eb]){cb.messages[db][eb]=ta(cb.messages[db][eb],bb.messages[db][eb]);}else cb.messages[db][eb]=bb.messages[db][eb];}}return cb;}function ra(ab,bb){var cb=k(t(ab.folders,true),t(bb.folders,true));return {folders:Object.keys(cb)};}function sa(ab,bb){for(var cb in bb)if(ab[cb]){ab[cb]=ta(ab[cb],bb[cb]);}else{var db={};k(db,bb[cb]);ab[cb]=db;}return ab;}function ta(ab,bb){var cb=ab.offset<bb.offset?ab.offset:bb.offset,db=ab.offset+ab.limit,eb=bb.offset+bb.limit,fb=(db>eb)?db:eb,gb=fb-cb;return {offset:cb,limit:gb};}function ua(ab,bb){var cb={ids:{}};k(cb.ids,ab.ids);k(cb.ids,bb.ids);return cb;}function va(ab,bb){var cb={},db;for(db in ab)k(cb,t(ab[db],db));for(db in bb)k(cb,t(bb[db],db));var eb={};for(var fb in cb){db=cb[fb];if(!eb[db])eb[db]=[];eb[db].push(fb);}return eb;}function wa(ab,bb){var cb=t(ab.ids,true),db=t(bb.ids,true),eb=k(cb,db);return {ids:Object.keys(eb)};}var xa=k(new g(),{tokenizeThreadID:function(ab){n.isThreadID(ab);return r.tokenize(ab);},getServerThreadID:function(ab,bb){n.isThreadID(ab);ha(ab,bb);},getClientThreadID:function(ab,bb){la(ab,bb);},getClientThreadIDNow:function(ab){return ka(ab);},getServerThreadIDNow:function(ab){return ia(ab);},convertThreadIDIfAvailable:function(ab){var bb=z.getResource(ab);if(bb===undefined){return ab;}else return bb;},canLinkExternally:function(ab){n.isThreadID(ab);var bb=xa.tokenizeThreadID(ab);return (bb.type=='user')||!!ia(ab);},fetchThreadlistInfo:function(ab,bb,cb,db){cb=cb||v.MessagingTag.INBOX;var eb=db?p.IMMEDIATE:null,fb={};fb[cb]={offset:ab,limit:bb,filter:db};p.trySend('/ajax/mercury/threadlist_info.php',fb,eb);},fetchUnseenThreadIDs:function(ab){this.fetchThreadlistInfo(v.MercuryThreadlistConstants.RECENT_THREAD_OFFSET,v.MercuryThreadlistConstants.JEWEL_THREAD_COUNT,ab);},fetchUnreadThreadIDs:function(ab){p.trySend('/ajax/mercury/unread_threads.php',{folders:[ab]});},fetchMissedMessages:function(ab){p.trySend('/ajax/mercury/thread_sync.php',{last_action_id:x,folders:ab});},fetchThreadData:function(ab){n.allThreadID(ab);var bb={threads:{}},cb=[],db=[],eb=[],fb=[];ab.forEach(function(hb){if(ca[hb])return;ca[hb]=true;var ib=ia(hb);if(ib){db.push(ib);bb.threads.thread_ids=db;}else{var jb=xa.tokenizeThreadID(hb);if(jb.type=='user'){cb.push(jb.value);bb.threads.user_ids=cb;}else if(jb.type=='group'){eb.push(jb.value);bb.threads.group_ids=eb;}else if(jb.type=='thread'){db.push(jb.value);bb.threads.thread_ids=db;}else if(jb.type!='root'&&jb.type!='email'&&jb.type!='pending')throw new Error('Unknown thread type',jb);}});this.inform("fetch-thread-data",bb);for(var gb in bb.threads){p.trySend('/ajax/mercury/thread_info.php',bb);break;}},ensureThreadIsFetched:function(ab){if(!z.getResource(ab)&&!ca[ab]){ca[ab]=true;p.trySend('/ajax/mercury/thread_info.php',{threads:{thread_ids:[ab]}});}},fetchThreadMessages:function(ab,bb,cb,db){n.isThreadID(ab);var eb,fb,gb=xa.tokenizeThreadID(ab),hb=ia(ab),ib=false;if(hb&&gb.type!='group'){fb='thread_ids';eb=hb;}else{eb=gb.value;switch(gb.type){case 'user':fb='user_ids';ib=true;break;case 'group':fb='group_ids';break;case 'thread':fb='thread_ids';break;}}var jb={messages:{},threads:{}};if(fb){jb.messages[fb]={};jb.messages[fb][eb]={offset:bb,limit:cb};if(ib)jb.threads[fb]=[eb];p.trySend('/ajax/mercury/thread_info.php',jb,db);}else ha(ab,function(kb){jb.messages.thread_ids={};jb.messages.thread_ids[kb]={offset:bb,limit:cb};p.trySend('/ajax/mercury/thread_info.php',jb,db);});},handleThreadInfoError:function(ab){var bb=ab.getRequest().getData(),cb=[];if(bb.messages){for(var db in bb.messages.thread_ids)cb.push(ya(ka(db)));for(var eb in bb.messages.user_ids)cb.push(ya('user:'+eb));for(var fb in bb.messages.group_ids)cb.push(ya('group:'+fb));}if(cb.length)xa.handleUpdate({actions:cb,from_client:true,payload_source:v.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE});if(bb.threads&&(bb.threads.user_ids||bb.threads.group_ids||bb.threads.thread_ids)&&!bb.is_retry){if(bb.messages)delete bb.messages;y.log('retry_thread',bb);bb.is_retry=true;p.trySend('/ajax/mercury/thread_info.php',bb);}},markFolderAsRead:function(ab){p.trySend('/ajax/mercury/mark_folder_as_read.php',{folder:ab});var bb=[{action_type:v.MercuryGlobalActionType.MARK_ALL_READ,action_id:null,folder:ab}];this.handleUpdate({global_actions:bb,from_client:true,payload_source:v.MercuryPayloadSource.CLIENT_CHANGE_READ_STATUS});},changeThreadReadStatus:function(ab,bb,cb){n.isThreadID(ab);ha(ab,function(eb){var fb={ids:{}};fb.ids[eb]=bb;p.trySend('/ajax/mercury/change_read_status.php',fb);});var db=[{action_type:v.MercuryActionType.CHANGE_READ_STATUS,action_id:null,thread_id:ab,mark_as_read:bb,folder:cb}];this.handleUpdate({actions:db,from_client:true,payload_source:v.MercuryPayloadSource.CLIENT_CHANGE_READ_STATUS});},changeThreadArchivedStatus:function(ab,bb){n.isThreadID(ab);ha(ab,function(eb){var fb={ids:{}};fb.ids[eb]=bb;p.trySend('/ajax/mercury/change_archived_status.php',fb);});var cb={action_type:v.MercuryActionType.CHANGE_ARCHIVED_STATUS,action_id:null,thread_id:ab,archived:bb},db={actions:[cb],from_client:true,payload_source:v.MercuryPayloadSource.CLIENT_CHANGE_ARCHIVED_STATUS};this.handleUpdate(db);},changeThreadFolder:function(ab,bb){n.isThreadID(ab);ha(ab,function(eb){var fb={};fb[bb]=[eb];p.trySend('/ajax/mercury/move_thread.php',fb);});var cb={action_type:v.MercuryActionType.CHANGE_FOLDER,action_id:null,thread_id:ab,new_folder:bb},db={actions:[cb],from_client:true,payload_source:v.MercuryPayloadSource.CLIENT_CHANGE_FOLDER};this.handleUpdate(db);},markThreadSpam:function(ab){n.isThreadID(ab);ha(ab,function(db){p.trySend('/ajax/mercury/mark_spam.php',{id:db});});var bb={action_type:v.MercuryActionType.CHANGE_FOLDER,action_id:null,thread_id:ab,new_folder:v.MessagingTag.SPAM},cb={actions:[bb],from_client:true,payload_source:v.MercuryPayloadSource.CLIENT_CHANGE_FOLDER};this.handleUpdate(cb);},unmarkThreadSpam:function(ab){n.isThreadID(ab);ha(ab,function(db){p.trySend('/ajax/mercury/unmark_spam.php',{id:db});});var bb={action_type:v.MercuryActionType.CHANGE_FOLDER,action_id:null,thread_id:ab,new_folder:v.MessagingTag.INBOX},cb={actions:[bb],from_client:true,payload_source:v.MercuryPayloadSource.CLIENT_CHANGE_FOLDER};this.handleUpdate(cb);},deleteThread:function(ab){n.isThreadID(ab);ha(ab,function(db){var eb={ids:[db]};p.trySend('/ajax/mercury/delete_thread.php',eb);});var bb={action_type:v.MercuryActionType.DELETE_THREAD,action_id:null,thread_id:ab},cb={actions:[bb],from_client:true,payload_source:v.MercuryPayloadSource.CLIENT_DELETE_THREAD};this.handleUpdate(cb);},deleteMessages:function(ab,bb,cb){o.getServerIDs(bb||[],function(eb){p.trySend('/ajax/mercury/delete_messages.php',{message_ids:eb});});var db;if(cb){db={action_type:v.MercuryActionType.DELETE_THREAD,action_id:null,thread_id:ab};}else db={action_type:v.MercuryActionType.DELETE_MESSAGES,action_id:null,thread_id:ab,message_ids:bb};this.handleUpdate({actions:[db],from_client:true,payload_source:v.MercuryPayloadSource.CLIENT_DELETE_MESSAGES});},clearChat:function(ab,bb,cb){n.isThreadID(ab);p.trySend('/ajax/chat/settings.php',{clear_history_id:bb});var db=[{action_type:v.MercuryActionType.CLEAR_CHAT,action_id:null,thread_id:ab,clear_time:cb}];this.handleUpdate({actions:db,from_client:true,payload_source:v.MercuryPayloadSource.CLIENT_CLEAR_CHAT});},_batchThreadRead:function(ab,bb){var cb={};k(cb,ab.ids);k(cb,bb.ids);return {ids:cb};},sendNewMessage:function(ab){o.getServerIDs(ab.forward_message_ids||[],function(cb){var db=xa.tokenizeThreadID(ab.thread_id),eb=db.type,fb=k({},ab);fb.forward_message_ids=cb;var gb=ia(ab.thread_id);if((eb=='root'&&db.value==fb.message_id)||(eb=='user')||(ab.thread_id==w.PENDING_THREAD_ID)){fb.client_thread_id=fb.thread_id;fb.thread_id=null;this._sendNewMessageToServer(fb);}else ha(fb.thread_id,function(hb){fb.thread_id=hb;xa._sendNewMessageToServer(fb);});}.bind(this));if(ab.thread_id!=w.PENDING_THREAD_ID){var bb={actions:[k({},ab)],from_client:true,payload_source:v.MercuryPayloadSource.CLIENT_SEND_MESSAGE};xa.handleUpdate(bb);}},_sendNewMessageToServer:function(ab){p.trySend('/ajax/mercury/send_messages.php',{message_batch:[ab]});},_batchMessageSend:function(ab,bb){return {message_batch:ab.message_batch.concat(bb.message_batch)};},requestMessageConfirmation:function(ab){var bb={},cb={};for(var db in ab){var eb=ia(db);if(eb){bb[eb]=ab[db];}else{var fb=ab[db];for(var gb=0;gb<fb.length;gb++)cb[fb[gb]]=db;}}var hb=Object.keys(bb),ib=Object.keys(cb);if(hb.length||ib.length)p.trySend('/ajax/mercury/confirm_messages.php',{thread_message_map:bb,local_messages:cb});},handleMessageConfirmError:function(ab){var bb=ab.getRequest().getData().thread_message_map,cb=ab.getRequest().getData().local_messages;if(!bb&&!cb)return;var db=[];for(var eb in bb){var fb=bb[eb];fb.forEach(function(ib){db.push({action_type:v.MercuryActionType.SEND_MESSAGE,client_message_id:ib,message_id:ib,client_thread_id:null,thread_id:eb,status:v.MercuryActionStatus.UNABLE_TO_CONFIRM});});}for(var gb in cb){var hb=cb[gb];db.push({action_type:v.MercuryActionType.SEND_MESSAGE,client_message_id:gb,message_id:gb,client_thread_id:hb,thread_id:null,status:v.MercuryActionStatus.UNABLE_TO_CONFIRM});}if(db.length)this.handleUpdate({actions:db,payload_source:v.MercuryPayloadSource.CLIENT_HANDLE_ERROR});},markSeen:function(){var ab=j.convertActionIDToTimestamp(x);p.trySend('/ajax/mercury/mark_seen.php',{seen_timestamp:ab});},_batchMarkSeen:function(ab,bb){return bb;},handleRoger:function(ab){var bb=ab.tid?z.getResource(ab.tid):('user:'+ab.reader);if(bb){var cb={};cb[bb]={};cb[bb]['fbid:'+ab.reader]=ab.time;this.inform('update-roger',cb);}},handleUpdateWaitForThread:function(ab,bb){var cb=z.getResource(bb);if(cb){xa.handleUpdate(ab);return;}z.executeOrEnqueue(bb,function(){ba.push(ab);});if(!ca[bb]){ca[bb]=true;p.trySend('/ajax/mercury/thread_info.php',{threads:{thread_ids:[bb]}});}},handleUpdate:function(ab){y.debug('handle_update',{payload:ab,from_client:ab.from_client});for(var bb in ab){q.synchronizeInforms(function(){if(!ab.from_client){oa(ab);this.inform('payload-preprocessed',ab);}this.inform('update-thread-ids',da);da={};this.inform('update-participants',ab);this.inform('update-threads',ab);this.inform('update-unread',ab);this.inform('update-threadlist',ab);this.inform('update-messages',ab);this.inform('update-unseen',ab);this.inform('update-typing-state',ab);this.inform('update-roger',ab.roger);this.inform('model-update-completed',null);pa();}.bind(this));break;}},_handleSendMessageErrorCommon:function(ab,bb){y.debug('handle_send_message_error_common',{response:ab,request_error_status:bb});var cb=ab.getPayload(),db=ab.getRequest().getData(),eb=db.message_batch;if(!eb){ma({action_type:v.MercuryActionType.SEND_MESSAGE,status:v.MercuryActionStatus.REQUEST_EMPTY_MESSAGE_LIST});return;}var fb,gb=null;if(cb&&cb.error_payload){fb=v.MercuryActionStatus.UNCONFIRMED;gb='send_error';}else{gb=bb==v.MercuryActionStatus.REQUEST_ERROR?'request_error':'transport_error';if(ab.getError())gb+='_'+ab.getError();fb=bb;}var hb=eb.map(function(jb){return {action_type:v.MercuryActionType.SEND_MESSAGE,client_message_id:jb.message_id,message_id:jb.message_id,client_thread_id:jb.client_thread_id,thread_id:jb.thread_id,status:fb};});hb.forEach(function(jb){ma(jb,gb);});var ib={actions:hb,payload_source:v.MercuryPayloadSource.CLIENT_HANDLE_ERROR};this.handleUpdate(ib);},handleSendMessageError:function(ab){if(ab.error===1404074)h.verboseErrorHandler(ab);this._handleSendMessageErrorCommon(ab,v.MercuryActionStatus.REQUEST_ERROR);},handleSendMessageTransportError:function(ab){this._handleSendMessageErrorCommon(ab,v.MercuryActionStatus.TRANSPORT_ERROR);},getLastActionID:function(){return x;}});function ya(ab){return {action_type:v.MercuryActionType.LOG_MESSAGE,thread_id:ab,message_id:ab,timestamp:(new Date()).getTime(),timestamp_absolute:'',timestamp_relative:'',is_unread:false,source:v.MercurySourceType.UNKNOWN,log_message_type:v.MercuryLogMessageType.SERVER_ERROR,log_message_data:{}};}var za=xa.handleUpdate.bind(xa);p.registerEndpoints({'/ajax/mercury/thread_sync.php':{mode:p.IDEMPOTENT,handler:za},'/ajax/mercury/thread_info.php':{mode:p.BATCH_DEFERRED_MULTI,batch_function:qa,handler:za,error_handler:xa.handleThreadInfoError.bind(xa)},'/ajax/mercury/mark_folder_as_read.php':{mode:p.IMMEDIATE,handler:za},'/ajax/mercury/change_read_status.php':{mode:p.BATCH_SUCCESSIVE,batch_function:xa._batchThreadRead,handler:za},'/ajax/mercury/send_messages.php':{mode:p.BATCH_SUCCESSIVE,batch_function:xa._batchMessageSend,handler:za,error_handler:xa.handleSendMessageError.bind(xa),transport_error_handler:xa.handleSendMessageTransportError.bind(xa)},'/ajax/mercury/mark_seen.php':{mode:p.BATCH_SUCCESSIVE,batch_function:xa._batchMarkSeen,handler:za},'/ajax/mercury/confirm_messages.php':{mode:p.IMMEDIATE,handler:za,error_handler:xa.handleMessageConfirmError.bind(xa)},'/ajax/mercury/threadlist_info.php':{mode:p.BATCH_SUCCESSIVE_UNIQUE,batch_function:sa,handler:za},'/ajax/mercury/mark_spam.php':{mode:p.IMMEDIATE,handler:za},'/ajax/mercury/unmark_spam.php':{mode:p.IMMEDIATE,handler:za},'/ajax/mercury/unread_threads.php':{mode:p.BATCH_SUCCESSIVE_UNIQUE,batch_function:ra,handler:za},'/ajax/chat/settings.php':{mode:p.IMMEDIATE},'/ajax/mercury/change_archived_status.php':{mode:p.BATCH_SUCCESSIVE,batch_function:ua,handler:za},'/ajax/mercury/delete_thread.php':{mode:p.BATCH_SUCCESSIVE,batch_function:wa,handler:za},'/ajax/mercury/delete_messages.php':{mode:p.IMMEDIATE,handler:za},'/ajax/mercury/move_thread.php':{mode:p.BATCH_SUCCESSIVE,batch_function:va,handler:za}});e.exports=xa;});
__d("MercuryTimestampTracker",["MercuryServerRequests","MercuryConstants"],function(a,b,c,d,e,f){var g=b('MercuryServerRequests'),h=c('MercuryConstants'),i=0;e.exports={getLastUserMessageTimestamp:function(){return i;}};g.subscribe('update-messages',function(j,k){if(!k.actions||!k.actions.length)return;var l=h.MercuryPayloadSource;if(k.payload_source==l.CLIENT_SEND_MESSAGE||k.payload_source==l.UNKNOWN)return;for(var m=0;m<k.actions.length;m++){var n=k.actions[m],o=n.action_type;if(o==h.MercuryActionType.USER_GENERATED_MESSAGE&&n.thread_id&&n.timestamp>i)i=n.timestamp;}});});
__d("MercuryParticipants",["Env","JSLogger","MercuryAssert","MercuryIDs","ShortProfiles","MercuryServerRequests","copyProperties","getObjectValues","MercuryConstants"],function(a,b,c,d,e,f){var g=b('Env'),h=b('JSLogger'),i=b('MercuryAssert'),j=b('MercuryIDs'),k=b('ShortProfiles'),l=b('MercuryServerRequests'),m=b('copyProperties'),n=b('getObjectValues'),o=c('MercuryConstants'),p='fbid:'+g.user,q={},r=h.create('mercury_participants'),s=function(v){if(!q[v.id])q[v.id]=m({},v);};function t(v){i.isEmailParticipantID(v);var w=j.tokenize(v),x=w.value;return {gender:o.MercuryParticipantsConstants.UNKNOWN_GENDER,href:null,id:v,image_src:o.MercuryParticipantsConstants.EMAIL_IMAGE,name:x,short_name:x,employee:false,call_promo:false};}var u={user:p,getNow:function(v){return q[v];},get:function(v,w){i.isParticipantID(v);this.getMulti([v],function(x){w(x[v]);});},getMulti:function(v,w){i.allParticipantIDs(v);var x={},y={};v.forEach(function(aa){if(q[aa]){x[aa]=m({},q[aa]);}else{var ba=j.tokenize(aa);if(ba.type=='fbid'){var ca=ba.value;y[aa]=ca;}else if(ba.type=='email')x[aa]=t(aa);}});var z=n(y);if(z.length){k.getMulti(z,function(aa){for(var ba in y){var ca=y[ba],da=aa[ca];x[ba]={gender:da.gender,href:da.uri,id:ba,image_src:da.thumbSrc,name:da.name,short_name:da.firstName,employee:da.employee,call_promo:da.showVideoPromo};}w(x);});}else w(x);},getUserID:function(v){if(!j.isValid(v))return null;var w=j.tokenize(v);if(w.type!='fbid')return null;return w.value;},getIDForUser:function(v){return 'fbid:'+v;},addParticipants:function(v){v.forEach(s);}};l.subscribe('update-participants',function(v,w){u.addParticipants(w.participants||[]);});e.exports=u;});
__d("MercuryThreads",["Arbiter","copyProperties","JSLogger","createObjectFrom","KeyedCallbackManager","TimestampConverter","MercuryFolders","MercuryAssert","MercuryAttachment","MercuryIDs","MercuryServerRequests","MercuryThreadInformer","MercuryTimestampTracker","MercuryParticipants","MercuryConstants"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('copyProperties'),i=b('JSLogger'),j=b('createObjectFrom'),k=b('KeyedCallbackManager'),l=b('TimestampConverter'),m=b('MercuryFolders'),n=b('MercuryAssert'),o=b('MercuryAttachment'),p=b('MercuryIDs'),q=b('MercuryServerRequests'),r=b('MercuryThreadInformer'),s=b('MercuryTimestampTracker'),t=b('MercuryParticipants'),u=c('MercuryConstants'),v=i.create('mercury_threads'),w=new k();function x(ha,ia){var ja=j(ha.participants,true),ka=t.user;ia.forEach(function(la){if(ja[la]!==true){ha.participants.push(la);if(la===ka)ha.is_subscribed=true;}});}function y(ha,ia){ha.participants.remove(ia);if(ia===t.user)ha.is_subscribed=false;}function z(ha,ia){if(ha.participants[0]!=ia){ha.participants.remove(ia);ha.participants.unshift(ia);}}function aa(ha,ia){var ja=ia.body,ka=ia.subject,la='';if(ka){ka=ka.toLowerCase();if(ja.slice(0,ka.length).toLowerCase()==ka){la=ja;}else if(ja){la=ka+' \u00B7 '+ja;}else la=ka;}else la=ja;ha.snippet=la;ha.snippet_has_attachment=ia.has_attachment;if(ia.raw_attachments&&ia.raw_attachments.length>0){var ma=o.convertRaw(ia.raw_attachments);ha.snippet_attachments=ma;}else ha.snippet_attachments=ia.attachments;ha.is_forwarded_snippet=!!ia.forward_count;}function ba(ha,ia){if(!ha)return false;var ja=!ha.unread_count;if(ia==ja)return false;ha.unread_count=ia?0:1;w.setResource(ha.thread_id,ha);r.updatedThread(ha.thread_id);return true;}function ca(ha){var ia=w.getAllResources();for(var ja in ia){var ka=ia[ja];if(ka.folder==ha){ka.unread_count=0;w.setResource(ja,ka);r.updatedThread(ja);}}}function da(ha,ia){if(!ha||ha.chat_clear_time===ia)return false;ha.chat_clear_time=ia;w.setResource(ha.thread_id,ha);r.reorderedMessages(ha.thread_id);return true;}function ea(ha,ia,ja){var ka=ia.action_type;if(ka==u.MercuryActionType.USER_GENERATED_MESSAGE||ka==u.MercuryActionType.LOG_MESSAGE){ia.is_unread&&ha.unread_count++;ha.is_archived=false;}switch(ka){case u.MercuryActionType.USER_GENERATED_MESSAGE:z(ha,ia.author);break;case u.MercuryActionType.LOG_MESSAGE:var la=ia.log_message_type;if(la==u.MercuryLogMessageType.SUBSCRIBE){x(ha,ia.log_message_data.added_participants);}else if(la==u.MercuryLogMessageType.UNSUBSCRIBE){y(ha,ia.author);}else if(la==u.MercuryLogMessageType.THREAD_IMAGE){ha.image_src=ia.log_message_data.image?ia.log_message_data.image.preview_url:null;}else if(la==u.MercuryLogMessageType.THREAD_NAME)ha.name=ia.log_message_data.name;break;case u.MercuryActionType.CHANGE_READ_STATUS:if(ia.timestamp)r.changedThreadReadState(ha.thread_id,ia.mark_as_read,ia.timestamp);ba(ha,ia.mark_as_read);break;case u.MercuryActionType.CLEAR_CHAT:da(ha,ia.clear_time);break;case u.MercuryActionType.CHANGE_ARCHIVED_STATUS:ha.is_archived=ia.archived;break;case u.MercuryActionType.CHANGE_FOLDER:ha.folder=ia.new_folder;break;case u.MercuryActionType.DELETE_MESSAGES:if(ja){ha.snippet='...';ha.snippet_has_attachment=false;ha.snippet_attachments=null;ha.is_forwarded_snippet=false;r.updatedThread(ia.thread_id);}break;}if(ia.action_id)ha.last_action_id=l.maxValidActionID(ia.action_id,ha.last_action_id);}function fa(ha){var ia=q.tokenizeThreadID(ha.thread_id);if(ia.type=='group'){v.error('invalid_new_thread_message',ha);return undefined;}var ja={thread_id:ha.thread_id,last_action_id:ha.action_id,participants:ha.specific_to_list,name:null,snippet:ha.body,snippet_has_attachment:false,snippet_attachments:[],unread_count:0,image_src:null,timestamp_absolute:ha.timestamp_absolute,timestamp_relative:ha.timestamp_relative,timestamp:ha.timestamp,is_canonical_user:ia.type=='user',is_canonical:ia.type=='user'||ia.type=='email',is_subscribed:true,is_canonical_group:false,is_chatlogger_thread:false,group_id:null,root_message_threading_id:ha.message_id,folder:u.MessagingTag.INBOX,is_archived:false,mode:u.MercuryThreadMode.TITAN_ORIGINATED};w.setResource(ja.thread_id,ja);return ja;}g.subscribe(i.DUMP_EVENT,function(ha,ia){ia.messaging=ia.messaging||{};ia.messaging.threads=w.dumpResources();});var ga={getThreadMetaNow:function(ha){n.isThreadID(ha);return w.getResource(ha);},getThreadMeta:function(ha,ia){n.isThreadID(ha);var ja=w.executeOrEnqueue(ha,ia),ka=w.getUnavailableResources(ja);if(ka.length){var la=q.tokenizeThreadID(ha);if(la.type=='user'){this.getCanonicalThreadToUser(la.value);}else q.fetchThreadData(ka);}return ja;},unsubscribe:function(ha){w.unsubscribe(ha);},changeThreadReadStatus:function(ha,ia){n.isThreadID(ha);var ja=w.getResource(ha);if(ba(ja,ia))q.changeThreadReadStatus(ha,ia,m.getFromMeta(ja));},changeThreadArchivedStatus:function(ha,ia){n.isThreadID(ha);var ja=w.getResource(ha);if(ja.is_archived!=ia){ja.is_archived=ia;r.updatedThread(ja.thread_id);q.changeThreadArchivedStatus(ha,ia);}},markThreadSpam:function(ha){q.markThreadSpam(ha);},unmarkThreadSpam:function(ha){q.unmarkThreadSpam(ha);},changeFolder:function(ha,ia){n.isThreadID(ha);var ja=w.getResource(ha);if(ja&&ja.folder!=ia){ja.folder=ia;r.updatedThread(ja.thread_id);q.changeThreadFolder(ha,ia);}},deleteThread:function(ha){n.isThreadID(ha);q.deleteThread(ha);},updateThreads:function(ha){if(!ha||!ha.length)return;var ia={};ha.forEach(function(ja){ia[ja.thread_id]=ja;});w.addResourcesAndExecute(ia);},updateMetadataByActions:function(ha,ia){if(!ha||!ha.length)return;var ja={},ka={},la={};for(var ma=0;ma<ha.length;ma++){var na=ha[ma];if(na.is_forward)continue;var oa=na.action_type,pa=na.thread_id;n.isThreadID(pa);var qa=this.getThreadMetaNow(pa);if(oa==u.MercuryActionType.LOG_MESSAGE&&na.log_message_type==u.MercuryLogMessageType.SERVER_ERROR)continue;if(!qa&&!na.action_id&&oa==u.MercuryActionType.USER_GENERATED_MESSAGE)qa=fa(na);if(qa){if(oa==u.MercuryActionType.DELETE_THREAD){r.deletedThread(pa);continue;}var ra=!!na.action_id;if(oa==u.MercuryActionType.LOG_MESSAGE||oa==u.MercuryActionType.USER_GENERATED_MESSAGE)ra=!ia;if(na.timestamp<=qa.timestamp&&ra){v.log('ignore_old_timestamp',{action:na,from_client:ia,thread_timestamp:qa.timestamp});continue;}if(!la[pa])la[pa]=h({},qa);ea(la[pa],na,ia);if(oa==u.MercuryActionType.USER_GENERATED_MESSAGE)ja[pa]=na;if(oa==u.MercuryActionType.USER_GENERATED_MESSAGE||oa==u.MercuryActionType.LOG_MESSAGE||oa==u.MercuryActionType.SEND_MESSAGE)if(na&&na.timestamp&&(!ka[pa]||na.timestamp>ka[pa].timestamp))ka[pa]=na;}}for(var sa in la){var ta=la[sa],ua=ja[sa];if(ua)aa(ta,ua);var va=ka[sa],wa=ta.timestamp;if(va&&va.timestamp>wa)ta=h(ta,{timestamp_absolute:va.timestamp_absolute,timestamp_relative:va.timestamp_relative,timestamp:va.timestamp});w.setResource(sa,ta);}},getCanonicalThreadToGroup:function(ha,ia){var ja='group:'+ha;this.getThreadMeta(ja,ia);},getCanonicalThreadToUser:function(ha,ia){return ga.getCanonicalThreadToParticipant('fbid:'+ha,ia);},getCanonicalThreadToParticipant:function(ha,ia){var ja=ga.getThreadIDForParticipant(ha),ka=w.getResource(ja);if(typeof ka=='undefined'){ka=ga.createNewLocalThread(ja,[t.user,ha],ia);q.fetchThreadData([ja]);}return ka;},getThreadIdForUser:function(ha){return 'user:'+ha;},getThreadIdForEmail:function(ha){return 'email:'+ha;},getThreadIDForParticipant:function(ha){var ia=p.tokenize(ha);return ia.type=='fbid'?ga.getThreadIdForUser(ia.value):ga.getThreadIdForEmail(ia.value);},createNewLocalThread:function(ha,ia,ja){var ka=w.getResource(ha);if(!ka){var la=q.tokenizeThreadID(ha);ka={thread_id:ha,last_action_id:null,participants:ia,name:null,snippet:'',snippet_has_attachment:false,unread_count:ja?ja:0,image_src:null,timestamp_absolute:null,timestamp_relative:null,timestamp:null,is_canonical_user:la.type=='user',is_canonical:la.type=='user'||la.type=='email',is_subscribed:true,is_canonical_group:la.type=='group',group_id:(la.type=='group'?la.value:null),root_message_threading_id:null,folder:u.MessagingTag.INBOX,is_archived:false,mode:u.MercuryThreadMode.TITAN_ORIGINATED};ka.is_chatlogger_thread=ka.is_canonical_group;w.setResource(ha,ka);}return ka;},addParticipantsToThreadLocally:function(ha,ia){var ja=w.getResource(ha);if(ja){x(ja,ia);r.updatedThread(ja.thread_id);}},getCanonicalUserInThread:function(ha){var ia=q.tokenizeThreadID(ha);return ia.type=='user'?ia.value:null;},getCanonicalGroupInThread:function(ha){var ia=q.tokenizeThreadID(ha);return ia.type=='group'?ia.value:null;},isEmptyLocalThread:function(ha){var ia=w.getResource(ha);if(!ia)return false;var ja=q.tokenizeThreadID(ha);return ja.type=='root'&&!ia.timestamp;},isMultichatThread:function(ha){var ia=q.tokenizeThreadID(ha).type;return ia!='user'&&ia!='group';}};q.subscribe('update-threads',function(ha,ia){var ja=(ia.actions||[]).filter(function(na){return na.thread_id;});ga.updateThreads(ia.threads);ga.updateMetadataByActions(ja,ia.from_client);(ia.threads||[]).forEach(function(na){r.updatedThread(na.thread_id);});var ka=ia.global_actions||[];for(var la=0;la<ka.length;la++){var ma=ka[la];if(ma.action_type==u.MercuryGlobalActionType.MARK_ALL_READ)ca(ma.folder);}});e.exports=ga;});
__d("ChatActivity",["Arbiter","AvailableList","AvailableListConstants","copyProperties","event-extensions","JSLogger","MercuryThreads","PresenceState","UserActivity","MercuryConfig"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('AvailableList'),i=b('AvailableListConstants'),j=b('copyProperties');b('event-extensions');var k=b('JSLogger'),l=b('MercuryThreads'),m=b('PresenceState'),n=b('UserActivity'),o=c('MercuryConfig'),p=o.activity_limit||60000,q=o.idle_limit||1800000,r=o.idle_poll_interval||300000,s=k.create('chat_activity'),t=Date.now(),u=t,v=true;function w(){var aa=Date.now();return !!(v&&(aa-t<p));}var x=j(new g(),{isActive:w});function y(){var aa=t;t=Date.now();if(t-aa>q){s.debug('idle_to_active',aa);m.doSync();}x.inform('activity');}h.subscribe(i.ON_AVAILABILITY_CHANGED,function(){if(!h.isUserIdle())u=Date.now();});Event.listen(window,'focus',function(){v=true;y();});Event.listen(window,'blur',function(){v=false;});n.subscribe(function(){y();});function z(aa){var ba=aa&&aa.at&&m.verifyNumber(aa.at);if(typeof ba!=='number')ba=null;return ba||0;}setInterval(function(){var aa=Date.now(),ba=z(m.get()),ca=Math.max(t,ba,u);if(aa-ca>q){s.debug('idle',{cookie:ba,local:t,presence:u});x.inform('idle',aa-ca);}},r);m.registerStateStorer(function(aa){var ba=z(aa);if(ba<t)aa.at=t;return aa;});g.subscribe(k.DUMP_EVENT,function(aa,ba){ba.chat_activity={activity_limit:p,idle_limit:q,idle_poll_interval:r,last_active_time:t,last_global_active_time:u};});e.exports=x;});
__d("MercuryMessages",["Arbiter","copyProperties","Env","JSLogger","randomInt","tx","KeyedCallbackManager","MercuryAssert","MercuryIDs","MercuryMessageIDs","MercuryParticipants","PresenceUtil","RangedCallbackManager","MercuryServerRequests","MercuryServerDispatcher","MercuryThreadInformer","MercuryThreads","MercuryConstants","MercuryConfig"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('copyProperties'),i=b('Env'),j=b('JSLogger'),k=b('randomInt'),l=b('tx'),m=b('KeyedCallbackManager'),n=b('MercuryAssert'),o=b('MercuryIDs'),p=b('MercuryMessageIDs'),q=b('MercuryParticipants'),r=b('PresenceUtil'),s=b('RangedCallbackManager'),t=b('MercuryServerRequests'),u=b('MercuryServerDispatcher'),v=b('MercuryThreadInformer'),w=b('MercuryThreads'),x=c('MercuryConstants'),y=c('MercuryConfig'),z=x.MercuryGenericConstants,aa={},ba={},ca={},da=function(sa){var ta=sa;if(ba[sa])ta=ba[sa];return aa[ta];},ea={},fa={},ga=new m();function ha(sa){if(sa.status===undefined)sa.status=x.MercuryActionStatus.UNSENT;sa.message_id=sa.message_id||na.generateNewClientMessageID(sa.timestamp);var ta=q.user;sa.specific_to_list=sa.specific_to_list||[];if(sa.specific_to_list.length&&sa.specific_to_list.indexOf(ta)===-1)sa.specific_to_list.push(ta);if(!sa.thread_id){if(sa.specific_to_list.length==1){sa.thread_id='user:'+i.user;}else if(sa.specific_to_list.length==2){var ua=sa.specific_to_list[0]==ta?sa.specific_to_list[1]:sa.specific_to_list[0];if(o.tokenize(ua).type=='email'){sa.thread_id=z.PENDING_THREAD_ID;}else sa.thread_id=w.getThreadIDForParticipant(ua);}sa.thread_id=sa.thread_id||'root:'+sa.message_id;}if(!sa.specific_to_list.length){var va=t.tokenizeThreadID(sa.thread_id);if(va.type=='user')sa.specific_to_list=['fbid:'+va.value,ta];}}function ia(sa,ta,ua){var va=ra(ta)?[x.MercuryMessageSourceTags.CHAT]:[],wa=Date.now(),xa=Date.format(y['24h_times']?'H:i':'g:ia',Math.floor(wa/1000)),ya={action_type:sa,thread_id:ua,author:q.user,author_email:null,coordinates:null,timestamp:wa,timestamp_absolute:(new Date(wa)).toLocaleDateString(),timestamp_relative:xa,is_unread:false,is_cleared:false,is_forward:false,spoof_warning:false,source:ta,source_tags:va};return ya;}function ja(sa){switch(sa){case x.MercuryPayloadSource.UNKNOWN:case x.MercuryPayloadSource.SERVER_INITIAL_DATA:case x.MercuryPayloadSource.SERVER_FETCH_THREAD_INFO:case x.MercuryPayloadSource.SERVER_THREAD_SYNC:return true;}return false;}function ka(sa){return sa&&sa.substr(0,6)==='server';}function la(sa){if(!ea[sa])ea[sa]=new s(function(ta){return da(ta).timestamp;},function(ta,ua){return ua-ta;});return ea[sa];}g.subscribe(j.DUMP_EVENT,function(sa,ta){var ua={};for(var va in aa){var wa=aa[va],xa=wa.thread_id;ua[xa]=ua[xa]||{};ua[xa][wa.message_id]=h({},wa);}ta.messaging=ta.messaging||{};ta.messaging.local_message_ids=h({},ba);ta.messaging.messages=ua;});function ma(sa,ta){sa.forEach(function(ua){var va=la(ua);va.setReachedEndOfArray();v.reorderedMessages(ua,ta);});}var na={getMessagesFromIDs:function(sa){return (sa||[]).map(da).filter(function(ta){return ta;});},hasLoadedNMessages:function(sa,ta){var ua=la(sa);return ua.hasReachedEndOfArray()||ua.getCurrentArraySize()>=ta;},getThreadMessagesRangeImmediately:function(sa,ta,ua,va){return this.getThreadMessagesRange(sa,ta,ua,va,u.IMMEDIATE);},getThreadMessagesRange:function(sa,ta,ua,va,wa){var xa=la(sa),ya=function(db){va(oa(db));},za=xa.executeOrEnqueue(ta,ua,ya),ab=xa.getUnavailableResources(za),bb=ca[sa];if(ab.length&&!bb){var cb=fa[sa]||0;t.fetchThreadMessages(sa,cb,ab.length,wa);}else ca[sa]=false;return za;},getThreadMessagesSinceTimestamp:function(sa,ta){var ua=la(sa),va=ua.getElementsUntil(ta);return oa(va);},hasLoadedAllMessages:function(sa){return la(sa).hasReachedEndOfArray();},unsubscribe:function(sa,ta){n.isThreadID(ta);var ua=la(ta);ua.unsubscribe(sa);},handleUpdates:function(sa,ta,ua){var va={},wa={},xa=x.MercuryActionStatus;for(var ya=0;ya<sa.length;ya++){var za=sa[ya];if(za.is_forward||ua==x.MercuryPayloadSource.SERVER_SEARCH){if(!aa[za.message_id])aa[za.message_id]=za;continue;}var ab=za.action_type;if(ab==x.MercuryActionType.SEND_MESSAGE){var bb=za.client_message_id;if(bb&&ba[bb]&&za.status){if(za.status==xa.UNCONFIRMED){if(!wa[za.thread_id])wa[za.thread_id]=[];wa[za.thread_id].push(za.client_message_id);}else if(!va[za.thread_id])va[za.thread_id]=[];var cb=da(za.client_message_id),db=cb.status;cb.status=za.status;if(za.status==xa.SUCCESS){this.updateLocalMessage(za,ua);if(za.client_thread_id==z.PENDING_THREAD_ID){cb.thread_id=za.thread_id;va[za.thread_id].push(cb.message_id);ga.setResource(cb.message_id,cb.thread_id);}}if(typeof db!='undefined'||za.status==xa.REQUEST_ERROR||za.status==xa.TRANSPORT_ERROR||za.status==xa.FAILED_UNKNOWN_REASON||za.status==xa.UNABLE_TO_CONFIRM||za.status==xa.SUCCESS)v.updatedMessage(za.thread_id,da(za.client_message_id).message_id,ua);}continue;}else if(ab==x.MercuryActionType.DELETE_THREAD){la(za.thread_id).removeAllResources();continue;}else if(ab==x.MercuryActionType.DELETE_MESSAGES){var eb=za.message_ids.map(function(mb){return da(mb).message_id;}),fb=la(za.thread_id);fb.removeResources(eb);v.reorderedMessages(za.thread_id,ua);continue;}else if(ab==x.MercuryActionType.LOG_MESSAGE){if(za.log_message_type==x.MercuryLogMessageType.SERVER_ERROR)ca[za.thread_id]=true;}else if(ab==x.MercuryActionType.CLEAR_CHAT){var gb=la(za.thread_id).getAllResources();gb.map(da).forEach(function(mb){mb.is_cleared=true;});continue;}var hb=da(za.message_id);if((za.threading_id&&ba[za.threading_id])||(hb&&!hb.is_forward))continue;if(!va[za.thread_id])va[za.thread_id]=[];va[za.thread_id].push(za.message_id);aa[za.message_id]=za;if(za.threading_id&&za.threading_id!=za.message_id)p.addServerID(za.threading_id,za.message_id);if(!ta)v.receivedMessage(za);}for(var ib in va){var fb=la(ib),jb=fb.getAllResources(),kb=jb.filter(function(mb){var nb=aa[mb];return nb.action_type==x.MercuryActionType.LOG_MESSAGE&&nb.log_message_type==x.MercuryLogMessageType.SERVER_ERROR;});fb.removeResources(kb);pa(ib,va[ib]);if(ta){fb.addResources(va[ib]);v.reorderedMessages(ib,ua);}else fb.addResourcesWithoutSorting(va[ib].reverse(),0);v.updatedThread(ib);}var lb=Object.keys(wa);if(lb.length)t.requestMessageConfirmation(wa);},sendMessage:function(sa,ta){ta=ta||Function.prototype;ha(sa);ba[sa.message_id]=sa.message_id;if(sa.thread_id=='root:'+sa.message_id)la(sa.thread_id).setReachedEndOfArray();t.sendNewMessage(sa);if(sa.thread_id==z.PENDING_THREAD_ID){aa[sa.message_id]=sa;return ga.executeOrEnqueue(sa.message_id,ta);}else ta(sa.thread_id);},unsubscribeSend:function(sa){ga.unsubscribe(sa);},resendMessage:function(sa){var ta=h({},sa);ta.status=x.MercuryActionStatus.RESENDING;ta.timestamp=(new Date()).getTime();ta.message_id=na.generateNewClientMessageID(ta.timestamp);var ua=la(sa.thread_id);ua.removeResources([sa.message_id]);this.sendMessage(ta);v.reorderedMessages(sa.thread_id,x.MercuryPayloadSource.CLIENT_SEND_MESSAGE);},deleteMessages:function(sa,ta){if(ta.length){var ua=la(sa),va=ua.getCurrentArraySize()==ta.length&&ua.hasReachedEndOfArray();t.deleteMessages(sa,ta,va);}},updateLocalMessage:function(sa,ta){var ua=sa.message_id,va=sa.client_message_id;ba[va]=ua;aa[ua]=aa[va];p.addServerID(va,ua);aa[va]={};if(sa.timestamp)da(va).timestamp=sa.timestamp;if(sa.attachments&&sa.attachments.length){da(va).raw_attachments=null;da(va).attachments=sa.attachments;}},constructUserGeneratedMessageObject:function(sa,ta,ua,va){var wa=ia(x.MercuryActionType.USER_GENERATED_MESSAGE,ta,ua);wa.body=sa;wa.has_attachment=false;wa.html_body=false;wa.attachments=[];wa.specific_to_list=va||[];return wa;},constructLogMessageObject:function(sa,ta,ua,va){var wa=ia(x.MercuryActionType.LOG_MESSAGE,sa,ta);wa.log_message_type=ua;wa.log_message_data=va;return wa;},generateNewClientMessageID:function(sa){var ta=sa+':'+(k(0,4294967295)+1)+'-'+r.getSessionID();return '<'+ta+'@mail.projektitan.com>';}};t.subscribe('update-messages',function(sa,ta){var ua=(ta.actions||[]).filter(function(wa){var xa=wa.action_type;return (wa.is_forward||wa.thread_id)&&(xa==x.MercuryActionType.LOG_MESSAGE||xa==x.MercuryActionType.USER_GENERATED_MESSAGE||xa==x.MercuryActionType.SEND_MESSAGE||xa==x.MercuryActionType.CLEAR_CHAT||xa==x.MercuryActionType.DELETE_THREAD||xa==x.MercuryActionType.DELETE_MESSAGES);}),va=ja(ta.payload_source);if(ka(ta.payload_source))ua.forEach(function(wa){if(!wa.is_forward){var xa=w.getThreadMetaNow(wa.thread_id);if(xa)wa.is_cleared=wa.timestamp<xa.chat_clear_time;}});na.handleUpdates(ua,va,ta.payload_source);if(ta.end_of_history)ma(ta.end_of_history,ta.payload_source);});function oa(sa){var ta=sa.map(da);return ta.reverse();}function pa(sa,ta){var ua=ta.filter(function(va){return qa(da(va));});if(!fa[sa])fa[sa]=0;fa[sa]+=ua.length;}function qa(sa){var ta=sa.action_type;if(ta==x.MercuryActionType.USER_GENERATED_MESSAGE)return true;switch(sa.log_message_type){case x.MercuryLogMessageType.SUBSCRIBE:case x.MercuryLogMessageType.UNSUBSCRIBE:case x.MercuryLogMessageType.SERVER_ERROR:case x.MercuryLogMessageType.LIVE_LISTEN:return false;default:return true;}}function ra(sa){switch(sa){case x.MercurySourceType.CHAT_WEB:case x.MercurySourceType.CHAT_JABBER:case x.MercurySourceType.CHAT_IPHONE:case x.MercurySourceType.CHAT_MEEBO:case x.MercurySourceType.CHAT_ORCA:case x.MercurySourceType.CHAT_TEST:case x.MercurySourceType.CHAT:case x.MercurySourceType.DESKTOP:return true;default:return false;}}e.exports=na;});
__d("MercuryNotificationRenderer",["MercuryAssert","MercuryMessages","MercuryParticipants","MercuryThreads","tx"],function(a,b,c,d,e,f){var g=b('MercuryAssert'),h=b('MercuryMessages'),i=b('MercuryParticipants'),j=b('MercuryThreads'),k=b('tx');function l(m,n){g.isThreadID(m);j.getThreadMeta(m,function(o){h.getThreadMessagesRange(m,0,1,function(p){var q=p.length&&p[p.length-1];if(q&&q.author!=i.user){i.get(q.author,function(r){if(o.name){n(k._("{senderName} a envoy\u00e9 un message \u00e0 {groupName}",{senderName:r.short_name,groupName:o.name}));}else n(k._("{name} vous a envoy\u00e9 un message",{name:r.short_name}));});}else n("Nouveau message\u00a0!");});});}e.exports={renderDocumentTitle:l};});
__d("MercuryUnseenState",["Arbiter","copyProperties","TimestampConverter","KeyedCallbackManager","JSLogger","createObjectFrom","MercuryServerRequests","MercuryThreadInformer","MercuryConstants"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('copyProperties'),i=b('TimestampConverter'),j=b('KeyedCallbackManager'),k=b('JSLogger'),l=b('createObjectFrom'),m=b('MercuryServerRequests'),n=b('MercuryThreadInformer'),o=c('MercuryConstants'),p=o.MercuryThreadlistConstants.MAX_UNSEEN_COUNT,q=0,r=0,s=false,t=new j(),u='unseen_thread_hash',v='unseen_thread_list',w=k.create('mercury_unseen_state'),x={getUnseenCount:function(){if(this.exceedsMaxCount()){w.error('unguarded_unseen_count_fetch',{});return 0;}return ba();},exceedsMaxCount:function(){return s||(ba()>p);},markAsSeen:function(){if(ba()>0||s){m.markSeen();da(i.convertActionIDToTimestamp(m.getLastActionID()),[]);}},markThreadSeen:function(ka,la){var ma={};ma[ka]=null;fa(ma,la);}};function y(ka){t.setResource(u,ka);t.setResource(v,Object.keys(ka));}function z(ka){var la=t.executeOrEnqueue(u,ka),ma=t.getUnavailableResources(la);if(ma.length)m.fetchUnseenThreadIDs();}function aa(){return t.getResource(u);}function ba(){var ka=t.getResource(v);if(ka){return ka.length;}else return q;}function ca(ka){var la=ja(ka);if(ka.unseen_thread_ids){ka.unseen_thread_ids.forEach(function(wa){if(wa.folder!=o.MessagingTag.INBOX)return;var xa=ha(wa.thread_ids),ya=r;if(la&&la.seen_timestamp)ya=la.seen_timestamp;da(ya,xa);if(la&&la.unseen_count>p)s=true;});}else if(la&&la.seen_timestamp){r=la.seen_timestamp;if(la.unseen_count>p){s=true;y({});}else{q=la.unseen_count;if(q===0)y({});}}else{if(s)return;var ma=ka.actions;if(!ma||!(ma.length))return;var na={},oa={};for(var pa=0;pa<ma.length;pa++){var qa=ma[pa];if(qa.is_forward)continue;var ra=qa.action_type,sa=qa.action_id,ta=qa.thread_id?qa.thread_id:qa.server_thread_id,ua=qa.folder===undefined||qa.folder==o.MessagingTag.INBOX;if(!ua)continue;if(ra==o.MercuryActionType.USER_GENERATED_MESSAGE||ra==o.MercuryActionType.LOG_MESSAGE){var va=i.isGreaterThan(sa,na[ta]);if(qa.is_unread&&(!na[ta]||va))na[ta]=sa;}else if(ra==o.MercuryActionType.CHANGE_READ_STATUS&&qa.mark_as_read)oa[ta]=sa;}ea(na);fa(oa);}}function da(ka,la){var ma=aa();if(ma===undefined||ka>r||s){r=ka;la=la||[];if(la.length<=p)s=false;var na={},oa=aa()||{};for(var pa in oa)if(oa[pa]!==true){var qa=oa[pa];if(ga(qa))na[pa]=qa;}var ra=h(l(la,true),na);y(ra);n.updatedUnseenState();}}function ea(ka){if(s)return;var la={},ma=false;for(var na in ka){var oa=ka[na];if(ga(oa)){la[na]=oa;ma=true;}}if(!ma)return;z(function(pa){for(var qa in la){var ra=la[qa];if(!pa[qa]&&ga(ra))pa[qa]=la[qa];}y(pa);n.updatedUnseenState();});}function fa(ka,la){var ma=false;for(var na in ka){ma=true;break;}if(ma)z(function(oa){var pa=false;for(var qa in ka){var ra=ka[qa],sa=i.isGreaterThan(ra,oa[qa]);if(oa[qa]&&(!ra||sa)){delete oa[qa];pa=true;}}if(pa){y(oa);n.updatedUnseenState();if(la&&ba()===0)m.markSeen();}});}function ga(ka){return i.convertActionIDToTimestamp(ka)>r;}function ha(ka){return ka.map(m.convertThreadIDIfAvailable);}function ia(ka){var la=aa();if(!la)return;for(var ma in ka){var na=ka[ma];if(la[ma]){la[na]=la[ma];delete la[ma];}}y(la);}function ja(ka){var la=(ka.message_counts||[]);for(var ma=0;ma<la.length;ma++)if(la[ma].folder==o.MessagingTag.INBOX)return la[ma];return null;}m.subscribe('update-unseen',function(ka,la){ca(la);});m.subscribe('update-thread-ids',function(ka,la){ia(la);});g.subscribe(k.DUMP_EVENT,function(ka,la){la.messaging=la.messaging||{};la.messaging.unseen=h({},aa());la.messaging.unseen_max_count=s;la.messaging.unseen_time=r;});e.exports=x;});
__d("ChatTitleBarBlinker",["ChatActivity","DocumentTitle","JSLogger","MercuryThreadInformer","MercuryNotificationRenderer","PresenceState","MercuryTimestampTracker","MercuryUnseenState"],function(a,b,c,d,e,f){var g=b('ChatActivity'),h=b('DocumentTitle'),i=b('JSLogger'),j=b('MercuryThreadInformer'),k=b('MercuryNotificationRenderer'),l=b('PresenceState'),m=b('MercuryTimestampTracker'),n=b('MercuryUnseenState'),o=i.create('chat_title'),p=null,q=0,r=false;function s(){if(p){p.stop();p=null;return true;}return false;}function t(y){var z=y||m.getLastUserMessageTimestamp();if(q<=z){q=z;if(s()||r)l.doSync();}}var u={blink:function(y,z){if(!p&&q<z)k.renderDocumentTitle(y,function(aa){if(!p)p=h.blink(aa);});},stopBlinking:function(){t();},blinkingElsewhere:function(){r=true;}};function v(y){var z=l.verifyNumber(y.sb2);if(!z||z<=q)return null;return z;}function w(y){var z=y&&v(y);if(z){q=z;o.debug('load',q);s();r=false;}}function x(y){var z=v(y);if(!z){o.debug('store',q);y.sb2=q;r=false;}return y;}l.registerStateStorer(x);l.registerStateLoader(w);j.subscribe('thread-read-changed',function(y,z){var aa=m.getLastUserMessageTimestamp(),ba=0;for(var ca in z)if(z[ca].mark_as_read&&z[ca].timestamp>=aa&&z[ca].timestamp>ba)ba=z[ca].timestamp;ba&&t(ba);});g.subscribe('activity',function(){t();});(function(){var y=l.getInitial();if(y)q=v(y)||0;})();e.exports=u;});
__d("MercuryBrowserAlerts",["ArbiterMixin","ChatActivity","ChatConfig","ChatOptions","ChatTitleBarBlinker","copyProperties","MercuryParticipants","Sound","MercuryConstants"],function(a,b,c,d,e,f){var g=b('ArbiterMixin'),h=b('ChatActivity'),i=b('ChatConfig'),j=b('ChatOptions'),k=b('ChatTitleBarBlinker'),l=b('copyProperties'),m=b('MercuryParticipants'),n=b('Sound'),o=c('MercuryConstants');n.init(['audio/ogg','audio/mpeg']);function p(r){if(j.getSetting('sound'))n.play([i.get('sound.notif_ogg_url'),i.get('sound.notif_mp3_url')],r,false);}var q={messageReceived:function(r){var s=o.MessagingTag;if(r.author==m.user||!r.is_unread||(r.folder!=s.INBOX&&r.folder!=s.ARCHIVED))return;var t=h.isActive(),u=r.thread_id,v=r.timestamp;if(t){var w=false;q.inform('before-alert',{threadID:u,cancelAlert:function(){w=true;}});!w&&p(v);}else{k.blink(u,v);p(v);}k.blinkingElsewhere();}};e.exports=l(q,g);});
__d("VideoCallRecordMessageDialog",["Dialog","URI"],function(a,b,c,d,e,f){var g=b('Dialog'),h=b('URI'),i={get:function(j,k){return new g().setTitle(tx._("{firstname} n\u2019est pas disponible.",{firstname:k})).setBody("Voulez-vous laisser un message vid\u00e9o\u00a0?").setButtons([{name:'record-message',label:"Enregistrer un message"},g.CANCEL]).setHandler(function(){var l=h('/ajax/messaging/composer.php').setQueryData({ids:[j],autoloadvideo:true}).toString();g.bootstrap(l);});}};e.exports=i;});
__d("VideoCallCore",["event-extensions","Arbiter","AsyncRequest","AvailableList","AvailableListConstants","Bootloader","ChannelConstants","Cookie","Dialog","UserAgent","ge","ShortProfiles","VideoCallRecordMessageDialog"],function(a,b,c,d,e,f){b('event-extensions');var g=b('Arbiter'),h=b('AsyncRequest'),i=b('AvailableList'),j=b('AvailableListConstants'),k=b('Bootloader'),l=b('ChannelConstants'),m=b('Cookie'),n=b('Dialog'),o=b('UserAgent'),p=b('ge'),q=[],r={isSupported:function(){if(o.windows()){return (o.ie()>=7&&!o.ie64())||o.firefox()>=3.6||o.chrome()>=5||o.opera()>=12;}else if(o.osx()>10.4)return (o.firefox()>=3.6||o.chrome()>=5||o.safari()>=500||o.opera()>=12);return false;},isInstalled:function(){var v=false;if(this.isSupported())if(s()){var w=null;try{w=new ActiveXObject('SkypeLimited.SkypeWebPlugin');v=!!w;}catch(x){}w=null;}else v=t();return v;},mightReloadPostInstall:function(){return o.windows();},onVideoMessage:function(v){q.push(v);k.loadModules(['VideoCallController'],bagofholding);},setMessageHandler:function(v){this.onVideoMessage=v;if(v)while(q.length)v(q.shift());},availableForCall:function(v){var w=i.get(v);return w==j.ACTIVE||w==j.IDLE;},onProfileButtonClick:function(v){r.startCallOrLeaveMessage(v,'profile_button_click');},attachListenerToProfileButton:function(v){var w=p('videoCallProfileButton');if(w)Event.listen(w,'click',function(event){r.startCallOrLeaveMessage(v,'profile_button_click_timeline');});},startCallOrLeaveMessage:function(v,w){if(this.availableForCall(v)){r.showOutgoingCallDialog(v,w);}else b('ShortProfiles').get(v,function(x){b('VideoCallRecordMessageDialog').get(v,x.firstName).show();});},showOutgoingCallDialog:function(v,w){var x=w||'unknown';r.logClick(v,x);var y=r.isInstalled()?'outgoing_dialog.php':'intro.php',z='/ajax/chat/video/'+y+'?idTarget='+v;new n().setAllowCrossPageTransition(true).setAsync(new h(z)).show();},logClick:function(v,w){new h().setURI('/ajax/chat/video/log_click.php').setData({targetUserID:v,clickSource:w}).setAllowCrossPageTransition(true).setErrorHandler(bagofholding).send();}};function s(){return o.ie()&&o.windows()&&!o.opera();}function t(){if(!navigator)return null;navigator.plugins.refresh(false);var v=navigator.mimeTypes['application/skypesdk-plugin'];return v&&v.enabledPlugin;}function u(){if(!r.mightReloadPostInstall())return;var v=m.get('vcpwn');if(v){m.clear('vcpwn');var w=m.get('vctid');if(w){m.clear('vctid');if(m.get('vctid'))return;if(w&&r.isInstalled()){var x='/ajax/chat/video/outgoing_dialog.php?idTarget='+w;new n().setAllowCrossPageTransition(true).setAsync(new h(x)).show();}}}}g.subscribe(l.getArbiterType('video'),function(v,w){r.onVideoMessage(w.obj);});g.subscribe(l.getArbiterType('chat_event'),function(v,w){if(w.obj.event_name=="missed-call")k.loadModules(['VideoCallController'],function(x){x.onMissedCallEvent(w.obj);});});u();e.exports=r;});
__d("ChatApp",["CSS","$","copyProperties"],function(a,b,c,d,e,f){var g=b('CSS'),h=b('$'),i=b('copyProperties'),j=false,k=false,l=false;function m(n,o){m.init(h('fbDockChat'),n,o);}i(m,{init:function(n,o,p){this.root=n;d(['TabsViewport','ChatTabController','ChatTabViewCoordinator','MercuryServerRequests','MercuryChannelHandler','MercuryStateCheck'],function(q,r,s,t,u,v){t.handleUpdate(p);this.tabsViewport=new q(o);this.tabController=new r(this.tabsViewport);this.tabViewCoordinator=new s(o,this.tabsViewport);j=k=true;}.bind(this));},hide:function(){if(!j||l)return;g.hide(this.root);l=true;},unhide:function(){if(j){if(l){g.show(this.root);this.tabsViewport.checkWidth();d(['Dock'],function(n){n.resizeAllFlyouts();});l=false;}}else if(!k){d(['UIPagelet'],function(n){n.loadFromEndpoint('DockChatPagelet','pagelet_chat');});k=true;}}});e.exports=m;});
__d("ChatTabModel",["function-extensions","Arbiter","ArbiterMixin","ChatBehavior","ChatConfig","copyProperties","JSLogger","MercuryAssert","MercuryServerRequests","MercuryThreads","MercuryTimestampTracker","PresenceState","PresenceUtil","areObjectsEqual","PresenceInitialData"],function(a,b,c,d,e,f){b('function-extensions');var g=b('Arbiter'),h=b('ArbiterMixin'),i=b('ChatBehavior'),j=b('ChatConfig'),k=b('copyProperties'),l=b('JSLogger'),m=b('MercuryAssert'),n=b('MercuryServerRequests'),o=b('MercuryThreads'),p=b('MercuryTimestampTracker'),q=c('PresenceInitialData'),r=b('PresenceState'),s=b('PresenceUtil'),t=b('areObjectsEqual'),u=[],v=null,w=null,x=null,y=null;function z(){return parseInt(q.serverTime,10);}var aa=j.get('tab_max_load_age')||3600000,ba=z()-aa,ca=0,da=20,ea=l.create('chat_tab_model'),fa=false;function ga(xa){var ya=r.verifyNumber(xa.uct2);if(!ya||typeof ya!=='number'){ea.warn('bad_cookie_version',xa.uct2);return null;}if(ya<=ca||ya<ba)return null;return ya;}function ha(xa){var ya=ga(xa);if(!ya){var za={};za.old_tabs=xa&&xa.t2&&JSON.stringify(xa.t2);za.old_promoted=xa&&xa.lm2;za.old_time=xa&&xa.uct2;za.old_reason=xa&&xa.tr;za.old_window=xa&&xa.tw;var ab;if(w&&xa.t2)for(var bb=0;bb<xa.t2.length;bb++){var cb=xa.t2[bb];if(cb.i===w)ab=cb.r;}var db=[];u.forEach(function(eb){if(!eb.fragile){var fb={i:eb.id,si:eb.server_id};if(eb.raised||(eb.id===w&&ab))fb.r=1;db.push(fb);}});xa.t2=db;xa.uct2=ca;xa.lm2=v;xa.tr=y;xa.tw=s.getSessionID();za.new_tabs=JSON.stringify(xa.t2);za.new_promoted=xa.lm2;za.new_time=xa.uct2;za.new_reason=xa.tr;za.new_window=xa.tw;ea.debug('store',za);}return xa;}function ia(xa){if(xa){var ya=ga(xa);if(ya){var za={};za.old_tabs=JSON.stringify(u);za.old_promoted=v;za.old_time=ca;za.old_reason=y;za.window_id=s.getSessionID();za.cookie_tabs=xa&&xa.t2&&JSON.stringify(xa.t2);za.cookie_promoted=xa&&xa.lm2;za.cookie_time=xa&&xa.uct2;za.cookie_reason=xa&&xa.tr;za.cookie_window=xa&&xa.tw;ca=ya;y='load';var ab=ja(xa.t2,xa.lm2||null);za.load_result=ab;za.new_tabs=JSON.stringify(u);za.new_promoted=v;za.new_time=ca;za.new_reason=y;var event='load';if(!fa)event+='_init';ea.log(event,za);return ab;}}return false;}function ja(xa,ya){if(ka(xa,ya)){var za=u.filter(function(cb){return cb.fragile;}),ab={};v=null;u=xa.map(function(cb){var db={id:cb.i,server_id:cb.si};if(db.id==ya)v=db.id;if(w==cb.i){var eb=pa(w);if(eb!=-1){db.raised=u[eb].raised;return db;}else return null;}if(cb.r)db.raised=true;ab[db.id]=db;return db;});u=u.filter(function(cb){return cb!=null;});if(x)for(var bb in x)if(!ab[bb]||!ab[bb].raised)delete x[bb];za=za.filter(function(cb){return !ab[cb.id];});u=u.concat(za);oa();return true;}return false;}function ka(xa,ya){if(ya!=v)return true;var za=u.filter(function(cb){return !cb.fragile;});if(xa.length!=za.length)return true;for(var ab=0,bb=xa.length;ab<bb;ab++){if(xa[ab].id===w)continue;if(!t(xa[ab],za[ab]))return true;}return false;}function la(xa,ya,za){var ab=ia(r.get());if(ya===undefined||ya>ca){if(xa()){ab=true;y=za||null;na(ya);}}else ea.error('rejected',{change_time:ya,state_time:ca});ab&&ma();}function ma(){if(fa)va.inform('chat/tabs-changed',va.get());}function na(xa){if(xa===undefined)xa=Math.max(p.getLastUserMessageTimestamp()||1,ca+1);ca=xa;r.doSync();}function oa(){var xa=u.length-da;if(xa>0)u=u.filter(function(ya){return ya.raised||xa--<=0;});}function pa(xa){for(var ya=0;ya<u.length;ya++)if(u[ya].id==xa)return ya;return -1;}function qa(xa){var ya=o.getThreadMetaNow(xa);if(!ya)return false;if(ya.is_canonical_user||ya.is_canonical_group){return sa(xa);}else{var za=ra(xa);if(za)n.getServerThreadID(xa,function(ab){if(ta(xa,ab)){na();ma();}});return za;}}function ra(xa){if(pa(xa)===-1){u.push({id:xa,fragile:true});ea.log('open_fragile_tab',{tabs:JSON.stringify(u),opened:xa,window_id:s.getSessionID()});return true;}return false;}function sa(xa){var ya=pa(xa);if(ya!=-1)if(u[ya].fragile){u.splice(ya,1);}else return false;for(var za=0;za<=u.length;za++)if(za==u.length||u[za].fragile){u.splice(za,0,{id:xa});oa();ea.log('open_tab',{tabs:JSON.stringify(u),opened:xa,window_id:s.getSessionID()});return true;}}function ta(xa,ya){var za=pa(xa);if(za!=-1&&u[za].fragile){var ab=u[za];ab.fragile=false;ab.server_id=ya;var bb=[];u.forEach(function(cb){if(cb.id!=xa){if(ab&&cb.fragile){bb.push(ab);ab=null;}bb.push(cb);}});if(ab)bb.push(ab);u=bb;ea.log('make_permanent',{tabs:JSON.stringify(u),tab_id:xa,window_id:s.getSessionID()});return true;}return false;}function ua(xa){var ya=pa(xa);if(xa==v)v=null;if(ya!=-1){u.splice(ya,1);ea.log('close_tab',{tabs:JSON.stringify(u),closed:xa,window_id:s.getSessionID()});return true;}return false;}r.registerStateStorer(ha);r.registerStateLoader(function(xa){if(ia(xa))ma();});function va(){}k(va,h,{indexOf:function(xa){return pa(xa);},getTab:function(xa){m.isThreadID(xa);var ya=this.indexOf(xa);if(ya>-1){var za=u[ya];return k({},za);}return null;},closeAllTabs:function(){if(u.length){ea.log('close_all_tabs',{closed_tabs:JSON.stringify(u),window_id:s.getSessionID()});u=[];v=null;if(x)x={};na();ma();}},closeFragileTabs:function(){var xa=[];for(var ya=0;ya<u.length;ya++)if(u[ya].fragile){xa.push(u[ya]);u.splice(ya);ma();break;}ea.log('close_fragile_tabs',{tabs:JSON.stringify(u),fragile_closed:xa,window_id:s.getSessionID()});},closeTab:function(xa,ya){m.isThreadID(xa);var za=false;if(x){delete x[xa];za=true;}la(function(){if(ua(xa))za=true;return za;},undefined,ya);},closeTabAndDemote:function(xa,ya,za){m.isThreadID(xa);var ab=false;if(x){delete x[xa];ab=true;}la(function(){if(ua(xa)){if(v){var bb=pa(v);if(bb>ya){var cb=u.splice(bb,1)[0];u.splice(ya,0,cb);v=null;}}ab=true;}return ab;},undefined,za);},raiseTab:function(xa,ya){m.isThreadID(xa);var za=false;if(x&&ya){x[xa]=true;za=true;}if(!ya&&xa===w){za&&ma();return;}la(function(){if(qa(xa))za=true;var ab=pa(xa);if(ab!=-1&&!u[ab].raised){u[ab].raised=true;za=true;ea.log('raise_tab',{tabs:JSON.stringify(u),raised:xa,window_id:s.getSessionID()});}return za;});},get:function(){var xa=u.map(function(ya){var za=k({},ya);delete za.fragile;if(x)za.raised=x[za.id];return za;});return {tabs:xa,promoted:v};},openFragileTab:function(xa){m.isThreadID(xa);if(ra(xa))ma();},openTab:function(xa){m.isThreadID(xa);la(qa.curry(xa));},lowerTab:function(xa){m.isThreadID(xa);var ya=false;if(x){delete x[xa];ya=true;}la(function(){var za=pa(xa);if(za!=-1&&u[za].raised){delete u[za].raised;ea.log('lower_tab',{tabs:JSON.stringify(u),lowered:xa,window_id:s.getSessionID()});ya=true;}return ya;});},raiseAndPromoteTab:function(xa,ya,za,ab){m.isThreadID(xa);var bb=false;if(x&&ya){x[xa]=true;bb=true;}if(!ya&&xa===w){bb&&ma();return;}la(function(){if(qa(xa))bb=true;var cb=pa(xa);if(cb!=-1&&(!u[cb].raised||v!=xa)){u[cb].raised=true;v=xa;bb=true;ea.log('raise_and_promote_tab',{tabs:JSON.stringify(u),promoted:xa,window_id:s.getSessionID()});}return bb;},za,ab);},squelchTab:function(xa){m.isThreadID(xa);w=xa;this.lowerTab(xa);ea.log('squelch_tab',{squelched:xa,tabs:JSON.stringify(u),window_id:s.getSessionID()});},clearSquelchedTab:function(){if(w)ea.log('unsquelch_tab',{squelched:w,tabs:JSON.stringify(u),window_id:s.getSessionID()});w=null;}});g.subscribe(l.DUMP_EVENT,function(xa,ya){ya.chat_tabs={promoted:v,tabs:u.map(function(za){return k({},za);}),time:ca,max_load_age:aa};});function wa(){var xa=i.ignoresRemoteTabRaise();if(xa&&!x){ea.log('start_ignore_remote_raise');x={};ma();}else if(!xa&&x){ea.log('stop_ignore_remote_raise');x=null;ma();}}i.subscribe(i.ON_CHANGED,wa);wa();ia(r.getInitial(),true);if(ca===0)ca=z()-600000;fa=true;e.exports=va;});
__d("VideoCallPromo",["ArbiterMixin","AsyncRequest","AvailableList","AvailableListConstants","ChatConfig","ChatVisibility","ContextualDialogX","copyProperties","CSS","MercuryThreads","MercuryParticipants","VideoCallCore","ChatTabTemplates"],function(a,b,c,d,e,f){var g=b('ArbiterMixin'),h=b('AsyncRequest'),i=b('AvailableList'),j=b('AvailableListConstants'),k=b('ChatConfig'),l=b('ChatVisibility'),m=b('ContextualDialogX'),n=b('copyProperties'),o=b('CSS'),p=b('MercuryThreads'),q=b('MercuryParticipants'),r=c('ChatTabTemplates'),s=b('VideoCallCore');function t(){this._dialog=null;}function u(w){if(!(s.isSupported()&&k.get('video.show_promo')))return false;var x=p.getCanonicalUserInThread(w);if(!x)return false;return l.isOnline()&&s.availableForCall(x);}function v(w){new h().setURI('/ajax/chat/video/log_promo.php').setData({viewedUserID:w}).setAllowCrossPageTransition(true).setErrorHandler(bagofholding).send();}n(t.prototype,g);n(t.prototype,{render:function(w,x){var y=u(x);if(!y)return;var z=p.getCanonicalUserInThread(x);q.get('fbid:'+z,function(aa){if(!aa.call_promo)return;var ba=r[':fb:mercury:call:promo'].build();this._dialog=new m();this._dialog.init(ba.getRoot()).setWidth(250).setAlignH('center').setContext(w).show();o.addClass(this._dialog.getRoot(),'uiContextualDialogWithFooterArrowBottom');o.addClass(w,'video_call_promo');v(p.getCanonicalUserInThread(x));this.inform('chat/dialog-rendered',{dialog:this,thread_id:x});}.bind(this));},updatePosition:function(){if(this._dialog&&this._dialog.isShown())this._dialog.updatePosition();},hide:function(){if(this._dialog&&this._dialog.isShown()){this._dialog.hide();this._dialog=null;}}});e.exports=t;});
__d("VideoCallTourDialog",["ArbiterMixin","ContextualDialogX","copyProperties","CSS","MercuryThreads","VideoCallCore","VideoCallingTour","ChatTabTemplates"],function(a,b,c,d,e,f){var g=b('ArbiterMixin'),h=b('ContextualDialogX'),i=b('copyProperties'),j=b('CSS'),k=b('MercuryThreads'),l=c('ChatTabTemplates'),m=b('VideoCallCore'),n=b('VideoCallingTour');function o(){this._dialog=null;}i(o.prototype,g);i(o.prototype,{render:function(p,q){var r=k.getCanonicalUserInThread(q);if(!r||!m.availableForCall(r))return;var s=l[':fb:mercury:call:tour'].build();this._dialog=new h();this._dialog.init(s.getRoot()).setWidth(250).setAlignH('center').setContext(p).show();j.addClass(this._dialog.getRoot(),'uiContextualDialogWithFooterArrowBottom');j.addClass(p,'video_call_tour');this.inform('chat/dialog-rendered',{dialog:this,thread_id:q});n.inform('videocallingtour/end');},updatePosition:function(){if(this._dialog&&this._dialog.isShown())this._dialog.updatePosition();},hide:function(){if(this._dialog&&this._dialog.isShown()){this._dialog.hide();this._dialog=null;}}});e.exports=o;});
__d("ChatContextualDialogController",["event-extensions","ArbiterMixin","ChatTabModel","VideoCallingTour","VideoCallPromo","VideoCallTourDialog","copyProperties","setTimeoutAcrossTransitions"],function(a,b,c,d,e,f){b('event-extensions');var g=b('ArbiterMixin'),h=b('ChatTabModel'),i=b('VideoCallingTour'),j=b('VideoCallPromo'),k=b('VideoCallTourDialog'),l=b('copyProperties'),m=b('setTimeoutAcrossTransitions'),n=60000,o=false,p=false,q=function(x,y){this._videoCallPromo=new j();this._videoCallTour=new k();this._threadID=x;this._tabMainElement=y;this._openDialog=null;this._subscriptionTokens=[];this._scrollListener=null;this._timeout=null;};function r(x,event,y){if(x._openDialog)x._openDialog.updatePosition();}function s(x){if(x._openDialog)x._openDialog.updatePosition();}function t(x){if(x._openDialog){x._openDialog.hide();x._openDialog=null;}if(x._timeout){clearTimeout(x._timeout);x._timeout=null;}while(x._subscriptionTokens.length)x._subscriptionTokens.pop().unsubscribe();if(x._scrollListener){x._scrollListener.remove();x._scrollListener=null;}}function u(x,event,y){if(y.thread_id===x._threadID){x._openDialog=y.dialog;o=true;w(x);x._timeout=m(x.destroy.bind(x,x._threadID),n);x._scrollListener=Event.listen(window,'scroll',s.curry(x));}}function v(x,y){if(!x._openDialog){x._subscriptionTokens.push(y.subscribe('chat/dialog-rendered',u.curry(x)));y.render(x._tabMainElement,x._threadID);}}function w(x){x._subscriptionTokens.push(h.subscribe('chat/tabs-changed',r.curry(x)),q.subscribe('dialog/close-all',t.curry(x)));}l(q,g);l(q.prototype,{destroy:function(){t(this);},tabFocused:function(){if(p){v(this,this._videoCallTour);return;}if(!o)v(this,this._videoCallPromo);},tabNotActive:function(){t(this);},hideVideoCallouts:function(){t(this);}});i.subscribe('videocallingtour/start',function(){p=true;q.inform('dialog/close-all');});i.subscribe('videocallingtour/end',function(){p=false;});e.exports=q;});
__d("ChatPrivacyActionController",["Arbiter","ChatVisibility","JSLogger","PresencePrivacy","copyProperties"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('ChatVisibility'),i=b('JSLogger'),j=b('PresencePrivacy'),k=b('copyProperties'),l=function(m,n){this._userID=m;this._logger=i.create('blackbird');this._getState=function(){if(h.isOnline())return j.allows(this._userID)?l.NORMAL:l.BLOCKED;return l.OFFLINE;};this._togglePrivacy=function(){var o=this._getState();switch(this._getState()){case l.OFFLINE:if(h.isOnline()){this._logger.error('tabs_already_online');break;}this._logger.log('tabs_go_online',{tab_id:this._userID});h.goOnline(function(){if(!j.allows(this._userID)){if(this._getState()!==l.BLOCKED)this._logger.error('privacy_action_controller_blocked_inconsistency');this._togglePrivacy();}}.bind(this));break;case l.BLOCKED:j.allow(this._userID);this._logger.log('tabs_unblock',{tab_id:this._userID});break;case l.NORMAL:j.disallow(this._userID);this._logger.log('tabs_block',{tab_id:this._userID});break;}};(function(){var o=function(){n&&n(this._getState());}.bind(this);o();this._subscribeToken=j.subscribe('privacy-changed',o);}.bind(this)).defer();};l.OFFLINE='offline';l.BLOCKED='blocked';l.NORMAL='normal';k(l.prototype,{togglePrivacy:function(){this._logger.log('gear_menu_toggle_privacy',{tab_id:this._userID});this._togglePrivacy();},destroy:function(){j.unsubscribe(this._subscribeToken);}});e.exports=l;});
__d("MessagesEmoticonView",["event-extensions","function-extensions","DOM","InputSelection","Parent","TextAreaControl","Toggler","copyProperties","endsWith","startsWith"],function(a,b,c,d,e,f){b('event-extensions');b('function-extensions');var g=b('DOM'),h=b('InputSelection'),i=b('Parent'),j=b('TextAreaControl'),k=b('Toggler'),l=b('copyProperties'),m=b('endsWith'),n=b('startsWith'),o={smile:':)',frown:':(',tongue:':P',grin:'=D',gasp:':o',wink:';)',glasses:'8)',sunglasses:'B|',grumpy:'>:(',unsure:':/',cry:":'(",devil:'3:)',angel:'O:)',kiss:':*',heart:'<3',kiki:'^_^',squint:'-_-',confused:'o.O',upset:'>:o',pacman:':v',robot:':|]',colonthree:':3',penguin:'<(")',putnam:':putnam:',shark:'(^^^)','42':':42:',like:'(y)'};function p(r,s,t){var u=i.byClass(r,'emoteIcon');if(!u)return;var v='name_',w=null;u.className.split(' ').forEach(function(da){if(n(da,v))w=da.substring(v.length);});if(!o[w])return;var x=j.getInstance(s),y=x.getValue(),z=o[w],aa=y.substring(0,t.start),ba=y.substring(t.end);if(t.start>0&&!m(aa,' '))z=' '+z;if(!n(ba,' '))z+=' ';var ca=aa+z+ba;t.start+=z.length;t.end=t.start;x.setValue(ca);h.set(s,t.start,t.end);}function q(r,s){var t={start:0,end:0};function u(){t=h.get(s);}var v=g.find(r,'.uiToggleFlyout');this._subscription=k.subscribe('show',function(w,x){if(x.active&&g.contains(r,x.active))h.set(s,t.start,t.end);});this._eventListeners=[Event.listen(v,'click',function(event){k.hide(r);p(event.getTarget(),s,t);}),Event.listen(s,'keyup',u),Event.listen(s,'click',u)];}l(q.prototype,{destroy:function(){this._subscription.unsubscribe();while(this._eventListeners.length)this._eventListeners.pop().remove();}});e.exports=q;});
__d("MercuryAttachmentRenderer",["CSS","DOM","MercuryAttachment","MercuryMessages","MercuryParticipants","Style","tx","URI","MercuryAttachmentTemplates","MercuryConstants"],function(a,b,c,d,e,f){var g=b('CSS'),h=b('DOM'),i=b('MercuryAttachment'),j=b('MercuryMessages'),k=b('MercuryParticipants'),l=b('Style'),m=b('tx'),n=b('URI'),o=c('MercuryAttachmentTemplates'),p=c('MercuryConstants');function q(s,t){var u=o[t].build().setNodeContent('filename',s.name),v=u.getNode('link');v.setAttribute('href',s.url);s.rel&&v.setAttribute('rel',s.rel);g.addClass(u.getRoot(),i.getAttachIconClass(s.icon_type));return u;}var r={renderError:function(s){var t=o[':fb:mercury:attachment:error'].build();h.appendContent(t.getNode('error'),s.error_msg);return t.getRoot();},renderExternalLink:function(s){var t=o[':fb:mercury:attachment:external-link'].build().setNodeContent('name',s.name).setNodeContent('shortLink',s.base_url),u=t.getNode('preview');u.setAttribute('href',s.url);s.rel&&u.setAttribute('rel',s.rel);if(s.preview_url){var v=t.getNode('preview-image');v.setAttribute('src',s.preview_url);g.addClass(u,s.preview_class);g.show(v);}else{g.addClass(t.getRoot(),'noMedia');g.hide(u);}t.getNode('name').setAttribute('href',s.url);return t.getRoot();},renderFileLink:function(s){var t=':fb:mercury:attachment:file-link',u=q(s,t);return u.getRoot();},renderExtendedFileLink:function(s){var t=':fb:mercury:attachment:extended-file-link',u=q(s,t);if(s.open_url){var v=u.getNode('openLinkContainer');g.show(v);var w=u.getNode('openFile');w.setAttribute('href',s.open_url);}var x=u.getNode('downloadFile');x.setAttribute('href',s.url);s.rel&&x.setAttribute('rel',s.rel);return u.getRoot();},renderMusic:function(s){var t=o[':fb:mercury:attachment:music'].build().setNodeContent('filename',s.name),u=t.getNode('link');u.setAttribute('href',s.url);u.setAttribute('target','_blank');s.rel&&u.setAttribute('rel',s.rel);var v=t.getNode('preview');v.setAttribute('href',s.url);s.rel&&v.setAttribute('rel',s.rel);var w=t.getNode('preview-image');w.setAttribute('src',s.preview_url);g.show(w);g.addClass(t.getNode('icon_link'),'MercuryMusicIcon');return t.getRoot();},renderPreview:function(s,t,u,v){var w=o[':fb:mercury:attachment:preview'].build(),x=w.getNode('image-link');x.setAttribute('href',s.url);s.rel&&x.setAttribute('rel',s.rel);var y=s.preview_url;if(u)y+=u;var z=null;if(v)z=j.getMessagesFromIDs([v])[0];if(s.is_social_report_attachment&&z){var aa=null;k.get(z.author,function(ca){aa=h.create('a',{rel:'dialog-post',className:'SocialReportLink',id:'respond-link',ajaxify:n('/ajax/report/social_resolution/photo/').setQueryData({attachment_fbid:s.attach_id,photo_fbid:s.shared_object_id,sender_id:k.getUserID(ca.id)}).toString()});h.setContent(aa,m._("R\u00e9pondre \u00e0 la demande {name}",{name:ca.name}));});h.appendContent(w.getRoot(),aa);}var ba=w.getNode('preview-image');if(!t){g.show(ba);}else ba.onload=function(){var ca=ba.width,da=ba.height,ea,fa;if(ca>da){l.set(ba,'maxHeight',t+'px');fa=Math.min(da,t);ea=Math.ceil(ca*fa/da);}else{l.set(ba,'maxWidth',t+'px');ea=Math.min(ca,t);fa=Math.ceil(da*ea/ca);}l.set(ba,'marginTop','-'+(fa>>>1)+'px');l.set(ba,'marginLeft','-'+(ea>>>1)+'px');g.show(ba);};ba.setAttribute('src',y);g.addClass(x,s.preview_class);return w.getRoot();},renderMultiplePreviews:function(s){var t=s.length,u='singleImagePreview',v=0;if(t==2||t==4){u='doubleImagePreview';v=194;}else if(t>1){u='multipleImagePreview';v=129;}var w=h.create('div',{className:'imagePreviews'}),x='&numPreviews='+t;g.addClass(w,u);for(var y=0;y<t;++y){var z=this.renderPreview(s[y],v,x);h.appendContent(w,z);}return w;},renderShareLink:function(s){var t=o[':fb:mercury:attachment:share-link'].build().setNodeContent('name',s.name),u=t.getNode('link');u.setAttribute('href',s.url);s.rel&&u.setAttribute('rel',s.rel);return t.getRoot();},renderVideoThumb:function(s){var t=o[':fb:mercury:attachment:video-thumb'].build(),u=t.getNode('thumb');u.setAttribute('href',s.url);u.setAttribute('rel',s.rel);var v=h.find(t.getRoot(),'img');v.src=s.preview_url;return t.getRoot();}};e.exports=r;});
__d("MercuryRoger",["ArbiterMixin","MercuryServerRequests","LiveTimer","copyProperties"],function(a,b,c,d,e,f){var g=b('ArbiterMixin'),h=b('MercuryServerRequests'),i=b('LiveTimer'),j=b('copyProperties'),k={},l={getSeenBy:function(m){if(!m)return [];var n=[],o=k[m.thread_id];for(var p in o)if(o[p]>m.timestamp&&p!=m.author)n.push(p);return n;},getSeenTimestamp:function(m,n){var o=k[m];return o?o[n]:null;}};j(l,g);h.subscribe('update-roger',function(m,n){for(var o in n){if(!k[o])k[o]={};for(var p in n[o]){var q=k[o][p],r=n[o][p];if(!q||r>q)k[o][p]=r;}}if(n)l.inform('state-changed',n);});e.exports=l;});
__d("MercuryTypingReceiver",["Arbiter","ChannelConstants","MercuryParticipants","MercuryServerRequests","MercuryThreads","TypingDetector","setTimeoutAcrossTransitions","MercuryConstants"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('ChannelConstants'),i=b('MercuryParticipants'),j=b('MercuryServerRequests'),k=b('MercuryThreads'),l=b('TypingDetector'),m=b('setTimeoutAcrossTransitions'),n=c('MercuryConstants'),o,p={},q=30000,r=new g();function s(x){var y=p[x]||{},z=Object.keys(y);z.sort(function(aa,ba){return y[aa]-y[ba];});return z;}function t(){o=null;var x=Date.now(),y={},z=false;for(var aa in p){var ba=false;for(var ca in p[aa]||{})if(p[aa][ca]<x-q){delete p[aa][ca];ba=true;}else z=true;if(ba)y[aa]=s(aa);}for(var da in y){r.inform('state-changed',y);break;}if(z)o=m(t,3000);}function u(x,y){if(x in p)if(y in p[x]){delete p[x][y];v(x);}}function v(x){var y={};y[x]=s(x);r.inform('state-changed',y);}function w(x){if(x.thread)return j.getClientThreadIDNow(x.thread);if(x.type==='typ')return k.getThreadIdForUser(x.from);return null;}g.subscribe([h.getArbiterType('typ'),h.getArbiterType('ttyp')],function(x,y){var z=y.obj,aa=w(z);if(aa){var ba=i.getIDForUser(z.from);if(z.st==l.TYPING){p[aa]=p[aa]||{};var ca=p[aa][ba];p[aa][ba]=Date.now();if(!o)o=m(t,3000);!ca&&v(aa);}else if(z.st==l.INACTIVE)u(aa,ba);}});j.subscribe('update-typing-state',function(x,y){var z=y.payload_source;if(z!=n.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE)return;var aa=y.actions;if(!aa||!aa.length)return;var ba=n.MercuryActionType.USER_GENERATED_MESSAGE;aa.forEach(function(ca){if(ca.action_type==ba&&ca.author!=i.user)u(ca.thread_id,ca.author);});});e.exports=r;});
__d("ChatTabIndicatorController",["ArbiterMixin","ChatConfig","DOM","LiveTimer","MercuryParticipants","MercuryRoger","MercuryThreads","MercuryTypingReceiver","copyProperties","setTimeoutAcrossTransitions","tx","date-extensions","MercuryConfig","MercuryConstants"],function(a,b,c,d,e,f){var g=b('ArbiterMixin'),h=b('ChatConfig'),i=b('DOM'),j=b('LiveTimer'),k=b('MercuryParticipants'),l=b('MercuryRoger'),m=b('MercuryThreads'),n=b('MercuryTypingReceiver'),o=b('copyProperties'),p=b('setTimeoutAcrossTransitions'),q=b('tx');b('date-extensions');var r=c('MercuryConfig'),s=c('MercuryConstants'),t=r['roger.seen_delay'],u=[];function v(w){this._threadID=w;this._canonicalUser=m.getCanonicalUserInThread(w);u.push(this);}o(v.prototype,g,{destroy:function(){u.remove(this);},setLastMessage:function(w){this._lastMsg=w;if(this._stateChangeTimeout){clearTimeout(this._stateChangeTimeout);this._stateChangeTimeout=null;}if(w){var x=t,y=s.MercuryActionStatus.SUCCESS;if(w.action_id||w.status==y){var z=j.getApproximateServerTime();x=w.timestamp+t-z;}if(x>0)this._stateChangeTimeout=p(function(){this._stateChangeTimeout=null;this._handleStateChange();}.bind(this),x);}this._handleStateChange();},_informStateChanged:function(w){if(w.activity=='none'&&this._currentActivity=='none')return;this._currentActivity=w.activity;this.inform('state-changed',w);},_notifySentFrom:function(){var w=s.MercurySourceType,x,y,z=this._lastMsg.location_text;if(z){x=q._("Envoy\u00e9 depuis {location}",{location:z});y='sentFromMobile';}else switch(this._lastMsg.source){case w.CHAT_ORCA:case w.TITAN_ORCA:x=i.create('a',{href:'/mobile/messenger','class':'fcg',target:'_blank'},"Envoy\u00e9 depuis Messenger");y='sentFromMobile';break;case w.MOBILE:case w.CHAT_IPHONE:case w.TITAN_API_MOBILE:case w.TITAN_WAP:x=i.create('a',{href:'/mobile','class':'fcg',target:'_blank'},"Envoy\u00e9 depuis un mobile");y='sentFromMobile';break;case w.EMAIL:case w.TITAN_EMAIL_REPLY:x="Envoy\u00e9 par courrier \u00e9lectronique";y='sentFromEmail';break;default:this._informStateChanged({activity:'none'});return;}this._informStateChanged({activity:y,text:x});},_notifySeenTimestamp:function(w){var x=l.getSeenTimestamp(this._threadID,w[0])*.001,y=Date.now()*.001,z=r['24h_times']?'H:i':'g:i A';if(x<y-518400){z='M j';}else if(x<y-86400)z='D '+z;var aa=Date.format(z,x);this._informStateChanged({activity:'seen-timestamp',text:q._("Vu\u00a0: {timestamp}",{timestamp:aa})});},_notifySeenBy:function(w){var x=this._lastMsg,y=true;k.getMulti(w,function(z){y=false;if(this._lastMsg!=x)return;var aa=m.getThreadMetaNow(this._threadID),ba=aa?aa.participants.length:0,ca=w.length+(x.author!=k.user),da,ea=false;if(ba>2&&ca>=ba-1){da="Vu par tout le monde";}else if(w.length==1){da=q._("Vu par {user}",{user:z[w[0]].short_name});}else if(w.length==2){da=q._("Vu par {user1}, {user2}",{user1:z[w[0]].short_name,user2:z[w[1]].short_name});}else if(w.length==3){da=q._("Vu par {user1}, {user2}, {user3}",{user1:z[w[0]].short_name,user2:z[w[1]].short_name,user3:z[w[2]].short_name});}else if(w.length>3){var fa=Object.keys(z).length-2,ga=q._("{num} autres",{num:fa}),ha=i.create('span',{className:'more'},ga);da=i.tx._("Vu par {user1}, {user2}, {=num more link}",{user1:z[w[0]].short_name,user2:z[w[1]].short_name,'=num more link':ha});ea=true;}this._informStateChanged({activity:'seen-by',text:da,seenBy:w,tooltip:ea});}.bind(this));y&&this._informStateChanged({activity:'none'});},_notifyTyping:function(w){var x=this._lastMsg,y=true;k.getMulti(w,function(z){y=false;if(this._lastMsg!=x)return;if(this._canonicalUser||h.get('chat_multi_typ')){var aa=m.getThreadMetaNow(this._threadID),ba=aa?aa.participants.length:0,ca,da=false;if(ba>2&&w.length>=ba-1){ca="Everyone is typing...";}else if(w.length==1){ca=q._("{name} est en train d\u2019\u00e9crire...",{name:z[w[0]].short_name});}else if(w.length==2){ca=q._("{user1} and {user2} are typing...",{user1:z[w[0]].short_name,user2:z[w[1]].short_name});}else if(w.length==3){ca=q._("{user1}, {user2}, and {user3} are typing...",{user1:z[w[0]].short_name,user2:z[w[1]].short_name,user3:z[w[2]].short_name});}else if(w.length>3){var ea=Object.keys(z).length-2,fa=q._("{num} de plus",{num:ea}),ga=i.create('a',{href:'#'},fa);ca=i.tx._("{user1}, {user2}, and {=num more link} are typing...",{user1:z[w[0]].short_name,user2:z[w[1]].short_name,'=num more link':ga});da=true;}this._informStateChanged({activity:'typing',text:ca,typing:w,tooltip:da});}}.bind(this));y&&this._informStateChanged({activity:'none'});},_handleStateChange:function(){var w=s.MercuryActionType.LOG_MESSAGE;if(!this._lastMsg||this._lastMsg.action_type==w){this._informStateChanged({activity:'none'});return;}if(this._typing&&this._typing.length){this._notifyTyping(this._typing);return;}if(this._canonicalUser&&this._lastMsg.author!=k.user){this._notifySentFrom();return;}if(!this._stateChangeTimeout){var x=l.getSeenBy(this._lastMsg);if(x.length)if(this._canonicalUser){this._notifySeenTimestamp(x);return;}else{this._notifySeenBy(x);return;}}this._informStateChanged({activity:'none'});}});n.subscribe('state-changed',function(w,x){u.forEach(function(y){var z=x[y._threadID];if(z!==undefined){y._typing=z;y._handleStateChange();}});});l.subscribe('state-changed',function(w,x){u.forEach(function(y){if(x[y._threadID]&&!y._stateChangeTimeout)y._handleStateChange();});});e.exports=v;});
__d("ChatTabIndicatorLine",["ChatTabIndicatorController","CSS","DOM","DOMQuery","MercuryParticipants","Tooltip","copyProperties","csx"],function(a,b,c,d,e,f){var g=b('ChatTabIndicatorController'),h=b('CSS'),i=b('DOM'),j=b('DOMQuery'),k=b('MercuryParticipants'),l=b('Tooltip'),m=b('copyProperties'),n=b('csx');function o(p,q,r){this._typingIndicator=q;this._messagesView=r;this._controller=new g(p);this._subscription=this._controller.subscribe('state-changed',this._handleStateChanged.bind(this));}m(o.prototype,{destroy:function(){this._setClass(null);this._subscription.unsubscribe();this._controller.destroy();},setLastMessage:function(p){this._controller.setLastMessage(p);},_handleStateChanged:function(p,q){var r=this._messagesView.isScrolledToBottom();this._rerender(q);r&&this._messagesView.scrollToBottom();},_rerender:function(p){if(p.activity=='none'){this._setClass(null);return;}var q=i.find(this._typingIndicator,".-cx-PRIVATE-mercuryTypingIndicator__text");if(p.text){i.setContent(q,p.text);}else i.empty(q);if(p.activity.substring(0,4)=='seen'){this._setClass('seen');if(p.activity=='seen-by'&&p.tooltip)k.getMulti(p.seenBy,function(r){var s=i.create('div'),t=0;for(var u in r)if(t++>=2){var v=i.create('div');i.setContent(v,r[u].name);i.appendContent(s,v);}var w=j.find(this._typingIndicator,'span.more');l.set(w,s,'above','center');}.bind(this));}else this._setClass(p.activity);},_setClass:function(p){if(this._lastClass===p)return;this._lastClass&&h.removeClass(this._typingIndicator,this._lastClass);p&&h.addClass(this._typingIndicator,p);this._lastClass=p;}});e.exports=o;});
__d("MercuryEmoji",["Emoji","Emote","MercuryConfig"],function(a,b,c,d,e,f){var g=b('Emoji'),h=b('Emote'),i=c('MercuryConfig'),j={htmlEmojiAndEmote:function(k,l){if(i.MessagingDisplayEmojiGK){return g.htmlEmojiAndEmote(k,l);}else return h.htmlEmote(k,l);}};e.exports=j;});
__d("MercurySeenByAll",["CSS","DataStore","DOM","MercuryMessages","MercuryParticipants","MercuryRoger","MercuryThreads"],function(a,b,c,d,e,f){var g=b('CSS'),h=b('DataStore'),i=b('DOM'),j=b('MercuryMessages'),k=b('MercuryParticipants'),l=b('MercuryRoger'),m=b('MercuryThreads'),n={},o={updateOnSeenChange:function(r,s){n[r.tagName]=true;h.set(r,'thread-id',s.thread_id);g.addClass(r,'seenByListener');p(r,s);}};function p(r,s){var t=s.participants.filter(function(w){return w!==k.user;}),u=q(s),v=s.participants.length>0&&s.participants[0]===k.user;g.conditionClass(r,'repliedLast',v);g.conditionClass(r,'seenByAll',v&&l.getSeenBy(u).length===t.length);}function q(r){return {author:k.user,thread_id:r.thread_id,timestamp:r.timestamp};}l.subscribe('state-changed',function(r,s){for(var t in n){var u=i.scry(document.body,t+'.seenByListener');for(var v=0;v<u.length;v++){var w=u[v],x=h.get(w,'thread-id');if(s[x])m.getThreadMeta(x,function(y){p(w,y);});}}});e.exports=o;});
__d("WebMessengerPermalinkConstants",["URI"],function(a,b,c,d,e,f){var g=b('URI'),h={ARCHIVED_PATH:'/messages/archived',BASE_PATH:'/messages',OTHER_PATH:'/messages/other',SPAM_PATH:'/messages/spam',COMPOSE_POSTFIX_PATH:'/new',SEARCH_POSTFIX_PATH:'/search',TID_POSTFIX_PARTIAL_PATH:'/conversation-',getURIPathForThreadID:function(i,j){return (j||h.BASE_PATH)+h.TID_POSTFIX_PARTIAL_PATH+g.encodeComponent(g.encodeComponent(i));},getThreadIDFromURI:function(i){var j=i.getPath().match(h.BASE_PATH+'(/[^/]+)*'+h.TID_POSTFIX_PARTIAL_PATH+'([^/]+)');if(j){var k=g.decodeComponent(g.decodeComponent(j[2]));return k;}},getCanonicalUserID:function(i){var j=i.match('(.*/)+(\\d+)$');return j&&parseInt(j[2],10);}};e.exports=h;});
__d("MercuryThreadMetadataRenderer",["event-extensions","CSS","DOM","HTML","MercuryAttachment","MercuryEmoji","MercuryMessages","MercuryParticipants","MercurySeenByAll","MercuryServerRequests","MercuryThreads","Tooltip","URI","WebMessengerPermalinkConstants","cx","createArrayFrom","tx","MercuryImageTemplates","MercuryThreadlistIconTemplates","MercuryStatusTemplates","MercuryConstants","MercuryConfig"],function(a,b,c,d,e,f){b('event-extensions');var g=b('CSS'),h=b('DOM'),i=b('HTML'),j=b('MercuryAttachment'),k=b('MercuryEmoji'),l=b('MercuryMessages'),m=b('MercuryParticipants'),n=b('MercurySeenByAll'),o=b('MercuryServerRequests'),p=b('MercuryThreads'),q=b('Tooltip'),r=b('URI'),s=b('WebMessengerPermalinkConstants'),t=b('cx'),u=c('MercuryImageTemplates'),v=c('MercuryThreadlistIconTemplates'),w=c('MercuryStatusTemplates'),x=c('MercuryConstants'),y=c('MercuryConfig'),z=b('createArrayFrom'),aa=b('tx');e.exports={renderTimestamp:function(ea,fa,ga,ha){if(ha){if(!fa)fa=(new Date(ha)).toLocaleDateString();ea.setAttribute('title',fa);if(!ga)ga=Date.format(y['24h_times']?'H:i':'g:ia',Math.floor(ha/1000));h.setContent(ea,ga);g.show(ea);}},renderMessageSourceTags:function(ea,fa,ga,ha){var ia=x.MercuryMessageSourceTags,ja='',ka='',la='';if(ga.contains(ia.MESSENGER)){ja="Envoy\u00e9 depuis Messenger";ka=new r('/mobile/messenger');la="-cx-PRIVATE-webMessengerMessageGroup__sourceMessenger";}else if(ga.contains(ia.CHAT)){ja="Envoy\u00e9 depuis la discussion instantan\u00e9e";la="-cx-PRIVATE-webMessengerMessageGroup__sourceChat";}else if(ga.contains(ia.EMAIL)){if(ha){ja=aa._("envoy\u00e9s \u00e0 partir d\u2019un {email}",{email:ha});}else ja="Envoy\u00e9 par courrier \u00e9lectronique";la="-cx-PRIVATE-webMessengerMessageGroup__sourceEmail";}else if(ga.contains(ia.MOBILE)){ja="Envoy\u00e9 depuis un mobile";ka=new r('/mobile/');la="-cx-PRIVATE-webMessengerMessageGroup__sourceMobile";}if(la){q.set(ea,ja);g.addClass(fa,la);if(ka){ea.setAttribute('href',ka);}else ea.removeAttribute('href');}else g.hide(ea);},renderMessageLocation:function(ea,fa,ga){var ha=r('/ajax/messaging/hovercard/map.php').setQueryData(ga);ea.setAttribute('data-hovercard',ha);g.removeClass(ea,"-cx-PRIVATE-webMessengerMessageGroup__noLocation");g.show(fa);},renderSpoofWarning:function(ea,fa,ga){if(fa){g.addClass(ea,"-cx-PRIVATE-webMessengerMessageGroup__spoofWarning");q.set(ea,aa._("Impossible de confirmer {name_or_email} en tant qu\u2019exp\u00e9diteur.",{name_or_email:ga.name}));}},renderCoreThreadlist:function(ea,fa,ga,ha,ia){p.getThreadMeta(ea,function(ja){ha=ha||{};this.renderThreadImage(ja.thread_id,fa.getNode('image'));da(ja.thread_id,fa.getNode('name'),ha);if(ja.folder&&ia)ca(fa.getNode('folderBadge'),ja.folder);var ka=fa.getNode('timestamp');this.renderTimestamp(ka,ja.timestamp_absolute,ja.timestamp_relative,ja.timestamp);this.renderSnippet(ja.thread_id,fa.getNode('snippet'));ga(fa,ja);}.bind(this));},renderCommaSeparatedParticipantList:function(ea,fa,ga){ga=ga||{};ga.last_separator_uses_and=false;return da(ea,fa,ga);},renderAndSeparatedParticipantList:function(ea,fa,ga){ga=ga||{};ga.last_separator_uses_and=true;return da(ea,fa,ga);},renderSnippet:function(ea,fa){p.getThreadMeta(ea,function(ga){var ha=h.create('span');g.addClass(ha,'MercuryRepliedIndicator');h.appendContent(fa,ha);n.updateOnSeenChange(ha,ga);if(ga.snippet_has_attachment)if(!ga.snippet&&ga.snippet_attachments){ga.snippet_attachments.forEach(function(ka){if(ka.attach_type!=x.MercuryAttachmentType.FILE)return;var la=j.getAttachIconClass(ka.icon_type),ma=v[':fb:mercury:attachment-icon-text'].build().getRoot();h.appendContent(ma,ka.name);g.addClass(ma,la);h.appendContent(fa,ma);}.bind(this));}else h.appendContent(fa,h.create('span',{className:'MercuryAttachmentIndicator'}));if(ga.is_forwarded_snippet){var ia;if(ga.snippet){ia="Message transf\u00e9r\u00e9\u00a0:";}else ia="Message transf\u00e9r\u00e9";h.appendContent(fa,h.create('strong',{className:'mercuryForwardedIndicator'},ia));}var ja=ga.snippet;if(ja)if(ja.substr(0,4)=='?OTR'){ja="[message chiffr\u00e9]";}else ja=ja.replace(/\r\n|[\r\n]/g," ");h.appendContent(fa,i(k.htmlEmojiAndEmote(ja)));}.bind(this));},renderTitanLink:function(ea,fa,ga){var ha=ea.indexOf(':'),ia=new r().setSubdomain('www');if(ea.substr(0,ha)=='user'){ia.setPath('/messages/'+ea.substr(ha+1));fa.setAttribute('href',ia.toString());ga&&ga();}else o.getServerThreadID(ea,function(ja){if(y.MessagesMercuryIntegrationGK){ia.setPath(s.getURIPathForThreadID(ja));}else{ia.setPath('/messages/');ia.setQueryData({action:'read',tid:ja});}fa.setAttribute('href',ia.toString());ga&&ga();});},renderThreadImage:function(ea,fa){p.getThreadMeta(ea,function(ga){if(ga.image_src){this._renderThreadImageSingle(ga.image_src,fa);return;}var ha=[],ia=ga.participants.filter(function(ja){return ja!=m.user;});if(!ia.length){ha=[m.user];}else if(ia.length==1){ha=[ia[0]];}else{ha=ia.slice(0,3);if(ha.length==2)ha.push(m.user);}m.getMulti(ha,function(ja){var ka=ha.map(function(la){return ja[la];});this.renderParticipantImages(ka,fa);}.bind(this));}.bind(this));},renderParticipantImages:function(ea,fa){if(ea.length>2){this._renderThreadImageSplit(ea,fa);}else this._renderThreadImageSingle(ea[0].image_src,fa);},renderErrorIndicator:function(ea,fa){var ga=w[':fb:mercury:error-indicator'].render(),ha;switch(ea){case x.MercuryActionStatus.REQUEST_ERROR:case x.MercuryActionStatus.TRANSPORT_ERROR:case x.MercuryActionStatus.FAILED_UNKNOWN_REASON:case x.MercuryActionStatus.UNABLE_TO_CONFIRM:ha="Le message n\u2019a pas pu \u00eatre envoy\u00e9. Cliquez pour le renvoyer.";break;default:throw new Error('Invalid error code '+ea);}q.set(ga,ha,'above','center');if(fa){Event.listen(ga,'click',fa);g.addClass(ga,'mercuryClickableErrorIndicator');}return ga;},renderResendIndicator:function(){return w[':fb:mercury:resend-indicator'].render();},renderStatusIndicator:function(ea,fa){var ga=x.MercuryActionStatus,ha;if(ea==ga.RESENDING){ha=this.renderResendIndicator();}else if(ea!==undefined&&ea!=ga.UNSENT&&ea!=ga.UNCONFIRMED&&ea!=ga.SUCCESS)ha=this.renderErrorIndicator(ea,fa);return ha;},renderParticipantList:function(ea,fa,ga,ha){var ia={abbr_mode:true,last_separator_uses_and:true,link_mode:true,names_renderer:true};ha=ha||{};var ja=null;if(ha.names_renderer){ja=ha.names_renderer(fa);}else ja=fa.map(function(ma){return ma.name;});var ka=null;if(ja.length==1){ka=ja[0];}else if(ja.length==2){var la={participant1:ja[0],participant2:ja[1]};if(ha.last_separator_uses_and){ka=aa._("{participant1} et {participant2}",la);}else ka=aa._("{participant1}, {participant2}",la);}else if(ha.last_separator_uses_and){if(ha.abbr_mode){ka=aa._("{participant1} et {others_link}",{participant1:ja[0],others_link:this.renderParticipantCount(ea,{render_subset:true,count:ga-1,as_link:ha.link_mode})});}else if(ja.length==3){ka=aa._("{participant1}, {participant2} et {participant3}",{participant1:ja[0],participant2:ja[1],participant3:ja[2]});}else ka=aa._("{participant1}, {participant2} et {others_link}",{participant1:ja[0],participant2:ja[1],others_link:this.renderParticipantCount(ea,{render_subset:true,count:ga-2,as_link:ha.link_mode})});}else if(ja.length==3){ka=aa._("{participant1}, {participant2}, {participant3}",{participant1:ja[0],participant2:ja[1],participant3:ja[2]});}else ka=aa._("{participant1}, {participant2}, {participant3}, {others_link}",{participant1:ja[0],participant2:ja[1],participant3:ja[2],others_link:this.renderParticipantCount(ea,{render_subset:true,count:ga-3,as_link:ha.link_mode})});if(Array.isArray(ka))ka=h.create('span',{},ka);return ka;},renderParticipantCount:function(ea,fa){function ga(ka,la){return h.create('a',{className:'hoverlistLink',href:r('/ajax/messaging/profile_browser/profile_browser.php').setQueryData(ka),rel:'dialog'},la);}var ha=fa.render_subset,ia=o.getServerThreadIDNow(ea),ja;if(!ha){ja=aa._("{num} personnes",{num:fa.count});}else ja=fa.count>1?aa._("{others_count} autres personnes",{others_count:fa.count}):"1 autre";if(fa.as_link&&ia){return ga({tid:ia},ja);}else return ja;},renderShortNames:function(ea){if(ea.length==1)return [ea[0].name];return ea.map(function(fa){return fa.short_name;});},_renderThreadImageSingle:function(ea,fa){var ga=u[':fb:mercury:thread-image:single'].build().getRoot();ga.src=ea;h.setContent(fa,ga);},_renderThreadImageSplit:function(ea,fa){var ga=u[':fb:mercury:thread-image:split'].build().setNodeProperty('left','src',ea[0].image_src).setNodeProperty('topRight','src',ea[1].image_src).setNodeProperty('bottomRight','src',ea[2].image_src);h.setContent(fa,ga.getRoot());},_cloneIfDOMElement:function(ea){if(ea.cloneNode){return ea.cloneNode();}else return ea;}};function ba(ea,fa){var ga=ea;if(fa&&fa>1)ga=h.create('span',{},aa._("{conversation_title} ({unread_count})",{conversation_title:ea,unread_count:fa}));return ga;}function ca(ea,fa){z(ea).forEach(function(ga){h.setContent(ga,fa);});}function da(ea,fa,ga){fa=z(fa);var ha={callback:true,check_length:true,show_unread_count:true};ga=ga||{};var ia={};for(var ja in ga)if(ha[ja]){ia[ja]=ga[ja];delete ga[ja];}p.getThreadMeta(ea,function(ka){if(ka.name){var la=ba(ka.name,ia.show_unread_count?ka.unread_count:0);fa.forEach(function(na){h.setContent(na,la);});ia.callback&&ia.callback(la);return;}var ma=ka.participants;if(ka.participants.length>1)ma=ka.participants.filter(function(na){return na!=m.user;});m.getMulti(ma,function(na){var oa=ma.map(function(ta){return na[ta];}),pa=e.exports.renderParticipantList(ea,oa,ma.length,ga);pa=ba(pa,ia.show_unread_count?ka.unread_count:0);var qa=ga.abbr_mode,ra={};for(var sa in ga)ra[sa]=ga[sa];ra.abbr_mode=true;fa.forEach(function(ta){var ua=fa.length>1?e.exports._cloneIfDOMElement(pa):pa;h.setContent(ta,ua);if(ia.check_length&&!qa&&ta.scrollWidth>ta.clientWidth){var va=e.exports.renderParticipantList(ea,oa,ma.length,ra);va=ba(va,ia.show_unread_count?ka.unread_count:0);h.setContent(ta,va);}}.bind(this));ia.callback&&ia.callback(pa);}.bind(this));}.bind(this));}});
__d("MercuryMessageRenderer",["MercuryAttachmentRenderer","CSS","DOM","DOMQuery","HTML","htmlHyperlink","MercuryEmoji","MercuryParticipants","Tooltip","tx","MercuryConstants"],function(a,b,c,d,e,f){var g=b('MercuryAttachmentRenderer'),h=b('CSS'),i=b('DOM'),j=b('DOMQuery'),k=b('HTML'),l=b('htmlHyperlink'),m=b('MercuryEmoji'),n=b('MercuryParticipants'),o=b('Tooltip'),p=c('MercuryConstants'),q=b('tx'),r={renderTooltipFlyout:function(ha,ia){ia.forEach(function(ja){var ka=i.create('div');i.setContent(ka,ja.name);i.appendContent(ha,ka);});},renderLogMessage:function(ha,ia,ja,ka){t(ha,ka);u(ia,ka);v(ja,ka);},formatMessageBody:function(ha,ia){ia=ia||{};var ja=(ha||'').replace(/\n+$/,''),ka=Object.keys(ia).map(function(na){return window.parseInt(na);}).sort(function(na,oa){return na-oa;}),la=0,ma=i.create('span');ka.forEach(function(na){var oa=ja.slice(la,na);s(ma,oa,false);var pa=ia[na.toString()],qa=ja.slice(na,na+pa.length);s(ma,qa,true);la=na+pa.length;});s(ma,ja.slice(la),false);return ma;}};function s(ha,ia,ja){if(ia.length===0&&!ja)return;var ka=k(l(ia,m.htmlEmojiAndEmote,null,true)),la=ja?{'class':'highlight'}:{},ma=i.create('span',la,ka);i.appendContent(ha,ma);}function t(ha,ia){var ja='';switch(ia.log_message_type){case p.MercuryLogMessageType.SUBSCRIBE:ja='mercurySubscribeIcon';break;case p.MercuryLogMessageType.UNSUBSCRIBE:ja='mercuryUnsubscribeIcon';break;case p.MercuryLogMessageType.THREAD_NAME:ja='mercuryThreadNameIcon';break;case p.MercuryLogMessageType.THREAD_IMAGE:ja='mercuryThreadImageIcon';break;case p.MercuryLogMessageType.VIDEO_CALL:var ka=ia.log_message_data.answered;if(ka||ga(ia)){ja='mercuryVideoCallIcon';}else ja='mercuryMissedVideoCallIcon';break;case p.MercuryLogMessageType.SERVER_ERROR:ja='mercuryErrorIcon';break;}h.addClass(ha,ja);}function u(ha,ia){switch(ia.log_message_type){case p.MercuryLogMessageType.SUBSCRIBE:da(ha,ia);break;case p.MercuryLogMessageType.UNSUBSCRIBE:ea(ha,ia);break;case p.MercuryLogMessageType.VIDEO_CALL:if(ga(ia)){w(ha,ia);}else x(ha,ia);break;case p.MercuryLogMessageType.THREAD_NAME:y(ha,ia);break;case p.MercuryLogMessageType.THREAD_IMAGE:z(ha,ia);break;case p.MercuryLogMessageType.SERVER_ERROR:fa(ha,ia);break;}}function v(ha,ia){var ja=ia.log_message_type;if(ja==p.MercuryLogMessageType.THREAD_IMAGE){var ka=ia.log_message_data.image;ka&&i.setContent(ha,g.renderPreview(ka));h.show(ha);}}var w=function(ha,ia){n.get(ia.author,function(ja){var ka=ja.short_name,la;switch(ia.log_message_data.event_name){case 'installing':la=i.tx._("{firstname} installe la fonction d\u2019appel vid\u00e9o...",{firstname:ka});break;case 'installed':la=i.tx._("{firstname} a termin\u00e9 l\u2019installation de la fonction d\u2019appel vid\u00e9o.",{firstname:ka});break;case 'install_canceled':la=i.tx._("Vous avez annul\u00e9 l\u2019installation de la fonction d\u2019appel vid\u00e9o.",{firstname:ka});break;}if(la)i.setContent(ha,la);});},x=function(ha,ia){var ja=ia.log_message_data.caller,ka=ia.log_message_data.callee,la=[ja,ka];n.getMulti(la,function(ma){if(ja==n.user){var na=ma[ka].short_name,oa;if(ia.log_message_data.answered){oa=i.tx._("Vous avez appel\u00e9 {firstname}",{firstname:na});}else oa=i.tx._("{firstname} a rat\u00e9 votre appel.",{firstname:na});}else{var pa=ma[ja].short_name;if(ia.log_message_data.answered){oa=i.tx._("{firstname} vous a appel\u00e9(e).",{firstname:pa});}else oa=i.tx._("Vous avez manqu\u00e9 un appel de {firstname}",{firstname:pa});}i.setContent(ha,oa);});},y=function(ha,ia){var ja=ia.log_message_data.name,ka=i.create('b',{},ja);if(ia.author==n.user){if(ja){i.setContent(ha,i.tx._("Vous avez nomm\u00e9 la conversation\u00a0: {name}.",{name:ka}));}else i.setContent(ha,i.tx._("Vous avez supprim\u00e9 le nom de la conversation."));}else n.get(ia.author,function(la){var ma,na=aa(la);if(ja){ma=i.tx._("{actor} a nomm\u00e9 la conversation\u00a0: {name}.",{actor:na,name:ka});}else ma=i.tx._("{actor} a supprim\u00e9 le nom de la conversation.",{actor:na});i.setContent(ha,ma);});},z=function(ha,ia){if(ia.author==n.user){if(ia.log_message_data.image){i.setContent(ha,i.tx._("Vous avez chang\u00e9 l\u2019image de la conversation."));}else i.setContent(ha,i.tx._("Vous avez supprim\u00e9 l\u2019image de la conversation."));}else n.get(ia.author,function(ja){var ka=aa(ja),la;if(ia.log_message_data.image){la=i.tx._("{actor} a chang\u00e9 l\u2019image de la conversation.",{actor:ka});}else la=i.tx._("{actor} a supprim\u00e9 l\u2019image de la conversation.",{actor:ka});i.setContent(ha,la);});},aa=function(ha){if(ha.href)return i.create('a',{href:ha.href},ha.name);return ha.name;},ba=function(ha){if(ha.href)return i.create('a',{href:ha.href},ha.short_name);return ha.short_name;},ca=function(ha){var ia=ha.indexOf(n.user);if(ia>0)return ha.splice(ia,1).concat(ha);return ha;},da=function(ha,ia){var ja=ca(ia.log_message_data.added_participants),ka=null,la;if(ja.length==1){ka=[ia.author,ja[0]];n.getMulti(ka,function(ma){if(ia.author==n.user){la=i.tx._("Vous avez ajout\u00e9 {subscriber1}.",{subscriber1:aa(ma[ja[0]])});}else if(ja[0]==n.user){la=i.tx._("{actor} vous a ajout\u00e9(e).",{actor:aa(ma[ia.author])});}else la=i.tx._("{actor} a ajout\u00e9 {subscriber1}.",{actor:aa(ma[ia.author]),subscriber1:aa(ma[ja[0]])});i.setContent(ha,la);});}else if(ja.length==2){ka=[ia.author].concat(ja);n.getMulti(ka,function(ma){if(ia.author==n.user){la=i.tx._("Vous avez ajout\u00e9 {subscriber1} et {subscriber2}.",{subscriber1:aa(ma[ja[0]]),subscriber2:aa(ma[ja[1]])});}else if(ja[0]==n.user){la=i.tx._("{actor} vous a ajout\u00e9(e) et a ajout\u00e9 {subscriber2}.",{actor:aa(ma[ia.author]),subscriber2:aa(ma[ja[1]])});}else la=i.tx._("{actor} a ajout\u00e9 {subscriber1} et {subscriber2}.",{actor:aa(ma[ia.author]),subscriber1:aa(ma[ja[0]]),subscriber2:aa(ma[ja[1]])});i.setContent(ha,la);});}else if(ja.length==3){ka=[ia.author].concat(ja);n.getMulti(ka,function(ma){if(ia.author==n.user){la=i.tx._("Vous avez ajout\u00e9 {subscriber1}, {subscriber2} et {subscriber3}.",{subscriber1:aa(ma[ja[0]]),subscriber2:aa(ma[ja[1]]),subscriber3:aa(ma[ja[2]])});}else if(ja[0]==n.user){la=i.tx._("{actor} vous a ajout\u00e9(e), et a ajout\u00e9 {subscriber2} et {subscriber3}.",{actor:aa(ma[ia.author]),subscriber2:aa(ma[ja[1]]),subscriber3:aa(ma[ja[2]])});}else la=i.tx._("{actor} a ajout\u00e9 {subscriber1}, {subscriber2} et {subscriber3}.",{actor:aa(ma[ia.author]),subscriber1:aa(ma[ja[0]]),subscriber2:aa(ma[ja[1]]),subscriber3:aa(ma[ja[2]])});i.setContent(ha,la);});}else{ka=[ia.author].concat(ja);n.getMulti(ka,function(ma){var na=i.tx._("{num} de plus",{num:ja.length-2}),oa=i.create('span',{className:'more'},na),pa=i.create('div');r.renderTooltipFlyout(pa,ja.slice(2).map(function(ra){return ma[ra];}));if(ia.author==n.user){la=i.tx._("Vous avez ajout\u00e9 {subscriber1}, {subscriber2} et {more_people}.",{subscriber1:aa(ma[ja[0]]),subscriber2:aa(ma[ja[1]]),more_people:oa});}else if(ja[0]==n.user){la=i.tx._("{actor} vous a ajout\u00e9(e), et a ajout\u00e9 {subscriber2} et {more_people}.",{actor:aa(ma[ia.author]),subscriber2:aa(ma[ja[1]]),more_people:oa});}else la=i.tx._("{actor} a ajout\u00e9 {subscriber1}, {subscriber2} et {more_people}.",{actor:aa(ma[ia.author]),subscriber1:aa(ma[ja[0]]),subscriber2:aa(ma[ja[1]]),more_people:oa});i.setContent(ha,la);var qa=j.find(ha,'span.more');o.set(qa,pa,'above','center');});}},ea=function(ha,ia){n.get(ia.author,function(ja){var ka;if(ia.author==n.user){ka=i.tx._("Vous avez quitt\u00e9 la conversation.");}else ka=i.tx._("{actor} a quitt\u00e9 la conversation.",{actor:aa(ja)});i.setContent(ha,ka);});},fa=function(ha,ia){var ja="Les messages pr\u00e9c\u00e9dents de cette conversation n\u2019ont pas pu \u00eatre r\u00e9cup\u00e9r\u00e9s.";i.setContent(ha,ja);},ga=function(ha){return ha.log_message_data.event_name==='installing'||ha.log_message_data.event_name==='install_canceled';};e.exports=r;});
__d("ChatTabMessagesView",["event-extensions","Arbiter","ArbiterMixin","MercuryAttachmentRenderer","ChannelConstants","ChatConfig","ChatTabIndicatorLine","ChatVisibility","CSS","DOM","Emote","Env","MercuryMessages","MercuryThreadMetadataRenderer","MercuryThreads","MercuryMessageRenderer","MercuryParticipants","MercuryThreadInformer","Tooltip","VideoCallCore","copyProperties","isRTL","tx","date-extensions","ChatTabTemplates","MercuryConstants"],function(a,b,c,d,e,f){b('event-extensions');var g=b('Arbiter'),h=b('ArbiterMixin'),i=b('MercuryAttachmentRenderer'),j=b('ChannelConstants'),k=b('ChatConfig'),l=b('ChatTabIndicatorLine'),m=b('ChatVisibility'),n=b('CSS'),o=b('DOM'),p=b('Emote'),q=b('Env'),r=b('MercuryMessages'),s=b('MercuryThreadMetadataRenderer'),t=b('MercuryThreads'),u=b('MercuryMessageRenderer'),v=b('MercuryParticipants'),w=b('MercuryThreadInformer'),x=b('Tooltip'),y=b('VideoCallCore'),z=c('ChatTabTemplates'),aa=c('MercuryConstants'),ba=b('copyProperties'),ca=b('isRTL'),da=b('tx');b('date-extensions');function ea(pa){return Date.format(k.get('24h_times')?'H:i':'g:ia',pa/1000);}function fa(pa){var qa=z[':fb:chat:conversation:message-group'].build();qa.setNodeContent('timestamp',ea(pa.timestamp));v.get(pa.author,function(ra){var sa=qa.getNode('profileLink');sa.href=ra.href;var ta=ra.fbid==q.user?"Vous":ra.name;x.set(sa,ta,'left');qa.setNodeProperty('profilePhoto','src',ra.image_src);});return qa;}function ga(pa){var qa=z[':fb:chat:conversation:message:event'].build();qa.setNodeContent('timestamp',ea(pa.timestamp));u.renderLogMessage(qa.getNode('icon'),qa.getNode('message'),qa.getNode('attachment'),pa);var ra=ha(pa);if(ra)o.appendContent(qa.getNode('message'),ra);return qa.getRoot();}function ha(pa){var qa,ra;if(pa.log_message_type==aa.MercuryLogMessageType.VIDEO_CALL)if(pa.log_message_data.event_name=='install_canceled'){qa=o.tx._("R\u00e9installez et r\u00e9essayez.");ra='callback_cancelinstall_link';return ia(qa,pa.thread_id,pa.log_message_data.to,ra);}else if(!pa.log_message_data.event_name&&pa.log_message_data.callee==v.user&&!pa.log_message_data.answered){qa=o.tx._("Rappeler");ra='callback_link';return ia(qa,pa.thread_id,pa.log_message_data.caller.split(':')[1],ra);}return null;}function ia(pa,qa,ra,sa){if(y.isSupported()){var ta=!m.isOnline()||!y.availableForCall(ra),ua=o.create('a',{href:'#',className:'callBackLink'},pa);if(ta)n.hide(ua);ua.setAttribute('data-gt',JSON.stringify({videochat:'clicked_callback_link'}));Event.listen(ua,'click',function(){na.inform('video-call-clicked',{userID:ra,threadID:qa,clickSource:sa});});return ua;}return null;}function ja(pa){var qa=z[':fb:mercury:chat:message:forward'].build(),ra=qa.getNode('forwardText');if(ra){n.hide(qa.getRoot());s.renderTitanLink(pa.thread_id,qa.getNode('forwardLink'),n.show.bind(n,qa.getRoot()));if(pa.forward_count>1){o.appendContent(ra,da._("{count} messages transf\u00e9r\u00e9s",{count:pa.forward_count}));}else o.appendContent(ra,"1 message transf\u00e9r\u00e9");}return qa.getRoot();}var ka=["janvier","f\u00e9vrier","mars","avril","mai","juin","juillet","ao\u00fbt","septembre","octobre","novembre","d\u00e9cembre"];function la(pa){var qa=new Date();qa.setHours(0);qa.setMinutes(0);qa.setSeconds(0);qa.setMilliseconds(0);var ra=24*60*60*1000,sa=qa.getTime()-pa.getTime();if(sa<=0){return "Aujourd\u2019hui";}else if(sa<ra)return "Hier";return da._("{date} {month}",{month:ka[pa.getMonth()],date:pa.getDate()});}var ma=[];function na(pa,qa,ra,sa){this.threadID=pa;this.scrollContainer=qa;this.conversationElem=ra;this.messageElements={};this.messageGroup=null;this.prevMessage=null;var ta=aa.MercuryThreadlistConstants.MESSAGE_TIMESTAMP_THRESHOLD;this._olderTimestamp=(new Date()).getTime()-ta;ma.push(this);this._subscription=g.subscribe('overflow-applied-to-body',this.scrollToBottom.bind(this));if(sa)this.indicatorLine=new l(this.threadID,sa,this);r.getThreadMessagesRange(this.threadID,0,aa.MercuryThreadlistConstants.RECENT_MESSAGES_LIMIT,Function.prototype);this.rerender();}ba(na,h);ba(na.prototype,{destroy:function(){o.empty(this.conversationElem);this._subscription.unsubscribe();ma.remove(this);this.indicatorLine&&this.indicatorLine.destroy();this.destroyed=true;},_appendMessage:function(pa){if(pa==this.prevMessage)return;var qa=aa.MercuryThreadlistConstants,ra=qa.GROUPING_THRESHOLD,sa=pa.action_type==aa.MercuryActionType.LOG_MESSAGE&&pa.log_message_type==aa.MercuryLogMessageType.SERVER_ERROR;if(pa.is_cleared)return;var ta=null;if(this.prevMessage)ta=new Date(this.prevMessage.timestamp);var ua=new Date(pa.timestamp);if(!sa&&(!ta||ta.getDate()!=ua.getDate()||ta.getMonth()!=ua.getMonth()||ta.getFullYear()!=ua.getFullYear())){var va=z[':fb:chat:conversation:date-break'].build();o.setContent(va.getRoot(),la(ua));o.appendContent(this.conversationElem,va.getRoot());this.messageGroup=null;}if(pa.action_type==aa.MercuryActionType.LOG_MESSAGE){o.appendContent(this.conversationElem,ga(pa));this.messageGroup=null;this.prevMessage=pa;return;}if(!this.messageGroup||this.prevMessage.author!=pa.author||this.prevMessage.timestamp<pa.timestamp-ra){this.messageGroup=fa(pa);o.appendContent(this.conversationElem,this.messageGroup.getRoot());}var wa=this._renderSingleMessage(pa);this.messageElements[pa.message_id]=wa;o.appendContent(this.messageGroup.getNode('messages'),wa);this.prevMessage=pa;},rerender:function(){o.empty(this.conversationElem);this.messageElements={};this.messageGroup=null;this.prevMessage=null;var pa=r.getThreadMessagesSinceTimestamp(this.threadID,this._olderTimestamp);this._appendMessages(pa);},update:function(pa){for(var qa in pa){var ra=this.messageElements[qa];if(ra){var sa=this._renderSingleMessage(r.getMessagesFromIDs([qa])[0]);this.messageElements[qa]=sa;o.replace(ra,sa);}}},_appendMessages:function(pa){pa.forEach(this._appendMessage.bind(this));this.indicatorLine&&this.indicatorLine.setLastMessage(this.prevMessage);this.scrollToBottom();},isScrolledToBottom:function(){var pa=this.scrollContainer;return pa.scrollTop+pa.clientHeight>=pa.scrollHeight;},scrollToBottom:function(){this.scrollContainer.scrollTop=this.scrollContainer.scrollHeight;},_renderSingleMessage:function(pa){var qa=z[':fb:chat:conversation:message'].render();if(pa.subject){var ra=z[':fb:chat:conversation:message:subject'].render();o.setContent(ra,pa.subject);o.appendContent(qa,ra);}if(pa.body.substr(0,4)=='?OTR'){o.setContent(qa,"[message chiffr\u00e9]");n.addClass(qa,'cyphertext');}else{n.addClass(qa,ca(pa.body)?'direction_rtl':'direction_ltr');o.appendContent(qa,u.formatMessageBody(pa.body));}if(pa.has_attachment)this._appendMessageAttachments(qa,pa);if(pa.forward_count)o.appendContent(qa,ja(pa));var sa=s.renderStatusIndicator(pa.status,r.resendMessage.bind(r,pa));if(sa){n.addClass(qa,'errorStatus');var ta=z[':fb:chat:conversation:message:status'].build();o.appendContent(ta.getNode('message'),qa);o.appendContent(ta.getNode('status'),sa);return ta.getRoot();}return qa;},_appendMessageAttachments:function(pa,qa){var ra=aa.MercuryAttachmentType,sa=qa.attachments;for(var ta=0,ua=sa.length;ta<ua;++ta){var va=sa[ta],wa=va.attach_type,xa=va.share_data_type;if(wa==ra.ERROR)o.appendContent(pa,i.renderError(va));if(wa==ra.FILE)o.appendContent(pa,i.renderFileLink(va));var ya=null,za;if(wa==ra.SHARE&&xa==aa.MercurySupportedShareType.FB_VIDEO){ya=i.renderVideoThumb(va);za=o.find(ya,'img');Event.listen(za,'load',this._thumbLoaded.shield(this,za));}else if(wa==ra.SHARE&&(xa==aa.MercurySupportedShareType.FB_MUSIC_ALBUM||xa==aa.MercurySupportedShareType.FB_SONG)){ya=i.renderMusic(va);za=o.find(ya,'img');Event.listen(za,'load',this._thumbLoaded.shield(this,za));}else if(wa==ra.SHARE&&(xa==aa.MercurySupportedShareType.EXTERNAL||xa==aa.MercurySupportedShareType.FB_TEMPLATE)){ya=i.renderExternalLink(va);za=o.find(ya,'img');Event.listen(za,'load',this._thumbLoaded.shield(this,za));}else if(va.preview_url){ya=i.renderPreview(va,0,null,qa.message_id);za=o.find(ya,'img');Event.listen(za,'load',this._thumbLoaded.shield(this,za));}else if(wa==ra.SHARE)ya=i.renderShareLink(va);if(ya)o.appendContent(pa,ya);}},_thumbLoaded:function(pa){var qa=this.scrollContainer.scrollTop+this.scrollContainer.clientHeight;if(qa+pa.offsetHeight>=this.scrollContainer.scrollHeight)this.scrollToBottom();}});w.subscribe('messages-reordered',function(pa,qa){ma.forEach(function(ra){qa[ra.threadID]&&ra.rerender();});});w.subscribe('messages-updated',function(pa,qa){ma.forEach(function(ra){qa[ra.threadID]&&ra.update(qa[ra.threadID]);});});w.subscribe('messages-received',function(pa,qa){ma.forEach(function(ra){var sa=qa[ra.threadID];sa&&ra._appendMessages(sa);});});g.subscribe(j.getArbiterType('chat_event'),function(pa,qa){if(oa(qa.obj)){var ra=(q.user==qa.obj.from)?qa.obj.to:qa.obj.from,sa=t.getThreadIdForUser(ra),ta=ma.filter(function(wa){return wa.threadID===sa;});if(ta.length>0){var ua=ta[0],va=r.constructLogMessageObject(aa.MercurySourceType.CHAT_WEB,sa,aa.MercuryLogMessageType.VIDEO_CALL,qa.obj);va.author='fbid:'+qa.obj.from;ua._appendMessages([va]);}}});function oa(pa){return (pa.event_name==='installing'||pa.event_name==='install_canceled');}e.exports=na;});
__d("ChatTabSheetPolicy",[],function(a,b,c,d,e,f){var g={canReplaceOpenSheet:function(h,i){if(h.getType()==i.getType())return false;if(h.isPermanent()&&!i.isPermanent())return false;return true;}};e.exports=g;});
__d("ChatTabSheetView",["event-extensions","Animation","ChatTabSheetPolicy","CSS","DOM","Style","Vector","copyProperties","ChatTabTemplates"],function(a,b,c,d,e,f){b('event-extensions');var g=b('Animation'),h=b('ChatTabSheetPolicy'),i=b('CSS'),j=b('DOM'),k=b('Style'),l=b('Vector'),m=b('copyProperties'),n=c('ChatTabTemplates'),o=5000,p=function(q,r,s){this._threadID=q;this._rootElement=r;this._tabMainElement=s;this._openSheet=null;};m(p.prototype,{destroy:function(){j.empty(this._rootElement);},_openCommon:function(q,r){if(this._openSheet&&!h.canReplaceOpenSheet(this._openSheet,q))return;this.clear(function(){this._openSheet=q;var s=n[':fb:mercury:chat:tab-sheet:loading'].build().getRoot();j.setContent(this._rootElement,s);i.show(s);i.show(this._rootElement);q.render();if(r){i.addClass(this._tabMainElement,'sheetSlide');var t=l.getElementDimensions(this._rootElement).y;k.set(this._rootElement,'bottom',t+'px');this._animation=new g(this._rootElement).to('bottom',0).duration(150).ease(g.ease.both).ondone(function(){i.removeClass(this._tabMainElement,'sheetSlide');}.bind(this)).go();}if(!q.isPermanent()){var u=o;if(q.getCloseTimeout)u=q.getCloseTimeout();this._sheetCloseHandler=this.close.bind(this,q).defer(u,false);}}.bind(this));},set:function(q){return this._openCommon(q,false);},open:function(q){return this._openCommon(q,true);},close:function(q,r){if(this._openSheet!=q)return;if(!this._openSheet){r&&r();return;}if(this._animation)this._animation.stop();if(this._sheetCloseHandler){clearTimeout(this._sheetCloseHandler);this._sheetCloseHandler=null;}i.addClass(this._tabMainElement,'sheetSlide');var s=l.getElementDimensions(this._rootElement).y;this._animation=new g(this._rootElement).to('bottom',s+'px').duration(100).ease(g.ease.begin).ondone(function(){j.empty(this._rootElement);i.hide(this._rootElement);i.removeClass(this._tabMainElement,'sheetSlide');this._openSheet=null;r&&r();}.bind(this)).go();},clear:function(q){this.close(this._openSheet,q);}});e.exports=p;});
__d("MercuryTypeahead",["event-extensions","ArbiterMixin","DOM","Env","Input","Tokenizer","Typeahead","TypeaheadCore","copyProperties","MercuryTypeaheadTemplates"],function(a,b,c,d,e,f){b('event-extensions');var g=b('ArbiterMixin'),h=b('DOM'),i=b('Env'),j=b('Input'),k=b('Tokenizer'),l=b('Typeahead'),m=b('TypeaheadCore'),n=b('copyProperties'),o=c('MercuryTypeaheadTemplates'),p=function(q,r){this._domElement=null;this._typeahead=null;this._tokenizer=null;this._placeholder='';this._exclusions=[];this._viewNodeID=null;this._viewOptions={renderer:'compact',autoSelect:true};this._tokenizerBehaviors=[];this._dataSource=q;this._view=r;};n(p.prototype,g);n(p.prototype,{setPlaceholder:function(q){this._placeholder=q;return this;},setExcludedParticipants:function(q){this._exclusions=[];q.forEach(function(r){var s=r.indexOf(':');if(r.substr(0,s)=='fbid')this._exclusions.push(r.substr(s+1));}.bind(this));return this;},setViewNodeID:function(q){this._viewNodeID=q;},setViewOption:function(q,r){this._viewOptions[q]=r;},addTokenizerBehavior:function(q){this._tokenizerBehaviors.push(q);},build:function(q){if(this._domElement)return;var r=o[':fb:mercury:tokenizer'].build(),s=o[':fb:mercury:typeahead'].build();this._domElement=r.getRoot();h.appendContent(this._domElement,s.getRoot());var t=s.getNode('textfield');j.setPlaceholder(t,this._placeholder);t.setAttribute('data-placeholder',this._placeholder);var u={node_id:this._viewNodeID,ctor:this._view,options:this._viewOptions},v={ctor:m,options:{setValueOnSelect:true}};this._typeahead=new l(this._dataSource,u,v,s.getRoot());this._typeahead.init();var w={inline:true,behaviors:this._tokenizerBehaviors};this._tokenizer=new k(this._domElement,this._typeahead);this._tokenizer.init(r.getNode('tokenarea'),'participants',[],w);this._tokenizer.subscribe(['addToken','removeToken','removeAllTokens'],function(){this.inform('tokens-changed');}.bind(this));Event.listen(t,'focus',function(){this._resetDataSource();this._typeahead.init();}.bind(this));Event.listen(this._domElement,'click',this.focus.bind(this));},getElement:function(){return this._domElement;},getSelectedParticipantIDs:function(){var q=[];if(this._tokenizer)(this._tokenizer.getTokenValues()||[]).forEach(function(r){q.push('fbid:'+r);});return q;},getTokens:function(){var q=[];if(this._tokenizer)q=this._tokenizer.getTokens();return q;},getTokenizer:function(){return this._tokenizer;},reset:function(){this._tokenizer&&this._tokenizer.removeAllTokens();this._typeahead&&this._typeahead.getCore().reset();},focus:function(){this._tokenizer&&this._tokenizer.focusInput();},getTypeahead:function(){return this._typeahead;},_resetDataSource:function(){this._dataSource.setExclusions(this._exclusions);}});e.exports=p;});
__d("MultiChatController",["Arbiter","AsyncSignal","copyProperties","Form","MercuryMessages","MercuryServerRequests","MercuryThreads"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('AsyncSignal'),i=b('copyProperties'),j=b('Form'),k=b('MercuryMessages'),l=b('MercuryServerRequests'),m=b('MercuryThreads');function n(){}i(n,{subscribe:function(o,p){o.subscribe('confirm',function(){this.createGroupThreadFromChooserDialog(o,p);}.bind(this));},createGroupThreadFromChooserDialog:function(o,p){var q=j.serialize(o.getRoot()),r=JSON.parse(q.profileChooserItems),s=[];for(var t in r)if(r[t])s.push(t);var u=n.createThreadForFBIDs(s);l.subscribe('update-thread-ids',function(v,w){for(var x in w)if(w[x]==u)new h('/ajax/groups/chat/log',{group_id:p,message_id:x}).send();});o.hide();},createThreadForTokens:function(o){if(!o.length)return;var p;if(o.length==1){p='user:'+o[0].split(':')[1];}else p='root:'+k.generateNewClientMessageID((new Date()).getTime());m.createNewLocalThread(p,o);g.inform('chat/open-tab',{thread_id:p});return p;},createThreadForFBIDs:function(o){var p=[];for(var q=0;q<o.length;q++)p.push("fbid:"+o[q]);return n.createThreadForTokens(p);}});e.exports=n;});
__d("ChatAddFriendsTabSheet",["event-extensions","Arbiter","ChatTabSheetView","ContextualTypeaheadView","DOM","MercuryTypeahead","MercuryMessages","MultiChatController","MercuryServerRequests","MercuryThreads","copyProperties","tx","MercuryConstants","MercuryDataSource","ChatTabTemplates"],function(a,b,c,d,e,f){b('event-extensions');var g=b('Arbiter'),h=b('ChatTabSheetView'),i=b('ContextualTypeaheadView'),j=b('DOM'),k=b('MercuryTypeahead'),l=b('MercuryMessages'),m=b('MultiChatController'),n=b('MercuryServerRequests'),o=b('MercuryThreads'),p=b('copyProperties'),q=c('MercuryConstants'),r=c('MercuryDataSource'),s=c('ChatTabTemplates'),t=b('tx');function u(x,y,z){this._threadID=x;this._rootElement=y;this._sheetView=z;}p(u.prototype,{render:function(){var x=s[':fb:mercury:chat:tab-sheet:add-friends'].build();o.getThreadMeta(this._threadID,function(y){var z=new k(r,i);z.setExcludedParticipants(y.participants);z.setPlaceholder("Entrez le nom d\u2019un(e) ami(e)");z.build();j.replace(x.getNode('participantsTypeahead'),z.getElement());j.setContent(this._rootElement,x.getRoot());z.focus();var aa=y.participants,ba=y.is_canonical_user?v.bind(null,this,this._sheetView,aa,z):w.bind(null,this,this._sheetView,this._threadID,z);Event.listen(x.getNode('doneButton'),'click',ba);}.bind(this));},isPermanent:function(){return true;},getType:function(){return 'add_friends_type';},open:function(){this._sheetView.open(this);}});function v(x,y,z,aa){var ba=aa.getSelectedParticipantIDs();if(ba.length)m.createThreadForTokens(z.concat(ba));y.close(x);}function w(x,y,z,aa){var ba=aa.getSelectedParticipantIDs();if(ba.length)if(o.isEmptyLocalThread(z)){o.addParticipantsToThreadLocally(z,ba);}else l.sendMessage(l.constructLogMessageObject(q.MercurySourceType.CHAT_WEB,z,q.MercuryLogMessageType.SUBSCRIBE,{added_participants:ba}));y.close(x);}e.exports=u;});
__d("ChatAvailabilityTabSheet",["Arbiter","AvailableList","AvailableListConstants","ChatConfig","CSS","DOM","GenderConst","MercuryThreads","ShortProfiles","copyProperties","ChatTabTemplates"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('AvailableList'),i=b('AvailableListConstants'),j=b('ChatConfig'),k=b('CSS'),l=b('DOM'),m=b('GenderConst'),n=b('MercuryThreads'),o=b('ShortProfiles'),p=b('copyProperties'),q=c('ChatTabTemplates');function r(v,w,x,y){this._handledAvailability=w;this._sheetView=y;this._rootElement=x;this._canonicalUser=n.getCanonicalUserInThread(v);if(this._canonicalUser){this._currentAvailability=i.ACTIVE;this._handleAvailabilityChange();g.subscribe(i.ON_AVAILABILITY_CHANGED,this._handleAvailabilityChange.bind(this));}}r.createSheets=function(v,w,x){var y={};if(j.get('roger.ui')){y[i.OFFLINE]=new r(v,i.OFFLINE,w,x);return y;}[i.ACTIVE,i.OFFLINE,i.MOBILE].forEach(function(z){y[z]=new r(v,z,w,x);});return y;};p(r.prototype,{render:function(){!this._canonicalUser;var v=q[':fb:mercury:chat:tab-sheet:message-icon-sheet'].build();o.get(this._canonicalUser,function(w){var x=null;switch(this._currentAvailability){case i.ACTIVE:k.addClass(v.getRoot(),'active');x=s(w);break;case i.MOBILE:k.addClass(v.getRoot(),'mobile');x=t(w);break;case i.OFFLINE:x=u(w);break;}l.setContent(v.getNode('text'),x);l.setContent(this._rootElement,v.getRoot());}.bind(this));},isPermanent:function(){return false;},getType:function(){switch(this._handledAvailability){case i.ACTIVE:return 'availability_active_type';case i.MOBILE:return 'availability_mobile_type';case i.OFFLINE:return 'availability_offline_type';default:throw new Error("Invalid handled availability");}},getCloseTimeout:function(){return 5000;},_handleAvailabilityChange:function(){var v=h.get(this._canonicalUser);if(v==this._currentAvailability)return;this._currentAvailability=v;if(v==this._handledAvailability)this._sheetView.open(this);}});function s(v){return l.tx._("{name} est disponible.",{name:v.firstName});}function t(v){return l.tx._("Vos messages seront envoy\u00e9s au t\u00e9l\u00e9phone de {name}.",{name:v.firstName});}function u(v){switch(v.gender){case m.FEMALE_SINGULAR:case m.FEMALE_SINGULAR_GUESS:return l.tx._("{name} est hors ligne, mais vous pouvez tout de m\u00eame lui envoyer un message.",{name:v.firstName});case m.MALE_SINGULAR:case m.MALE_SINGULAR_GUESS:return l.tx._("{name} est hors-ligne, mais vous pouvez tout de m\u00eame lui envoyer un message.",{name:v.firstName});default:return l.tx._("{name} est hors-ligne, mais vous pouvez tout de m\u00eame lui envoyer un message.",{name:v.firstName});}}e.exports=r;});
__d("ChatNoRecipientsTabSheet",["DOM","MercuryParticipants","MercuryThreadInformer","MercuryThreads","copyProperties","ChatTabTemplates"],function(a,b,c,d,e,f){var g=b('DOM'),h=b('MercuryParticipants'),i=b('MercuryThreadInformer'),j=b('MercuryThreads'),k=b('copyProperties'),l=c('ChatTabTemplates');function m(n,o,p){this._threadID=n;this._rootElement=o;this._sheetView=p;i.subscribe('threads-updated',this._handleThreadsUpdated.bind(this));}k(m.prototype,{render:function(){var n=l[':fb:mercury:chat:tab-sheet:message-icon-sheet'].build();g.setContent(n.getNode('text'),g.tx._("Tous les destinataires ont quitt\u00e9 cette conversation. Veuillez fermer l\u2019onglet obsol\u00e8te."));g.setContent(this._rootElement,n.getRoot());},isPermanent:function(){return true;},getType:function(){return 'no_recipients_type';},_handleThreadsUpdated:function(){j.getThreadMeta(this._threadID,function(n){var o=h.user,p=n.participants.filter(function(q){return q!=o;});if(p.length<1){this._sheetView.open(this);}else this._sheetView.close(this);}.bind(this));}});e.exports=m;});
__d("ChatOfflineTabSheet",["event-extensions","ChatPrivacyActionController","ChatTabSheetView","ChatVisibility","CSS","DOM","JSLogger","MercuryParticipants","MercuryThreads","copyProperties","ChatTabTemplates"],function(a,b,c,d,e,f){b('event-extensions');var g=b('ChatPrivacyActionController'),h=b('ChatTabSheetView'),i=b('ChatVisibility'),j=b('CSS'),k=b('DOM'),l=b('JSLogger'),m=b('MercuryParticipants'),n=b('MercuryThreads'),o=b('copyProperties'),o=b('copyProperties'),p=c('ChatTabTemplates');function q(r,s,t){this._rootElement=s;this._sheetView=t;this._logger=l.create('blackbird');this._canonicalUser=n.getCanonicalUserInThread(r);if(this._canonicalUser)this._privacyActionController=new g(this._canonicalUser,this._handlePrivacyChange.bind(this));}o(q.prototype,{render:function(){if(!this._canonicalUser){this._logger.error('offline_sheet_open_with_non_friend');return;}var r=p[':fb:mercury:chat:tab-sheet:message-icon-sheet'].build(),s='fbid:'+this._canonicalUser;m.get(s,function(t){var u='fbChatGoOnlineLink',v=k.create('a',{href:'#',className:u},k.tx._("passez en ligne")),w=k.tx._("Vous \u00eates actuellement hors-ligne. Pour discuter avec {name} et d\u2019autres amis, {link}.",{name:t.short_name,link:v});k.setContent(r.getNode('text'),w);j.addClass(r.getRoot(),'chatOffline');k.setContent(this._rootElement,r.getRoot());Event.listen(this._rootElement,'click',function(event){if(j.hasClass(event.getTarget(),u)){if(i.isOnline())this._logger.error('tab_sheet_already_online');this._privacyActionController.togglePrivacy();this._logger.log('tab_sheet_go_online',{tab_id:this._canonicalUser});return false;}}.bind(this));}.bind(this));},_handlePrivacyChange:function(r){if(!this._canonicalUser)this._logger.error('user_blocked_sheet_privacy_changed_non_friend');switch(r){case g.OFFLINE:this._sheetView.open(this);break;case g.NORMAL:case g.BLOCKED:this._sheetView.close(this);break;}},isPermanent:function(){return true;},getType:function(){return 'offline_type';},destroy:function(){this._privacyActionController&&this._privacyActionController.destroy();}});e.exports=q;});
__d("ChatUserBlockedTabSheet",["event-extensions","ChatPrivacyActionController","ChatTabSheetView","CSS","DOM","GenderConst","JSLogger","MercuryParticipants","MercuryThreads","copyProperties","tx","ChatTabTemplates"],function(a,b,c,d,e,f){b('event-extensions');var g=b('ChatPrivacyActionController'),h=b('ChatTabSheetView'),i=b('CSS'),j=b('DOM'),k=b('GenderConst'),l=b('JSLogger'),m=b('MercuryParticipants'),n=b('MercuryThreads'),o=b('copyProperties'),p=c('ChatTabTemplates'),q=b('tx');function r(s,t,u){this._rootElement=t;this._sheetView=u;this._logger=l.create('blackbird');this._canonicalUser=n.getCanonicalUserInThread(s);if(this._canonicalUser)this._privacyActionController=new g(this._canonicalUser,this._handlePrivacyChange.bind(this));}o(r.prototype,{render:function(){if(!this._canonicalUser){this._logger.error('user_blocked_sheet_open_with_non_friend');return;}var s=p[':fb:mercury:chat:tab-sheet:user-blocked'].build(),t='fbid:'+this._canonicalUser;m.get(t,function(u){var v=null;switch(u.gender){case k.FEMALE_SINGULAR:case k.FEMALE_SINGULAR_GUESS:v=q._("{name} vous voit comme hors-ligne dans la discussion instantann\u00e9e, mais vous pouvez tout de m\u00eame lui envoyer un message.",{name:u.short_name});break;case k.MALE_SINGULAR:case k.MALE_SINGULAR_GUESS:v=q._("{name} vous voit comme hors-ligne dans la discussion instantann\u00e9e, mais vous pouvez tout de m\u00eame lui envoyer un message.",{name:u.short_name});break;default:v=q._("Vous apparaissez hors-ligne aux yeux de {name}, mais vous pouvez tout de m\u00eame lui envoyer un message.",{name:u.short_name});}j.setContent(s.getNode('text'),v);var w=q._("Appara\u00eetre en ligne pour {name}",{name:u.short_name});j.setContent(s.getNode('actionLink'),w);i.addClass(s.getRoot(),'blocked');j.setContent(this._rootElement,s.getRoot());Event.listen(s.getNode('actionLink'),'click',this._privacyActionController.togglePrivacy.bind(this._privacyActionController));}.bind(this));},_handlePrivacyChange:function(s){if(!this._canonicalUser)this._logger.error('user_blocked_sheet_privacy_changed_non_friend');switch(s){case g.BLOCKED:this._sheetView.open(this);break;case g.NORMAL:case g.OFFLINE:this._sheetView.close(this);break;}},isPermanent:function(){return true;},getType:function(){return 'user_blocked_type';},destroy:function(){this._privacyActionController&&this._privacyActionController.destroy();}});e.exports=r;});
__d("ChatTabSheetController",["ChatAddFriendsTabSheet","ChatAvailabilityTabSheet","ChatNoRecipientsTabSheet","ChatOfflineTabSheet","ChatTabSheetView","ChatUserBlockedTabSheet","copyProperties","MercuryServerRequests","MercuryThreads"],function(a,b,c,d,e,f){var g=b('ChatAddFriendsTabSheet'),h=b('ChatAvailabilityTabSheet'),i=b('ChatNoRecipientsTabSheet'),j=b('ChatOfflineTabSheet'),k=b('ChatTabSheetView'),l=b('ChatUserBlockedTabSheet'),m=b('copyProperties'),n=b('MercuryServerRequests'),o=b('MercuryThreads'),p=function(q,r,s){this._sheetView=new k(q,r,s);this._addFriendsTabSheet=new g(q,r,this._sheetView);this._userBlockedTabSheet=new l(q,r,this._sheetView);this._offlineTabSheet=new j(q,r,this._sheetView);this._availabilityTabSheets=h.createSheets(q,r,this._sheetView);if(o.isMultichatThread(q))this._noRecipientsTabSheet=new i(q,r,this._sheetView);};m(p.prototype,{openAddFriendsSheet:function(){this._addFriendsTabSheet.open();},destroy:function(){this._sheetView.destroy();this._offlineTabSheet.destroy();this._userBlockedTabSheet.destroy();}});e.exports=p;});
__d("ChatTabView",["event-extensions","function-extensions","Arbiter","ArbiterMixin","AvailableList","AvailableListConstants","ChatConfig","ChatContextualDialogController","ChatQuietLinks","ChatPrivacyActionController","MessagesEmoticonView","ChatTabMessagesView","ChatTabSheetController","ChatVisibility","CSS","Dialog","Dock","DOM","JSLogger","Keys","MercuryMessages","MercuryParticipants","MercuryServerRequests","MercuryThreadInformer","MercuryThreadMetadataRenderer","MercuryThreads","MercuryTypingReceiver","NubController","Parent","PresencePrivacy","Style","TextAreaControl","Tooltip","TypingIndicator","URI","UserAgent","VideoCallCore","copyProperties","setIntervalAcrossTransitions","tx","MercuryConstants","ChatTabTemplates"],function(a,b,c,d,e,f){b('event-extensions');b('function-extensions');var g=b('Arbiter'),h=b('ArbiterMixin'),i=b('AvailableList'),j=b('AvailableListConstants'),k=b('ChatConfig'),l=b('ChatContextualDialogController'),m=b('ChatQuietLinks'),n=b('ChatPrivacyActionController'),o=b('MessagesEmoticonView'),p=b('ChatTabMessagesView'),q=b('ChatTabSheetController'),r=b('ChatVisibility'),s=b('CSS'),t=b('Dialog'),u=b('Dock'),v=b('DOM'),w=b('JSLogger'),x=b('Keys'),y=b('MercuryMessages'),z=b('MercuryParticipants'),aa=b('MercuryServerRequests'),ba=b('MercuryThreadInformer'),ca=b('MercuryThreadMetadataRenderer'),da=b('MercuryThreads'),ea=b('MercuryTypingReceiver'),fa=b('NubController'),ga=b('Parent'),ha=b('PresencePrivacy'),ia=b('Style'),ja=b('TextAreaControl'),ka=b('Tooltip'),la=b('TypingIndicator'),ma=b('URI'),na=b('UserAgent'),oa=b('VideoCallCore'),pa=c('MercuryConstants'),qa=c('ChatTabTemplates'),ra=b('copyProperties'),sa=b('setIntervalAcrossTransitions'),ta=b('tx'),ua=w.create('tab_view'),va={};function wa(fb,gb){var hb=v.create('div');gb=gb.filter(function(ib){return ib!=z.user;});z.getMulti(gb,function(ib){for(var jb in ib){var kb=ib[jb],lb=qa[':fb:mercury:chat:multichat-tooltip-item'].build();v.setContent(lb.getNode('name'),kb.name);var mb=z.getUserID(jb),nb=mb&&i.get(mb)==j.ACTIVE;s.conditionShow(lb.getNode('icon'),nb);s.conditionClass(lb.getNode('name'),'tooltipItemWithIcon',nb);v.appendContent(hb,lb.getRoot());}ka.set(fb,hb,'above','center');});}var xa={},ya=null,za=false;function ab(fb,gb,hb){if(hb){xa[fb]=gb;if(!ya)ya=sa(bb,600);}else{s.removeClass(gb,'highlightTitle');delete xa[fb];}}function bb(){for(var fb in xa){var gb=xa[fb];if(gb.parentNode){s.conditionClass(gb,'highlightTitle',za);}else delete xa[fb];}za=!za;if(!Object.keys(xa).length){clearInterval(ya);ya=null;}}function cb(fb){var gb=aa.tokenizeThreadID(fb);switch(gb.type){case 'user':return qa[':fb:mercury:chat:user-tab'].build();case 'group':return qa[':fb:mercury:chat:group-tab'].build();}return qa[':fb:mercury:chat:multichat-tab'].build();}function db(fb,gb){if(gb)aa.ensureThreadIsFetched(gb);this._threadID=fb;this._eventListeners=[];this._tabTemplate=cb(fb);this._tabElem=this._tabTemplate.getRoot();if(!(this._getNode instanceof Function))ua.log('getnode_undefined',{is_getnode_set:!!this._getNode,is_prototype_set:!!db.prototype,is_window:window==this,is_chat_tab_view:this instanceof db,ctor_name:this.constructor&&this.constructor.name});this._sheetController=new q(this._threadID,this._getNode('sheet'),this._tabElem);this._contextualDialogController=new l(this._threadID,this._getNode('videoCallLink'));this._messagesView=null;var hb=this._getNode('conversationLink');if(hb){s.hide(hb);ca.renderTitanLink(fb,hb,s.show.bind(s,hb));}if(da.isMultichatThread(this._threadID))this._titlebarTooltipAnchor=this._getNode('titlebarText');var ib=this._getCanonicalUserID();if(this._isTitleTextLinked())z.get('fbid:'+ib,function(mb){var nb=this._getNode('titlebarText');nb.setAttribute('href',mb.href);nb.removeAttribute('rel');s.removeClass(nb,'noLink');}.bind(this));this._nubController=new fa().init(this._tabElem);ja.getInstance(this._getNode('input')).subscribe('resize',function(){this._nubController.flyoutContentChanged();}.bind(this));this._nubController.subscribe('resize',function(){this._emoticonsNode.style.left=(this._getNode('input').clientWidth+3)+'px';ja.getInstance(this._getNode('input')).update();}.bind(this));this._listen('closeButton','click',this._closeClicked);this._listen('titlebarCloseButton','click',this._closeClicked);this._listen('dockButton','click',this._nubClicked);this._listen('dockButton','keydown',this._dockKeyDown);this._listen('nubFlyoutTitlebar','click',this._titleClicked);this._listen('chatConv','click',this._chatConvClicked);this._listen('addFriendLink','click',this._addFriendLinkClicked,true);this._listen('addToThreadLink','click',this._addFriendLinkClicked,true);this._listen('clearWindowLink','click',this._clearHistory,true);this._listen('unsubscribeLink','click',this._unsubscribeLinkClicked,true);this._listen('videoCallLink','click',this._callClicked,true);this._listen('reportSpamLink','click',this._reportSpamClicked,true);this._listen('input','focus',this._focusTab);this._listen('input','blur',this._blurTab);this._emoticonsNode=this._getNode('emoticons');this._emoticonView=new o(this._emoticonsNode,this._getNode('input'));if(na.firefox()){this._listen('input','keypress',this._inputKeyDown);}else this._listen('input','keydown',this._inputKeyDown);this._privacyLink=this._getNode('privacyLink');if(this._privacyLink){this._privacyActionController=new n(ib,this._updatePrivacyLink.bind(this));this._eventListeners.push(Event.listen(this._privacyLink,'click',this._privacyActionController.togglePrivacy.bind(this._privacyActionController)));}var jb=ib||(k.get('chat_multi_typ_send')&&da.isMultichatThread(this._threadID));if(jb)aa.getServerThreadID(this._threadID,function(mb){this._typingIndicator=new la(ib,this._getNode('input'),'mercury-chat',null,mb);}.bind(this));var kb=this._getNode('muteGroupLink');if(kb){var lb=da.getCanonicalGroupInThread(this._threadID);if(lb)kb.setAttribute('ajaxify',ma(kb.getAttribute('ajaxify')).addQueryData({id:lb}));}m.removeEmptyHrefs(this._tabElem);va[fb]=this;this.updateAvailableStatus();this.updateTab();}function eb(){for(var fb in va){va[fb].updateAvailableStatus();va[fb].updateMultichatTooltip();}}g.subscribe(['buddylist/availability-changed'],eb);ha.subscribe(['privacy-changed','privacy-availability-changed'],eb);ea.subscribe('state-changed',function(fb,gb){for(var hb in gb){var ib=gb[hb]&&gb[hb].length,jb=va[hb];jb&&jb.showTypingIndicator(ib);}});ba.subscribe('threads-updated',function(fb,gb){for(var hb in va)gb[hb]&&va[hb].updateTab();});ba.subscribe('threads-deleted',function(fb,gb){for(var hb in va)db.inform('thread-deleted',hb);});ra(db,h,{get:function(fb){return va[fb];}});ra(db.prototype,{getThreadID:function(){return this._threadID;},isVisible:function(){return s.shown(this._tabElem);},setVisibleState:function(fb,gb){var hb=s.shown(this._tabElem),ib=s.hasClass(this._tabElem,'opened');s.conditionShow(this._tabElem,fb);s.conditionClass(this._tabElem,'opened',gb);if(!(hb&&ib)&&fb&&gb){if(!this._messagesView)this._messagesView=new p(this._threadID,this._getNode('chatConv'),this._getNode('conversation'),this._getNode('typingIndicator'));this._nubController.flyoutContentChanged();this._messagesView.scrollToBottom();}if(hb&&ib&&!(fb&&gb))this._contextualDialogController.tabNotActive();},focus:function(){var fb=s.hasClass(this._tabElem,'opened')?'input':'dockButton';this._getNode(fb).focus();},isFocused:function(){var fb=document.activeElement;return ga.byClass(fb,'fbMercuryChatTab')===this._tabElem;},setInput:function(fb){this._getNode('input').value=fb;},insertBefore:function(fb){v.insertBefore(fb._tabElem,this._tabElem);},appendTo:function(fb){v.appendContent(fb,this._tabElem);},nextTabIs:function(fb){var gb=fb&&fb._tabElem;return this._tabElem.nextSibling==gb;},destroy:function(){v.remove(this._tabElem);this._emoticonView&&this._emoticonView.destroy();while(this._eventListeners.length)this._eventListeners.pop().remove();this._messagesView&&this._messagesView.destroy();this._sheetController.destroy();this._contextualDialogController.destroy();this._privacyActionController&&this._privacyActionController.destroy();delete va[this._threadID];u.unregisterNubController(this._nubController);},updateAvailableStatus:function(){var fb={active:false,mobile:false,greenphone:false},gb=this._getCanonicalUserID(),hb=true,ib=false;if(gb){var jb=i.get(gb);hb=!r.isOnline();ib=!ha.allows(gb);fb.active=(jb===j.ACTIVE);if(k.get('sidebar_mobile_icon_green')){fb.greenphone=jb===j.MOBILE;}else fb.mobile=jb===j.MOBILE;this._updateCallLink(jb);}s.conditionClass(this._tabElem,'chatOffline',hb);s.conditionClass(this._tabElem,'blocked',!hb&&ib);for(var kb in fb)s.conditionClass(this._tabElem,kb,!hb&&!ib&&fb[kb]);},updateTab:function(){da.getThreadMeta(this._threadID,function(fb){if(!fb.is_subscribed){db.inform('unsubscribed',this._threadID);return;}ca.renderAndSeparatedParticipantList(this._threadID,[this._getNode('name'),this._getNode('titlebarText')],{names_renderer:ca.renderShortNames,check_length:true});this._updateUnreadCount(fb);this.updateMultichatTooltip();this._updateArchiveWarning(fb);}.bind(this));},_updateArchiveWarning:function(fb){var gb=false;z.get(z.user,function(hb){gb=hb.employee;if(gb)z.getMulti(fb.participants,this._showArchiveWarningIfAllParticipantsAreEmployees.bind(this));}.bind(this));},_showArchiveWarningIfAllParticipantsAreEmployees:function(fb){var gb=true;for(var hb in fb)gb=gb&&fb[hb].employee;var ib=this._getNode('titanArchiveWarning');if(ib){if(this._titlebarTooltipAnchor)s.conditionClass(this._titlebarTooltipAnchor,'narrowTitleBar',gb);s.conditionShow(ib,gb);}},updateMultichatTooltip:function(){if(da.isMultichatThread(this._threadID))da.getThreadMeta(this._threadID,function(fb){wa(this._titlebarTooltipAnchor,fb.participants);}.bind(this));},_getNode:function(fb){return this._tabTemplate.getNode(fb);},_getCanonicalUserID:function(){return da.getCanonicalUserInThread(this._threadID);},_listen:function(fb,event,gb,hb){var ib=this._getNode(fb);if(ib){this._eventListeners.push(Event.listen(ib,event,gb.bind(this)));}else if(!hb)throw new Error('Could not find node "'+fb+'"');},_closeClicked:function(fb){db.inform('closed-tab',this._threadID);fb.prevent();},_nubClicked:function(){return db.inform('nub-activated',this._threadID);},_dockKeyDown:function(event){if(event.keyCode===x.RETURN||event.keyCode===x.SPACE){db.inform('nub-activated',this._threadID);event.kill();}else this._handleHotkeyPressed(event);},_handleHotkeyPressed:function(event){if(event.keyCode===x.ESC){db.inform('esc-pressed',this._threadID);event.kill();}else if(event.keyCode===x.TAB){var fb=db.inform('tab-pressed',{id:this._threadID,shiftPressed:event.shiftKey});!fb&&event.kill();}},_isTitleTextLinked:function(){var fb=this._getCanonicalUserID();return fb&&k.get('chat_tab_title_link_timeline');},_titleClicked:function(event){var fb=event.getTarget(),gb=ga.byClass(fb,'titlebarText'),hb=gb&&this._isTitleTextLinked();if(!hb&&!ga.byClass(fb,'uiSelector')&&!ga.byClass(fb,'addToThread'))db.inform('lower-activated',this._threadID);},_callClicked:function(fb){var gb=this._getCanonicalUserID();if(oa.availableForCall(gb)){var hb='chat_tab_icon';if(fb.target&&s.hasClass(fb.target,'video_call_promo')){hb='chat_tab_icon_promo';}else if(fb.target&&s.hasClass(fb.target,'video_call_tour'))hb='chat_tab_icon_tour';db.inform('video-call-clicked',{threadID:this._threadID,userID:gb,clickSource:hb});}return false;},_addFriendLinkClicked:function(){this._sheetController.openAddFriendsSheet();},_clearHistory:function(){var fb=da.getThreadMetaNow(this._threadID);if(fb){var gb=this._getCanonicalUserID();aa.clearChat(this._threadID,gb,fb.timestamp);}},_unsubscribeLinkClicked:function(){var fb=[];fb.push({name:'unsubscribe',label:"Quitter la conversation",handler:this._unsubscribeToThread.bind(this)});fb.push(t.CANCEL);new t().setTitle("Quitter la conversation\u00a0?").setBody("Vous ne recevrez plus de messages de cette conversation et les personnes verront que vous l\u2019avez quitt\u00e9e.").setButtons(fb).show();},_reportSpamClicked:function(){var fb=this._getCanonicalUserID(),gb=ma('/ajax/chat/report.php').addQueryData({id:fb}).addQueryData({src:'top_report_link'});t.bootstrap(gb.toString(),null,false);},_focusTab:function(){s.addClass(this._tabElem,'focusedTab');db.inform('focused',this._threadID);this._contextualDialogController.tabFocused();},_blurTab:function(){s.removeClass(this._tabElem,'focusedTab');},_inputKeyDown:function(event){if(event.keyCode===x.RETURN&&!event.shiftKey){var fb=this._getNode('input'),gb=fb.value||'';if(!/^\s*$/.test(gb))da.getThreadMeta(this._threadID,function(hb){var ib=y.constructUserGeneratedMessageObject(gb,pa.MercurySourceType.CHAT_WEB,this._threadID);if(da.isEmptyLocalThread(this._threadID)){var jb=aa.tokenizeThreadID(this._threadID);ib.message_id=jb.value;ib.specific_to_list=hb.participants;}y.sendMessage(ib);this._getNode('input').value='';this._typingIndicator&&this._typingIndicator.resetState();}.bind(this));event.kill();}if(event.keyCode===x.DOWN&&event.shiftKey&&this._getNode('input').value===''){db.inform('lower-activated',this._threadID);event.kill();return;}this._handleHotkeyPressed(event);},_chatConvClicked:function(){!v.getSelection()&&this.focus();},showTypingIndicator:function(fb){var gb=this._getCanonicalUserID()||(k.get('chat_multi_typ')&&da.isMultichatThread(this._threadID));if(gb)s.conditionClass(this._tabElem,'typing',fb);},_updateUnreadCount:function(fb){var gb=fb.unread_count;if(typeof gb!='undefined'){var hb=this._getNode('numMessages');s.conditionShow(hb,gb);s.conditionClass(this._tabElem,'highlightTab',gb);ab(this._threadID,this._tabElem,!!gb);v.setContent(hb,gb);}},_updateCallLink:function(fb){var gb=this._getNode('videoCallLink');if(r.isOnline()){var hb=this._getCanonicalUserID(),ib='fbid:'+hb;z.get(ib,function(jb){if(oa.availableForCall(hb)){ka.set(gb,ta._("D\u00e9marrer un appel vid\u00e9o avec {firstname}",{firstname:jb.short_name}));this._updateCallBackLinks(this._tabElem,true);}else{ka.set(gb,ta._("{firstname} n\u2019est pas actuellement disponible pour un appel vid\u00e9o",{firstname:jb.short_name}));this._hideVideoCallouts();this._updateCallBackLinks(this._tabElem,false);}}.bind(this));}else{ka.set(gb,"Vous devez \u00eatre en ligne avant de pouvoir passer un appel.");this._hideVideoCallouts();this._updateCallBackLinks(document.body,false);}},_updateCallBackLinks:function(fb,gb){var hb=v.scry(fb,'a.callBackLink');if(gb){hb.forEach(s.show);}else hb.forEach(s.hide);},_hideVideoCallouts:function(){this._contextualDialogController.hideVideoCallouts();},_updatePrivacyLink:function(fb){if(fb==n.OFFLINE){v.setContent(this._privacyLink,"Passer en ligne");}else{var gb=this._getCanonicalUserID(),hb='fbid:'+gb;z.get(hb,function(ib){var jb=null;if(fb==n.BLOCKED){jb=ta._("Appara\u00eetre en ligne pour {name}",{name:ib.short_name});}else jb=ta._("Appara\u00eetre hors ligne pour {name}",{name:ib.short_name});v.setContent(this._privacyLink,jb);}.bind(this));}},_unsubscribeToThread:function(){if(da.isEmptyLocalThread(this._threadID)){db.inform('unsubscribed',this._threadID);}else{var fb=y.constructLogMessageObject(pa.MercurySourceType.CHAT_WEB,this._threadID,pa.MercuryLogMessageType.UNSUBSCRIBE,{});y.sendMessage(fb);}return true;},_emoticonView:null});e.exports=db;});
__d("ChatNewMessageHandler",["ChatActivity","ChatTabModel","ChatTabView","JSLogger","MercuryAssert","MercuryBrowserAlerts","MercuryThreads","MercuryUnseenState"],function(a,b,c,d,e,f){var g=b('ChatActivity'),h=b('ChatTabModel'),i=b('ChatTabView'),j=b('JSLogger'),k=b('MercuryAssert'),l=b('MercuryBrowserAlerts'),m=b('MercuryThreads'),n=b('MercuryUnseenState'),o=j.create('chat_new_message'),p={_raiseTab:function(q,r){var s=h.getTab(q),t=false;if(s){t=s.raised;}else{h.raiseTab(q,false);t=true;}r.to_new_tab=!s;r.to_raised_tab=!!t;},_notify:function(q,r,s){var t=i.get(q);s.view_is_visible=t&&t.isVisible();s.view_is_focused=t&&t.isFocused();if(!s.view_is_visible)o.log('message_to_hidden');s.is_active=g.isActive();l.messageReceived(r);},newMessage:function(q,r){k.isThreadID(q);var s={thread_id:q,message_id:r.message_id};this._raiseTab(q,s);this._notify(q,r,s);o.log('message',s);}};l.subscribe('before-alert',function(q,event){var r=event.threadID,s=i.get(r),t=h.getTab(r);if(t&&t.raised&&s&&s.isVisible()&&s.isFocused()){m.changeThreadReadStatus(r,true);n.markThreadSeen(r);event.cancelAlert();}});e.exports=p;});
__d("ChatTabPresence",["Arbiter","AvailableList","ChatTabModel","MercuryThreads"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('AvailableList'),i=b('ChatTabModel'),j=b('MercuryThreads'),k={};function l(m){var n=j.getCanonicalUserInThread(m);if(n)h.updateForID(n);}i.subscribe('chat/tabs-changed',function(event,m){m.tabs.forEach(function(n){if(n.raised&&!k[n.id])l(n.id);});k={};m.tabs.forEach(function(n){if(n.raised)k[n.id]=true;});});e.exports={};});
__d("ChatTabPolicy",["ChatBehavior","ChatConfig","FBDesktopPlugin","JSLogger","MercuryAssert","MercuryParticipants","MercuryThreads","MercuryUnseenState","PresencePrivacy","ShortProfiles","MercuryConstants"],function(a,b,c,d,e,f){var g=b('ChatBehavior'),h=b('ChatConfig'),i=b('FBDesktopPlugin'),j=b('JSLogger'),k=b('MercuryAssert'),l=b('MercuryParticipants'),m=b('MercuryThreads'),n=b('MercuryUnseenState'),o=b('PresencePrivacy'),p=b('ShortProfiles'),q=c('MercuryConstants'),r=j.create('tab_policy');function s(t,u){n.markThreadSeen(t,u);}e.exports={messageIsAllowed:function(t,u,v){var w=t.thread_id,x=u.message_id;k.isThreadID(w);k.isParticipantID(u.author);var y;if(t.mode==q.MercuryThreadMode.OBJECT_ORIGINATED){y={thread_id:w,message_id:x,mode:t.mode};r.log('message_object_originated',y);return;}var z=q.MercurySourceType;if(u.source==z.EMAIL||u.source==z.TITAN_EMAIL_REPLY){y={thread_id:w,message_id:x,source:u.source};r.log('message_source_not_allowed',y);return;}var aa=l.getUserID(u.author);if(!aa){r.log('message_bad_author',{thread_id:w,message_id:x,user:aa});return;}if(u.action_type!=q.MercuryActionType.USER_GENERATED_MESSAGE){y={thread_id:w,message_id:x,type:u.action_type};r.log('message_non_user_generated',y);return;}if(t.is_canonical_user&&!g.notifiesUserMessages()){r.log('message_jabber',{thread_id:w,message_id:x});s(w,true);return;}if(i.shouldSuppressMessages()){r.log('message_desktop',{thread_id:w,message_id:x});return;}if(!t.is_canonical_group&&t.folder!=q.MessagingTag.INBOX){r.log('message_folder',{thread_id:w,message_id:x,folder:t.folder});return;}p.get(aa,function(ba){if(!o.allows(aa)){r.log('message_privacy',{thread_id:w,message_id:x,user:aa});return;}if(!t.is_canonical_group)if(ba.type!='friend'){r.log('message_non_friend',{thread_id:w,message_id:x,user:aa});return;}v();});}};});
__d("ChatTabViewSelector",["Arbiter","copyProperties","CSS","DataStore","DOM","Menu","MercuryThreadInformer","MercuryThreads","NubController","MercuryThreadMetadataRenderer","Toggler","ChatTabTemplates"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('copyProperties'),i=b('CSS'),j=b('DataStore'),k=b('DOM'),l=b('Menu'),m=b('MercuryThreadInformer'),n=b('MercuryThreads'),o=b('NubController'),p=b('MercuryThreadMetadataRenderer'),q=b('Toggler'),r=c('ChatTabTemplates');function s(t){var u=r[':fb:chat:tab:selector'].build(),v=u.getRoot(),w=u.getNode('menu'),x=k.find(w,'.uiMenuInner'),y={},z=new o().init(v);i.hide(v);k.insertBefore(t,v);function aa(da){var ea=0;for(var fa in y){var ga=y[fa],ha=n.getThreadMetaNow(fa),ia=ga.getNode('unreadCount'),ja=(ha&&ha.unread_count)||0;ea+=ja;if(ja>9)ja='+';i.conditionClass(ia,'invisible_elem',!ja);k.setContent(ia,ja);}var ka=u.getNode('numMessages');i.conditionShow(ka,ea);k.setContent(ka,ea);}this.setTabData=function(da){y={};if(da.length<1){i.hide(v);return;}i.show(v);k.empty(x);da.forEach(function(ea){var fa=r[':fb:chat:tab:selector:item'].build();y[ea.id]=fa;var ga=fa.getNode('content');p.renderAndSeparatedParticipantList(ea.id,ga);k.prependContent(x,fa.getRoot());j.set(fa.getRoot(),'threadID',ea.id);});z.flyoutContentChanged();k.setContent(u.getNode('numTabs'),da.length);aa();};function ba(event,da){if(da.menu!=w)return;var ea=j.get(da.item,'threadID');s.inform('selected',ea);q.hide(v);}function ca(event,da){l.register(w);}l.subscribe('select',ba.bind(this));q.listen('show',v,function(){g.inform('layer_shown',{type:'ChatTabSelector'});ca();});q.listen('hide',v,function(){g.inform('layer_hidden',{type:'ChatTabSelector'});});m.subscribe('threads-updated',aa);}h(s,new g());e.exports=s;});
__d("ChatTabController",["ChatTabPresence","Arbiter","AsyncRequest","ChatActivity","ChatConfig","ChatNewMessageHandler","ChatTabMessagesView","ChatTabModel","ChatTabPolicy","ChatTabView","ChatTabViewSelector","ChatTitleBarBlinker","Dialog","JSLogger","MercuryMessages","MercuryParticipants","MercuryServerRequests","MercuryThreadInformer","MercuryThreads","MercuryUnseenState","Style","UserAgent","VideoCallCore"],function(a,b,c,d,e,f){b('ChatTabPresence');var g=b('Arbiter'),h=b('AsyncRequest'),i=b('ChatActivity'),j=b('ChatConfig'),k=b('ChatNewMessageHandler'),l=b('ChatTabMessagesView'),m=b('ChatTabModel'),n=b('ChatTabPolicy'),o=b('ChatTabView'),p=b('ChatTabViewSelector'),q=b('ChatTitleBarBlinker'),r=b('Dialog'),s=b('JSLogger'),t=b('MercuryMessages'),u=b('MercuryParticipants'),v=b('MercuryServerRequests'),w=b('MercuryThreadInformer'),x=b('MercuryThreads'),y=b('MercuryUnseenState'),z=b('Style'),aa=b('UserAgent'),ba=b('VideoCallCore'),ca=j.get('tab_auto_close_timeout')||7200000,da=s.create('tab_controller');function ea(pa){x.changeThreadReadStatus(pa,true);fa(pa);}function fa(pa){y.markThreadSeen(pa);}function ga(){var pa=m.get();pa.tabs.forEach(function(qa){var ra=o.get(qa.id);if(qa.raised&&ra&&ra.isVisible())ea(qa.id);});}function ha(){var pa=m.get();pa.tabs.forEach(function(qa){fa(qa.id);});}function ia(pa,qa,ra){var sa=m.get().tabs;pa+=qa?1:-1;while(pa>=0&&pa<sa.length){var ta=sa[pa],ua=o.get(ta.id);if(ua&&ua.isVisible()&&(!ra||ta.raised)){ua.focus();return true;}pa+=qa?1:-1;}return false;}function ja(pa){function qa(ta){var ua=pa.shouldPromoteOnRaise(ta);g.inform("chat/promote-tab",ta);if(ua){m.raiseAndPromoteTab(ta,true);}else m.raiseTab(ta,true);var va=o.get(ta);va&&va.focus();}function ra(ta,ua){var va=m.get(),wa=pa.getMaxTabsToShow(),xa=m.indexOf(ta);m.closeTabAndDemote(ta,wa-2,ua);return xa;}p.subscribe('selected',function(ta,ua){qa(ua);});g.subscribe('chat/open-tab',function(ta,ua){qa(ua.thread_id);});g.subscribe('page_transition',function(ta,ua){m.closeFragileTabs();});v.subscribe('model-update-completed',ha);o.subscribe('focused',function(event,ta){ea(ta);});i.subscribe('idle',function(ta,ua){if(ua>ca){var va=m.get().tabs;va.forEach(function(wa){var xa=wa.id;x.getThreadMeta(xa,function(ya){if(!ya.unread_count){da.log('autoclose_idle_seen',{thread_id:xa,idleness:ua});m.closeTab(xa,'autoclose_idle_seen');}});});}});o.subscribe('nub-activated',function(ta,ua){qa(ua);});o.subscribe('lower-activated',function(ta,ua){m.lowerTab(ua);var va=o.get(ua);va&&va.focus();ea(ua);});function sa(ta,ua){ba.showOutgoingCallDialog(ua.userID,ua.clickSource);m.lowerTab(ua.threadID);}o.subscribe('video-call-clicked',sa);l.subscribe('video-call-clicked',sa);o.subscribe('closed-tab',function(ta,ua){da.log('close_view',{thread_id:ua});ra(ua,'close_view');ea(ua);return false;});o.subscribe('thread-deleted',function(ta,ua){da.log('close_thread_deleted',{thread_id:ua});ra(ua,'close_thread_deleted');return false;});o.subscribe('unsubscribed',function(ta,ua){da.log('close_view_unsubscribed',{thread_id:ua});ra(ua,'close_view_unsubscribed');return false;});o.subscribe('esc-pressed',function(ta,ua){da.log('close_esc',{thread_id:ua});var va=ra(ua,'close_esc');ia(va-1,true,true)||ia(va,false,true);});w.subscribe('messages-received',function(ta,ua){for(var va in ua){var wa=ua[va];for(var xa=0;xa<wa.length;xa++){var ya=wa[xa];if(ya.author!=u.user){if(!ya.is_unread){da.log('message_already_read',{action_id:ya.action_id,thread_id:ya.thread_id});continue;}x.getThreadMeta(va,function(za){n.messageIsAllowed(za,ya,function(){k.newMessage(va,ya);});});}}}});w.subscribe('thread-read-changed',function(ta,ua){for(var va in ua)if(!ua[va].mark_as_read){da.log('autoclose_marked_unread',{thread_id:va});m.closeTab(va,'autoclose_marked_unread');}});o.subscribe('tab-pressed',function(ta,ua){return !ia(m.indexOf(ua.id),ua.shiftPressed);});g.subscribe(s.DUMP_EVENT,function(ta,ua){ua.chat_controller={auto_close_timeout:ca};});}if(aa.firefox()){var ka=function(){return z.get(document.body,'overflowX')+' '+z.get(document.body,'overflowY');},la=ka(),ma=function(){var pa=ka();if(pa!==la){la=pa;g.inform('overflow-applied-to-body');}};if('MutationObserver' in window){var na=new MutationObserver(ma),oa={attributes:true,attributeFilter:['class','style']};na.observe(document.documentElement,oa);}else document.documentElement.addEventListener('DOMAttrModified',function(event){if(event.getTarget()===document.documentElement&&(event.attrName==='class'||event.attrName==='style'))ma();},false);}e.exports=ja;});
__d("ChatTabViewCoordinator",["Arbiter","ChatConfig","ChatTabModel","ChatTabView","ChatTabViewSelector","CSS","VideoCallCore"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('ChatConfig'),i=b('ChatTabModel'),j=b('ChatTabView'),k=b('ChatTabViewSelector'),l=b('CSS'),m=b('VideoCallCore');function n(o,p){var q=new k(o),r={},s=false;function t(){var y=i.get(),z={};y.tabs.forEach(function(ba){z[ba.id]=1;});for(var aa in r)if(!z[aa]){r[aa].destroy();delete(r[aa]);}u(y);v(y);}function u(y){var z=null;y.tabs.forEach(function(aa){var ba=aa.id,ca=false;if(!r[ba]){r[ba]=new j(ba,aa.server_id);ca=true;}if(ca||!r[ba].nextTabIs(z))if(z){r[ba].insertBefore(z);}else r[ba].appendTo(o);z=r[ba];});}function v(y){var z=p.getTabsToShow(y),aa=[],ba=false;y.tabs.forEach(function(ca){if(!z[ca.id]){r[ca.id].setVisibleState(false,ca.raised);aa.push(ca);}});y.tabs.forEach(function(ca){if(z[ca.id]){r[ca.id].setVisibleState(true,ca.raised);ba|=ca.raised;}});q.setTabData(aa);x(ba);}function w(y){for(var z=0,aa=y.tabs.length;z<aa;z++){var ba=y.tabs[z];if(ba.raised)if(ba.id===y.promoted||z<p.getMaxTabsToShow()-1)return true;}return false;}function x(y){if(!y&&s){g.inform('layer_hidden',{type:'ChatTab'});s=false;}else if(y&&!s){g.inform('layer_shown',{type:'ChatTab'});s=true;}}if(m.isSupported())l.addClass(o,'videoCallEnabled');p.subscribe('tabs-changed',t);t();}e.exports=n;});
__d("TabsViewport",["event-extensions","ArbiterMixin","ChatConfig","ChatTabModel","Class","CSS","Dock","DOM","Parent","Vector","areObjectsEqual","copyProperties"],function(a,b,c,d,e,f){b('event-extensions');var g=b('ArbiterMixin'),h=b('ChatConfig'),i=b('ChatTabModel'),j=b('Class'),k=b('CSS'),l=b('Dock'),m=b('DOM'),n=b('Parent'),o=b('Vector'),p=b('areObjectsEqual'),q=b('copyProperties');function r(s){this._root=s;Event.listen(window,'resize',this._recalculateWidth.bind(this));l.subscribe('resize',this._recalculateWidth.bind(this));i.subscribe('chat/tabs-changed',this._recalculateTabs.shield(this,true));this._recalculateWidth();this._initialized=true;}q(r.prototype,g,{_root:null,_initialized:false,_availableWidth:0,_maxShown:1,_viewState:null,_recalculateWidth:function(){var s=r._getAvailableDockWidth(this._root),t=Math.max(1,Math.floor(s/264)),u=t!=this._maxShown;if(!this._viewState||u||s<=this._viewState.usedWidth||s>this._viewState.widthToShowNext){this._availableWidth=s;this._maxShown=t;this._viewState=null;this._recalculateTabs(u);}},_onTabsChanged:function(){if(this._initialized){this.inform('tabs-changed');this.inform('max-to-show-changed',this._maxShown);this.inform('max-to-show-change-completed');}},_recalculateTabs:function(s){var t=r._getTabsToShow(i.get(),this._availableWidth);if(s||!p(this._viewState,t)){this._viewState=t;this._onTabsChanged();}},getMaxTabsToShow:function(){return this._maxShown;},checkWidth:function(){this._recalculateWidth();},getTabsToShow:function(){return JSON.parse(JSON.stringify(this._viewState.tabsToShow));},shouldPromoteOnRaise:function(s){if(!this._viewState.tabsToShow[s])return true;if(this._viewState.nextToHide!=s)return false;var t=i.getTab(s),u=t&&t.raised;return !u&&(this._availableWidth-this._viewState.usedWidth<100);}});q(r,{_getAvailableDockWidth:function(s){var t=o.getViewportDimensions().x;t-=230;t-=50;var u=n.byClass(s,'fbDock'),v=o.getElementDimensions(u),w=n.byClass(s,'fbDockChat'),x=o.getElementDimensions(w),y=v.x-x.x;t-=y;t-=20;return Math.max(t,0);},_getTabsToShow:function(s,t){var u=164,v=264;t=Math.max(t,v+1);function w(la){return la.raised?v:u;}var x=JSON.parse(JSON.stringify(s.tabs)),y=-1,z=null;if(s.promoted)x.forEach(function(la,ma){if(la.id===s.promoted){y=ma;z=la;}});var aa=0,ba=0,ca=!z;x.forEach(function(la,ma){var na=w(la);la.leftmostOffset=aa+v;aa+=na;if(la.leftmostOffset<t)ba++;ca|=ma==y;la.alreadyPlacedPromoted=ca;});function da(la,ma,na){var oa={};for(var pa=0;pa<ma;pa++){var qa=la[pa];if(!qa.alreadyPlacedPromoted&&pa==ma-1){oa[na]=true;}else oa[qa.id]=true;}return oa;}var ea=da(x,ba,s.promoted),fa=da(x,ba-1,s.promoted),ga=null;for(var ha in ea)if(!fa[ha])ga=ha;var ia=x[ba-1],ja=ia?ia.leftmostOffset:0,ka=Infinity;if(ba<x.length)ka=x[ba].leftmostOffset;return {nextToHide:ga,tabsToShow:ea,usedWidth:ja,widthToShowNext:ka};}});e.exports=r;});
__d("MercuryChannelHandler",["Arbiter","ChannelConstants","copyProperties","Env","MessagingReliabilityLogger","MercuryParticipants","PresenceUtil","MercuryServerRequests","MercuryThreadInformer","MercuryThreads","MercuryConstants","MercuryConfig"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('ChannelConstants'),i=b('copyProperties'),j=b('Env'),k=b('MessagingReliabilityLogger'),l=b('MercuryParticipants'),m=b('PresenceUtil'),n=b('MercuryServerRequests'),o=b('MercuryThreadInformer'),p=b('MercuryThreads'),q=c('MercuryConstants'),r=c('MercuryConfig');function s(ia,ja){var ka=ja.obj.to;p.getCanonicalThreadToGroup(ka,function(la){var ma=la.thread_id;n.getServerThreadID(ma,function(na){var oa=ba(ka,ja.obj.from,ja.obj.msg.time),pa=ja.obj.from!=j.user,qa=Date.format(r['24h_times']?'H:i':'g:ia',Math.floor(ja.obj.msg.time/1000)),ra=new Date(ja.obj.msg.time).toLocaleDateString(),sa={obj:{message:{action_id:null,body:ja.obj.msg.text,is_unread:pa,mid:oa,mercury_author_id:'fbid:'+ja.obj.from,mercury_author_email:null,mercury_coordinates:null,mercury_spoof_warning:false,mercury_source:q.MercurySourceType.CHAT_WEB,mercury_source_tags:[q.MercuryMessageSourceTags.CHAT],sender_fbid:ja.obj.from,tid:na,timestamp:ja.obj.msg.time,timestamp_absolute:ra,timestamp_relative:qa,threading_id:ja.obj.sync_id},folder:'group_chat'}};t(h.getArbiterType('messaging'),sa);});});}function t(ia,ja){if(ia!=h.getArbiterType('messaging')||!ja.obj||!ja.obj.message){k.addEntry('channel_receive','invalid_data');return;}var ka=ja.obj.message,la={author:ka.mercury_author_id,author_email:ka.mercury_author_email,body:ka.body,subject:ka.subject,has_attachment:ka.has_attachment,attachments:ka.attachments,html_body:ka.html_body,thread_id:ka.tid,message_id:ka.mid,coordinates:ka.mercury_coordinates,spoof_warning:ka.mercury_spoof_warning,source:ka.mercury_source,source_tags:ka.mercury_source_tags,threading_id:ka.threading_id,timestamp:ka.timestamp,timestamp_absolute:ka.timestamp_absolute,timestamp_relative:ka.timestamp_relative,action_type:q.MercuryActionType.USER_GENERATED_MESSAGE,is_unread:ka.is_unread,action_id:ka.action_id,is_forward:false,forward_count:ka.forward_count||ka.forward,forward_message_ids:ka.forward_msg_ids,location_text:ka.location_text,folder:ja.obj.folder},ma=[i({},la)];ma=ma.concat(ka.forward_actions||[]);var na=q.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE;n.handleUpdateWaitForThread({actions:ma,payload_source:na},ka.tid);if(!ka.is_unread&&ka.mercury_author_id===l.user){var oa={};oa[ka.tid]=ja.obj.folder;u(h.getArbiterType('messaging'),{obj:{event:q.MessagingEventTypes.READ,tids:[ka.tid],folder_info:oa}});}k.addEntry('channel_receive','success',[la.thread_id,la.message_id,m.getSessionID()]);}function u(ia,ja){if(ia!=h.getArbiterType('messaging')||!ja.obj||!ja.obj.tids)return;var ka=[],la=ja.obj.event==q.MessagingEventTypes.READ;ja.obj.tids.forEach(function(ma){ka.push({action_type:q.MercuryActionType.CHANGE_READ_STATUS,action_id:null,thread_id:ma,mark_as_read:la,timestamp:ja.obj.timestamp||0,folder:ja.obj.folder_info[ma]});});n.handleUpdate({actions:ka,payload_source:q.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE});}function v(ia,ja){if(ia!=h.getArbiterType('messaging')||!ja.obj||!ja.obj.tids)return;var ka=[];ja.obj.tids.forEach(function(la){ka.push({action_type:q.MercuryActionType.DELETE_THREAD,action_id:null,thread_id:la});});n.handleUpdate({actions:ka,payload_source:q.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE});}function w(ia,ja){if(ia!=h.getArbiterType('messaging')||!ja.obj||!ja.obj.tids||!ja.obj.mids)return;var ka=ja.obj.tids[0],la={action_type:q.MercuryActionType.DELETE_MESSAGES,action_id:null,thread_id:ka,message_ids:ja.obj.mids};n.handleUpdate({actions:[la],threads:[ja.obj.updated_thread],payload_source:q.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE});}function x(ia,ja){if(ia!=h.getArbiterType('messaging')||!ja.obj||!ja.obj.folder)return;var ka={action_type:q.MercuryGlobalActionType.MARK_ALL_READ,action_id:ja.obj.action_id,folder:ja.obj.folder};n.handleUpdate({global_actions:[ka]});}function y(ia,ja){if(ia!=h.getArbiterType('messaging')||!ja.obj.tids)return;var ka=q.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE;ja.obj.tids.forEach(function(la){var ma={action_type:q.MercuryActionType.CHANGE_ARCHIVED_STATUS,action_id:null,thread_id:la,archived:ja.obj.state};n.handleUpdateWaitForThread({actions:[i({},ma)],payload_source:ka},la);});}function z(ia,ja){if(ia!=h.getArbiterType('messaging')||!ja.obj.tids)return;var ka=q.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE,la;ja.obj.tids.forEach(function(ma){if(ja.obj.event==q.MessagingEventTypes.TAG){la=ja.obj.tag;}else la=ja.obj.marked_as_spam?q.MessagingTag.SPAM:q.MessagingTag.INBOX;var na={action_type:q.MercuryActionType.CHANGE_FOLDER,action_id:null,thread_id:ma,new_folder:la};n.handleUpdateWaitForThread({actions:[i({},na)],payload_source:ka},ma);});}function aa(ia,ja){if(ia!=h.getArbiterType('messaging')||!ja.obj.tag)return;switch(ja.obj.tag){case q.MessagingTag.ACTION_ARCHIVED:y(ia,ja);break;case q.MessagingTag.INBOX:case q.MessagingTag.OTHER:z(ia,ja);break;}}function ba(ia,ja,ka){return ia+':'+ja+':'+ka;}function ca(ia,ja){if(ia!=h.getArbiterType('inbox')||!ja.obj||!ja.obj.seen_timestamp)return;n.handleUpdate({message_counts:[{seen_timestamp:ja.obj.seen_timestamp,folder:q.MessagingTag.INBOX}],unseen_thread_ids:[{thread_ids:[],folder:q.MessagingTag.INBOX}],payload_source:q.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE});}function da(ia,ja){if(ia!=h.getArbiterType('mercury')||!ja.obj)return;o.synchronizeInforms(function(){var ka=ja.obj,la=[];(ka.actions||[]).forEach(function(ma){var na=q.MercuryActionType.USER_GENERATED_MESSAGE;if(ma.action_type==q.MercuryActionType.LOG_MESSAGE){var oa=q.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE;n.handleUpdateWaitForThread({actions:[i({},ma)],payload_source:oa},ma.thread_id);}else if(ma.action_type!=na)la.push(ma);});ka.actions=la;ka.payload_source=q.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE;n.handleUpdate(ka);});}function ea(ia,ja){n.handleRoger(ja.obj);}function fa(ia,ja){switch(ja.obj.event){case q.MessagingEventTypes.DELIVER:t(ia,ja);break;case q.MessagingEventTypes.READ:case q.MessagingEventTypes.UNREAD:u(ia,ja);break;case q.MessagingEventTypes.READ_ALL:x(ia,ja);break;case q.MessagingEventTypes.DELETE:v(ia,ja);break;case q.MessagingEventTypes.DELETE_MESSAGES:w(ia,ja);break;case q.MessagingEventTypes.TAG:aa(ia,ja);break;case q.MessagingEventTypes.REPORT_SPAM:z(ia,ja);break;case q.MessagingEventTypes.READ_RECEIPT:ea(ia,ja);break;}}var ga=[],ha={turnOn:function(){if(!ga.length){var ia={mercury:da,messaging:fa,group_msg:s,inbox:ca};for(var ja in ia)ga.push(g.subscribe(h.getArbiterType(ja),ia[ja]));}},turnOff:function(){if(ga.length){ga.forEach(g.unsubscribe);ga=[];}}};ha.turnOn();e.exports=ha;});
__d("MercuryJewelCountControl",["Arbiter","DOM","JewelX","MercuryUnseenState","MercuryServerRequests","MercuryThreadInformer","copyProperties","tx","MercuryConstants"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=c('MercuryConstants'),i=b('DOM'),j=b('JewelX'),k=b('MercuryUnseenState'),l=b('MercuryServerRequests'),m=b('MercuryThreadInformer'),n=b('copyProperties'),o=b('tx'),p,q,r,s=function(u){if(u||r.isOpen())k.markAsSeen();},t=function(u,v){p=u;q=i.find(p,'#mercurymessagesCountValue');r=v;this.render();l.subscribe('model-update-completed',function(w,x){s(false);});m.subscribe('unseen-updated',this.render.bind(this));r.subscribe('marked-seen',s.shield(this,true));};n(t.prototype,{render:function(){var u='';if(k.exceedsMaxCount()){u=o._("{count}+",{count:h.MercuryThreadlistConstants.MAX_UNSEEN_COUNT});}else u=k.getUnseenCount().toString();g.inform('jewel/count-updated',{jewel:'mercurymessages',count:u},g.BEHAVIOR_STATE);}});e.exports=t;});
__d("MercuryFilters",["array-extensions","MercuryConstants"],function(a,b,c,d,e,f){b('array-extensions');var g=c('MercuryConstants'),h=[g.MessagingTag.UNREAD],i={ALL:'all',getSupportedFilters:function(){return h.concat();},isSupportedFilter:function(j){return h.contains(j);}};e.exports=i;});
__d("MercuryOrderedThreadlist",["JSLogger","MercuryFolders","MercuryFilters","MercuryServerRequests","RangedCallbackManager","MercuryThreadInformer","MercuryThreads","MercuryConstants"],function(a,b,c,d,e,f){var g=b('JSLogger'),h=b('MercuryFolders'),i=b('MercuryFilters'),j=b('MercuryServerRequests'),k=b('RangedCallbackManager'),l=b('MercuryThreadInformer'),m=b('MercuryThreads'),n=c('MercuryConstants'),o=g.create('ordered_threadlist_model'),p=i.getSupportedFilters().concat([i.ALL]),q=h.getSupportedFolders(),r={};q.forEach(function(ca){r[ca]={};p.forEach(function(da){r[ca][da]=new k(function(ea){return m.getThreadMetaNow(ea).timestamp;},function(ea,fa){return fa-ea;},j.canLinkExternally.bind(j));});});function s(ca,da,ea){var fa=[],ga=false,ha=(ca||[]).filter(function(oa){var pa=oa.filter||i.ALL;return (oa.folder==da||(!oa.folder&&da==n.MessagingTag.INBOX))&&pa==ea;}),ia=r[da][ea].getAllResources(),ja;ha.forEach(function(oa){fa=fa.concat(oa.thread_ids);var pa=oa.end-oa.start;if(oa.thread_ids.length<pa)ga=true;if(!ja||oa.end>ja)ja=oa.end;});w(fa,da,ea);if(ga){r[da][ea].setReachedEndOfArray();}else{var ka=r[da][ea].getCurrentArraySize();if(ja&&ka<ja){var la={},ma=ia.concat(fa),na=ma.filter(function(oa){var pa=la[oa];la[oa]=true;return pa;});if(na.length){o.warn('duplicate_threads',{folder:da,expected_final_size:ja,actual_final_size:ka,duplicate_thread_ids:na});j.fetchThreadlistInfo(ja,na.length,da,ea==i.ALL?null:ea);}}}}function t(ca){q.forEach(function(da){p.forEach(function(ea){s(ca,da,ea);});});}function u(ca){var da={};q.forEach(function(ea){da[ea]={};p.forEach(function(fa){da[ea][fa]={to_add:[],to_remove:[],to_remove_if_last_after_add:{}};});});ca.forEach(function(ea){if(ea.is_forward)return;var fa=ea.thread_id,ga=x(fa),ha=y(fa);function ia(){ha.forEach(function(ka){da[ga][ka].to_add.push(fa);if(!r[ga][ka].hasReachedEndOfArray()&&!r[ga][ka].hasResource(fa))da[ga][ka].to_remove_if_last_after_add[fa]=true;});}function ja(ka){if(p.contains(ka))if(ha.contains(ka)){da[ga][ka].to_add.push(fa);}else da[ga][ka].to_remove.push(fa);}if(!ga){if(ea.action_type===n.MercuryActionType.CHANGE_FOLDER||ea.action_type===n.MercuryActionType.CHANGE_ARCHIVED_STATUS)q.forEach(function(ka){if(ka!==ga)p.forEach(function(la){r[ka][la].removeResources([fa]);});});return;}switch(ea.action_type){case n.MercuryActionType.DELETE_THREAD:ha.forEach(function(ka){da[ga][ka].to_remove.push(fa);});break;case n.MercuryActionType.CHANGE_ARCHIVED_STATUS:case n.MercuryActionType.CHANGE_FOLDER:ia();break;case n.MercuryActionType.CHANGE_READ_STATUS:ja(n.MessagingTag.UNREAD);break;case n.MercuryActionType.USER_GENERATED_MESSAGE:case n.MercuryActionType.LOG_MESSAGE:ha.forEach(function(ka){if(z(fa,ga,ka))da[ga][ka].to_add.push(fa);});break;}});q.forEach(function(ea){p.forEach(function(fa){var ga=r[ea][fa];w(da[ea][fa].to_add,ea,fa);for(var ha=ga.getCurrentArraySize()-1;ha>=0;ha--){var ia=ga.getResourceAtIndex(ha);if(!da[ea][fa].to_remove_if_last_after_add[ia])break;da[ea][fa].to_remove.push(ia);}ga.removeResources(da[ea][fa].to_remove);});});}function v(ca){var da={};q.forEach(function(ea){da[ea]={};p.forEach(function(fa){da[ea][fa]=[];});});ca.forEach(function(ea){var fa=x(ea.thread_id),ga=y(ea.thread_id);ga.forEach(function(ha){if(fa&&z(ea.thread_id,fa,ha))da[fa][ha].push(ea.thread_id);});});q.forEach(function(ea){p.forEach(function(fa){if(da[ea][fa].length>0)w(da[ea][fa],ea,fa);});});}function w(ca,da,ea){ea=ea||i.ALL;r[da][ea].addResources(ca);q.forEach(function(fa){if(fa!=da)r[fa][ea].removeResources(ca);});}function x(ca){var da=m.getThreadMetaNow(ca),ea=null;if(!da){ea='No thread metadata';}else if(!da.folder)ea='No thread folder';if(ea){var fa={error:ea,tid:ca};o.warn('no_thread_folder',fa);return null;}var ga=da.folder;if(da.is_archived)ga=n.MessagingTag.ACTION_ARCHIVED;if(r[ga]){return ga;}else return null;}function y(ca){var da=m.getThreadMetaNow(ca),ea=[i.ALL];if(!da){var fa={error:'no_thread_metadata',tid:ca};o.warn('no_thread_metadata',fa);return [];}if(da.unread_count)ea.push(n.MessagingTag.UNREAD);return ea;}function z(ca,da,ea){var fa=m.getThreadMetaNow(ca);return fa&&fa.timestamp&&x(ca)==da&&y(ca).contains(ea);}var aa={getThreadlist:function(ca,da,ea,fa,ga){return this.getFilteredThreadlist(ca,da,ea,i.ALL,fa,ga);},getFilteredThreadlist:function(ca,da,ea,fa,ga,ha){var ia=r[ea][fa],ja=ia.executeOrEnqueue(ca,da,ga,ha),ka=ia.getUnavailableResources(ja);if(ka.length){if(ia.getCurrentArraySize()<ca){var la={start:ca,limit:da,filter:fa,resources_size:ia.getCurrentArraySize()};o.warn('range_with_gap',la);}j.fetchThreadlistInfo(ia.getCurrentArraySize(),ka.length,ea,fa==i.ALL?null:fa);}return ja;},getThreadlistUntilTimestamp:function(ca,da,ea){ea=ea||i.ALL;return r[da][ea].getElementsUntil(ca);},unsubscribe:function(ca,da,ea){ea=ea||i.ALL;r[da][ea].unsubscribe(ca);}};function ba(ca){switch(ca.payload_source){case n.MercuryPayloadSource.CLIENT_CHANGE_ARCHIVED_STATUS:case n.MercuryPayloadSource.CLIENT_CHANGE_READ_STATUS:case n.MercuryPayloadSource.CLIENT_CHANGE_FOLDER:case n.MercuryPayloadSource.CLIENT_CHANNEL_MESSAGE:case n.MercuryPayloadSource.CLIENT_DELETE_MESSAGES:case n.MercuryPayloadSource.CLIENT_DELETE_THREAD:case n.MercuryPayloadSource.CLIENT_SEND_MESSAGE:case n.MercuryPayloadSource.SERVER_SEND_MESSAGE:case n.MercuryPayloadSource.SERVER_CONFIRM_MESSAGES:case n.MercuryPayloadSource.SERVER_FETCH_THREADLIST_INFO:case n.MercuryPayloadSource.SERVER_THREAD_SYNC:return true;case n.MercuryPayloadSource.SERVER_INITIAL_DATA:return ca.ordered_threadlists;default:return false;}}j.subscribe('update-threadlist',function(ca,da){if(!ba(da))return;var ea=da.ordered_threadlists;if(ea&&ea.length){t(ea);}else{var fa=(da.actions||[]).filter(function(ga){return ga.thread_id;});v(da.threads||[]);u(fa);}l.updatedThreadlist();});e.exports=aa;});
__d("WebMessengerStateConstants",[],function(a,b,c,d,e,f){var g={SELECTION:'selection',COMPOSE:'compose',SEARCH_THREAD:'search-thread',SEARCH_THREAD_SELECTION:'search-thread-selection',SEARCH_SNIPPET:'search-snippet',SEARCH_SNIPPET_SELECTION:'search-snippet-selection',STATE_CHANGE_EVENT:'state-changed',COMPOSE_SHOWING_CONTEXT:'showing_context',COMPOSE_SHOWING_TYPEAHEAD_RESULTS:'showing_typeahead_results',COMPOSE_SHOWING_ALL_PEOPLE:'showing_all_people',COMPOSE_SHOWING_ALL_THREADS:'showing_all_threads',MESSAGE_ACTION:{DELETE:'delete',FORWARD:'forward'}};e.exports=g;});
__d("WebMessengerOldToNewPermalink",["WebMessengerPermalinkConstants","WebMessengerStateConstants"],function(a,b,c,d,e,f){var g=b('WebMessengerPermalinkConstants'),h=b('WebMessengerStateConstants');function i(n){if(!j(n))return n;k(n);m(n);l(n);return n;}function j(n){var o=n.getQueryData();if(o.sk)switch(o.sk){case 'inbox':n.setPath(g.BASE_PATH);n.removeQueryData('sk');break;case 'other':n.setPath(g.OTHER_PATH);n.removeQueryData('sk');break;default:return false;}return true;}function k(n){var o=n.getQueryData();switch(o.action){case 'read':if(!o.tid){n.addQueryData({action:h.SELECTION});}else n.removeQueryData('action');break;}}function l(n){var o=n.getQueryData();if(o.tid){n.setPath(g.getURIPathForThreadID(o.tid,n.getPath()));n.removeQueryData('tid');}}function m(n){var o=n.getQueryData();if(!n.getPath().match(g.SEARCH_POSTFIX_PATH)){var p=o.query;if(o.query){var q=/\bis:(archived|spam)\b(.*)/,r=q.exec(o.query);if(r){switch(r[1]){case 'archived':n.setPath(g.ARCHIVED_PATH);break;case 'spam':n.setPath(g.SPAM_PATH);break;}var s=o.query.substr(0,o.query.length-r[0].length),t=r[2];p=(s.trim()+' '+t.trim()).trim();}}if(o.thread_query){n.setPath(n.getPath()+g.SEARCH_POSTFIX_PATH);n.setQueryData({query:o.thread_query});}else if(p){n.setPath(n.getPath()+g.SEARCH_POSTFIX_PATH);n.addQueryData({query:p});}else n.removeQueryData('query');}}e.exports=i;});
__d("WebMessengerPermalinks",["goURI","MercuryIDs","MercuryParticipants","MercuryFilters","WebMessengerOldToNewPermalink","WebMessengerPermalinkConstants","MercuryServerRequests","WebMessengerStateConstants","MercuryThreads","Token","URI","MercuryConstants","WebMessengerConstants"],function(a,b,c,d,e,f){var g=b('goURI'),h=b('MercuryIDs'),i=b('MercuryParticipants'),j=b('MercuryFilters'),k=b('WebMessengerOldToNewPermalink'),l=b('WebMessengerPermalinkConstants'),m=b('MercuryServerRequests'),n=b('WebMessengerStateConstants'),o=b('MercuryThreads'),p=b('Token'),q=b('URI'),r=c('MercuryConstants'),s=c('WebMessengerConstants'),t={getDefaultURI:function(){var da=new q().setSubdomain('www');da.setPath(l.BASE_PATH);return da;},goNextURI:function(da,ea){if(aa(da,ea)){var fa=t.getURI(da,ea);g(fa);return true;}return false;},getURI:function(da,ea){var fa=t.getDefaultURI();switch(ea.folder){case r.MessagingTag.OTHER:fa.setPath(l.OTHER_PATH);break;case r.MessagingTag.ACTION_ARCHIVED:fa.setPath(l.ARCHIVED_PATH);break;case r.MessagingTag.SPAM:fa.setPath(l.SPAM_PATH);break;}if(ea.filter&&(ea.filter!=j.ALL))fa.addQueryData({filter:ea.filter});var ga;switch(da){case n.COMPOSE:fa.setPath(fa.getPath()+l.COMPOSE_POSTFIX_PATH);ga=false;break;case n.SEARCH_SNIPPET:case n.SEARCH_THREAD_SELECTION:case n.SEARCH_SNIPPET_SELECTION:ga=false;fa.setPath(fa.getPath()+l.SEARCH_POSTFIX_PATH);break;case n.SEARCH_THREAD:ga=true;fa.setPath(fa.getPath()+l.SEARCH_POSTFIX_PATH);break;case n.SELECTION:ga=!ea.thread_id;break;default:ga=true;break;}if(da){if(ga)fa.addQueryData({action:da});if(ea.thread_id){var ha=m.getServerThreadIDNow(ea.thread_id),ia=ha?ha:ea.thread_id;fa.setPath(l.getURIPathForThreadID(ia,fa.getPath()));}if(ea.query)fa.addQueryData({query:ea.query});if(ea.message_id)fa.addQueryData({mid:ea.message_id});if(ea.reuse_composer)fa.addQueryData({rc:true});}return fa;},processURI:function(da){da=k(da);if(!t.isWebMessengerURI(da))return false;var ea=ba(da);if(!ea)return ca(da);var fa={data:{folder:y(da),filter:z(da)},redirect:false,state:ea};if(da.getQueryData().rc)fa.data.reuse_composer=true;switch(ea){case n.SELECTION:return x(da,fa);case n.COMPOSE:return u(da,fa);case n.SEARCH_SNIPPET:return w(da,fa);case n.SEARCH_THREAD:case n.SEARCH_THREAD_SELECTION:fa=w(da,fa);return x(da,fa);case n.SEARCH_SNIPPET_SELECTION:fa=w(da,fa);fa=x(da,fa);return v(da,fa);}fa.redirect=true;return fa;},isWebMessengerURI:function(da){return (/^(\/messages|\/webmessenger)/).test(da.getPath());}};function u(da,ea){var fa=da.getQueryData().to;if(fa){var ga=i.getNow('fbid:'+fa);if(ga){var ha={uid:fa,text:ga.name,type:s.USER_TYPE};ea.data.new_tokens=[new p(ha)];}}ea.data.start=true;ea.data.contents_state=n.COMPOSE_SHOWING_CONTEXT;return ea;}function v(da,ea){var fa=da.getQueryData().mid;if(fa){ea.data.message_id=fa;}else ea.redirect=true;return ea;}function w(da,ea){var fa=da.getQueryData().query;ea.data.query=fa;return ea;}function x(da,ea){var fa=l.getThreadIDFromURI(da);if(fa){var ga=h.isValid(fa)?fa:m.getClientThreadIDNow(fa);if(ga){ea.data.thread_id=ga;}else ea.redirect=true;}else{var ha=l.getCanonicalUserID(da.getPath());if(ha){var ia=o.getCanonicalThreadToUser(ha);if(ia){ea.data.thread_id=ia.thread_id;}else ea.redirect=true;}}return ea;}function y(da){var ea=da.getPath();if(ea.match('^'+l.ARCHIVED_PATH))return r.MessagingTag.ACTION_ARCHIVED;if(ea.match('^'+l.OTHER_PATH))return r.MessagingTag.OTHER;if(ea.match('^'+l.SPAM_PATH))return r.MessagingTag.SPAM;return r.MessagingTag.INBOX;}function z(da){return da.getQueryData().filter||j.ALL;}function aa(da,ea){if(da==n.COMPOSE&&!ea.start)return false;if(ea.bug_reporting_enabled)return false;if(!da||!ea)return true;return !ea.message_action;}function ba(da){var ea=da.getQueryData();if(ea.action)return ea.action;var fa=da.getPath();if(fa.match(l.BASE_PATH+'(/[^/]+)?'+l.COMPOSE_POSTFIX_PATH))return n.COMPOSE;var ga=fa.match(l.BASE_PATH+'(/[^/]+)?'+l.SEARCH_POSTFIX_PATH+'(/[^/]+)?');if(ga){var ha=ga[2];if(ha&&ha.match(l.TID_POSTFIX_PARTIAL_PATH)){if(ea.mid){return n.SEARCH_SNIPPET_SELECTION;}else return n.SEARCH_THREAD_SELECTION;}else return n.SEARCH_SNIPPET;}if(fa.match(l.TID_POSTFIX_PARTIAL_PATH)||l.getCanonicalUserID(fa))return n.SELECTION;}function ca(da){var ea={redirect:false,state:n.COMPOSE,data:{contents_state:n.COMPOSE_SHOWING_CONTEXT,folder:y(da),filter:z(da),start:true}};return ea;}e.exports=t;});
__d("MercuryJewelThreadlistControl",["event-extensions","ArbiterMixin","CSS","DOM","MercuryOrderedThreadlist","Parent","MercuryThreadInformer","MercuryThreadMetadataRenderer","MercuryThreads","WebMessengerPermalinks","WebMessengerStateConstants","copyProperties","tx","MercuryConfig","MercuryConstants","MercuryJewelTemplates"],function(a,b,c,d,e,f){b('event-extensions');var g=b('ArbiterMixin'),h=b('CSS'),i=b('DOM'),j=b('MercuryOrderedThreadlist'),k=b('Parent'),l=b('MercuryThreadInformer'),m=b('MercuryThreadMetadataRenderer'),n=b('MercuryThreads'),o=b('WebMessengerPermalinks'),p=b('WebMessengerStateConstants'),q=b('copyProperties'),r=b('tx'),s=c('MercuryConfig'),t=c('MercuryConstants'),u=c('MercuryJewelTemplates');function v(w){this._rootElement=w;this._contentElement=i.find(this._rootElement,'.jewelContent');this._loadingElement=i.find(this._rootElement,'.jewelLoading');l.subscribe('threadlist-updated',this.render.bind(this));this.render();}q(v,{EVENT_THREADS_LOADED:'threads-loaded',EVENT_THREADS_RENDERED:'threads-rendered'});q(v.prototype,g);q(v.prototype,{render:function(){i.empty(this._contentElement);h.show(this._loadingElement);var w=i.create('div');i.appendContent(this._contentElement,w);j.getThreadlist(t.MercuryThreadlistConstants.RECENT_THREAD_OFFSET,t.MercuryThreadlistConstants.JEWEL_THREAD_COUNT,t.MessagingTag.INBOX,this.renderThreads.bind(this,w),true);},renderThreads:function(w,x){this.inform(v.EVENT_THREADS_LOADED);if(x.length){x.forEach(function(y){var z=u[':fb:mercury:jewel:threadlist-row'].build();m.renderCoreThreadlist(y,z,this.renderSingleThread.bind(this),{show_unread_count:true});i.appendContent(w,z.getRoot());}.bind(this));}else i.setContent(this._rootElement,this.renderEmptyThreadlist());h.hide(this._loadingElement);this.inform(v.EVENT_THREADS_RENDERED);},renderSingleThread:function(w,x){if(x.unread_count>0)h.addClass(w.getRoot(),'jewelItemNew');if(s.MessagesMercuryIntegrationGK){w.getNode('link').setAttribute('href',o.getURI(p.SELECTION,{thread_id:x.thread_id}).toString());}else m.renderTitanLink(x.thread_id,w.getNode('link'));Event.listen(w.getRoot(),'mouseover',function(event){var y=w.getRoot();if(!k.byClass(y,'notifNegativeBase'))h.addClass(y,'selected');});Event.listen(w.getRoot(),'mouseout',function(event){h.removeClass(w.getRoot(),'selected');});},renderEmptyThreadlist:function(){return i.create('li',{className:'empty'},"Aucun message");}});e.exports=v;});
__d("MercuryJewel",["MercuryChannelHandler","MercuryJewelCountControl","DOM","MercuryJewelThreadlistControl","MercuryServerRequests","userAction"],function(a,b,c,d,e,f){b('MercuryChannelHandler');var g=b('MercuryJewelCountControl'),h=b('DOM'),i=b('MercuryJewelThreadlistControl'),j=b('MercuryServerRequests'),k=b('userAction'),l=false;function m(q,r,s,t){j.handleUpdate(t);var u=new g(r,s),v=h.find(q,'#MercuryJewelThreadList');if(s.getRoot()&&s.isOpen()){n.call(this,v);}else s.subscribe('opened',n.bind(this,v));}e.exports=m;function n(q){this._ua=k('click').set_namespace('messages').set_ua_id('jewel');this._listenForLoad=this._listenForRender=true;if(!l){var r=new i(q);r.subscribe(i.EVENT_THREADS_LOADED,o.bind(this));r.subscribe(i.EVENT_THREADS_RENDERED,p.bind(this));l=true;}}function o(){if(this._listenForLoad){this._ua.add_event('loaded');this._listenForLoad=false;}}function p(){if(this._listenForRender){this._ua.add_event('rendered');this._listenForRender=false;}}});
__d("TitanLeftNav",["CounterDisplay","MessagingEvents"],function(a,b,c,d,e,f){var g=b('CounterDisplay'),h=b('MessagingEvents'),i={initialize:function(){h.subscribe('count/other_unseen',function(j,k){g.setCount('other_unseen',k);});}};e.exports=i;});
__d("MercuryStateCheck",["Arbiter","copyProperties","ChannelConnection","ChannelConstants","MercuryFolders","MercuryServerRequests","URI","MercuryConstants"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('copyProperties'),i=b('ChannelConnection'),j=b('ChannelConstants'),k=b('MercuryFolders'),l=b('MercuryServerRequests'),m=b('URI'),n=c('MercuryConstants'),o=h(new g(),{initialize:function(){g.subscribe(j.ON_INVALID_HISTORY,p);i.subscribe(i.CONNECTED,function(q,r){if(!r.init)p();});}});function p(){var q;if(m.getRequestURI().getPath().search(/webmessenger/)!==-1){q=k.getSupportedFolders();}else q=[n.MessagingTag.INBOX];l.fetchMissedMessages(q);}o.initialize();e.exports=o;});
__d("LiveMessageReceiver",["Arbiter","AsyncRequest","ChannelConstants","copyProperties"],function(a,b,c,d,e,f){var g=b('Arbiter'),h=b('AsyncRequest'),i=b('ChannelConstants'),j=b('copyProperties');function k(l){this.eventName=l;this.subs=null;this.handler=bagofholding;this.shutdownHandler=null;this.registered=false;this.appId=1;}j(k,{getAppMessageType:function(l,m){return 'live_message/'+l+':'+m;},route:function(l){var m=function(n){var o=k.getAppMessageType(l.app_id,l.event_name);g.inform(o,n,g.BEHAVIOR_PERSISTENT);};if(l.hasCapture){new h().setHandler(function(n){m(n.getPayload());}).setAllowCrossPageTransition(true).handleResponse(l.response);}else m(l.response);}});j(k.prototype,{setAppId:function(l){this.appId=l;return this;},setHandler:function(l){this.handler=l;this._dirty();return this;},setRestartHandler:bagofholding,setShutdownHandler:function(l){this.shutdownHandler=l.shield();this._dirty();return this;},_dirty:function(){if(this.registered){this.unregister();this.register();}},register:function(){var l=function(n,o){return this.handler(o);}.bind(this),m=k.getAppMessageType(this.appId,this.eventName);this.subs={};this.subs.main=g.subscribe(m,l);if(this.shutdownHandler)this.subs.shut=g.subscribe(i.ON_SHUTDOWN,this.shutdownHandler);this.registered=true;return this;},unregister:function(){if(!this.subs)return this;for(var l in this.subs)if(this.subs[l])this.subs[l].unsubscribe();this.subs=null;this.registered=false;return this;}});e.exports=k;});
function PresenceIndicator(){}copyProperties(PresenceIndicator.prototype,{init:function(a,b,c){this._id=a;this._firstname=b;this._tooltip=c;this._image=DOM.scry(this._tooltip,'i')[0];this._previousAvail=null;this._jslog=JSLogger.create('presence_indicator');requireLazy(['ChatVisibility'],function(e){this._jslog.log('vis_init',e.isOnline());this._chatVisibility=e;this._updateVisibility();}.bind(this));this._subscriptions=[Arbiter.subscribe([AvailableListConstants.ON_AVAILABILITY_CHANGED],this._updateAvailability.bind(this)),Arbiter.subscribe(['chat/visibility-changed'],this._updateVisibility.bind(this))];this._updateAvailability.bind(this).defer();var d=Event.listen(this._tooltip,'click',function(){requireLazy(['AvailableList'],function(e){if(this._previousAvail!=AvailableListConstants.OFFLINE)Chat.openTab(this._id);}.bind(this));}.bind(this));onleaveRegister(function(){d.remove();while(this._subscriptions.length)Arbiter.unsubscribe(this._subscriptions.pop());}.bind(this));},_updateAvailability:function(){requireLazy(['AvailableList','ChatConfig'],function(a,b){if(!a.isReady())return;var c,d,e=a.get(this._id);if(e===this._previousAvail)return;this._previousAvail=e;switch(e){case AvailableListConstants.OFFLINE:c=tx._("{name} est hors ligne.",{name:this._firstname});d='offline';break;case AvailableListConstants.IDLE:c=tx._("{name} est inactif.",{name:this._firstname});d='idle';break;case AvailableListConstants.ACTIVE:c=tx._("{name} est en ligne.",{name:this._firstname});d='online';break;case AvailableListConstants.MOBILE:c=tx._("{name} est disponible sur son mobile.",{name:this._firstname});d='mobile';break;default:throw new Error('Invalid availability');}TooltipLink.setTooltipText(this._tooltip,c);CSS.setClass(this._image,d);}.bind(this));},_updateVisibility:function(){if(this._chatVisibility.isOnline()){CSS.show(this._tooltip);}else CSS.hide(this._tooltip);}});
__d("legacy:livemessage",["LiveMessageReceiver"],function(a,b,c,d){a.LiveMessageReceiver=b('LiveMessageReceiver');},3);